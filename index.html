<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Bora de Van - Gest√£o üöê</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- HTML2Canvas (Para Prints) -->
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <style>
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        html, body {
            margin: 0; padding: 0;
            width: 100vw; height: 100dvh;
            background-color: #0f172a; color: #e2e8f0;
            font-family: ui-sans-serif, system-ui, -apple-system, sans-serif;
            position: fixed; inset: 0; overflow: hidden;
        }

        #root { width: 100%; height: 100%; display: flex; flex-direction: column; }

        /* Loader */
        #loader { position: fixed; inset: 0; z-index: 9999; background: #0f172a; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #334155; border-top: 4px solid #f59e0b; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- PREMIUM ANIMATIONS & EASING --- */
        :root {
            --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
            --ease-in-out-circ: cubic-bezier(0.85, 0, 0.15, 1);
            --ease-elastic: cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        /* 1. Page Transitions */
        @keyframes pageEnter {
            from { opacity: 0; transform: translateY(15px) scale(0.98); filter: blur(4px); }
            to { opacity: 1; transform: translateY(0) scale(1); filter: blur(0); }
        }
        .page-transition { animation: pageEnter 0.6s var(--ease-out-expo) forwards; will-change: transform, opacity, filter; }

        /* 2. Staggered Entrance (Cascata) */
        @keyframes slideUpFade {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .stagger-in { opacity: 0; animation: slideUpFade 0.7s var(--ease-out-expo) forwards; }
        .d-1 { animation-delay: 50ms; }
        .d-2 { animation-delay: 100ms; }
        .d-3 { animation-delay: 150ms; }
        .d-4 { animation-delay: 200ms; }
        .d-5 { animation-delay: 250ms; }

        /* 3. Card & Button Interaction */
        .premium-card {
            transition: transform 0.4s var(--ease-out-expo), box-shadow 0.4s var(--ease-out-expo), border-color 0.3s;
        }
        .premium-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 15px 30px -10px rgba(0,0,0,0.5);
            border-color: rgba(255,255,255,0.2);
        }
        .premium-click:active { transform: scale(0.96); }

        /* 4. Login Intro Animation */
        .intro-layer {
            position: fixed; inset: 0; z-index: 9998;
            background: #d97706; /* Amber-600 */
            clip-path: circle(0% at 50% 100%);
            pointer-events: none;
            transition: clip-path 0.8s var(--ease-in-out-circ);
        }
        .intro-layer.active { clip-path: circle(150% at 50% 100%); }
        
        .logo-bounce { animation: bounceLogo 1s var(--ease-elastic) infinite; }
        @keyframes bounceLogo { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.1); } }

        /* --- TOUR STYLES --- */
        .tour-overlay {
            position: fixed; inset: 0; z-index: 10000;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(3px);
            transition: all 0.5s ease;
        }
        /* Classe para limpar o fundo nos passos seguintes */
        .tour-overlay.clear {
            background: transparent;
            backdrop-filter: none;
            pointer-events: none; /* Permite interagir? N√£o, o spotlight bloqueia. Mantemos visual limpo. */
        }

        .tour-spotlight {
            position: absolute;
            border-radius: 12px;
            /* O box-shadow gigante cria o efeito de escurecer o resto da tela sem precisar do overlay */
            box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.75), 0 0 30px rgba(245, 158, 11, 0.5); 
            border: 2px solid #f59e0b;
            transition: all 0.4s var(--ease-out-expo);
            pointer-events: none;
            z-index: 10001;
        }
        .tour-tooltip {
            position: absolute;
            z-index: 10002;
            width: 320px;
            max-width: 85vw; /* CORRE√á√ÉO: Garante que n√£o vaze no mobile */
            pointer-events: auto;
            transition: all 0.4s var(--ease-out-expo);
        }
        /* Seta do Tooltip */
        .tour-arrow { position: absolute; width: 16px; height: 16px; background: #1e293b; transform: rotate(45deg); z-index: -1; }

        /* AI Animations */
        .bg-ai { background: linear-gradient(135deg, #f59e0b, #d97706, #b45309); background-size: 200% 200%; animation: ai-pulse 3s ease infinite; }
        @keyframes ai-pulse { 0% {background-position: 0% 50%} 50% {background-position: 100% 50%} 100% {background-position: 0% 50%} }

        .listening { 
            background-color: #ef4444 !important; 
            color: white !important; 
            border-color: #ef4444 !important; 
            animation: pulse-mic 1.5s infinite;
        }
        @keyframes pulse-mic { 
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); transform: scale(1); } 
            70% { box-shadow: 0 0 0 15px rgba(239, 68, 68, 0); transform: scale(1.05); } 
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); transform: scale(1); } 
        }

        /* Drag & Drop Styles */
        .draggable-item { cursor: grab; touch-action: pan-y; user-select: none; -webkit-touch-callout: none; transition: transform 0.2s, box-shadow 0.2s; }
        .draggable-item:active { cursor: grabbing; z-index: 50; transform: scale(1.02); }
        .dragging { opacity: 0.5; border: 2px dashed #f59e0b; }
        .drag-over { border-top: 2px solid #f59e0b; }

        input, select, textarea { font-size: 16px !important; }
        .scroll-y { overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .scroll-y::-webkit-scrollbar { width: 4px; }
        .scroll-y::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        
        .anim-fade { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .expand-content { transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out; overflow: hidden; }
        
        .login-bg { background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%); }
        
        /* Utility classes for printing logic */
        .show-on-print { display: none; } 
    </style>
</head>
<body>
    <div id="loader"><div class="spinner"></div><p style="margin-top:20px; color:#94a3b8; font-size:12px; font-weight:bold;">Bora de Van üöê</p></div>
    <div id="root"></div>

    <script>setTimeout(()=>{const l=document.getElementById('loader');if(l)l.remove()},4000);</script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        /* --- FIREBASE CONFIG --- */
        const firebaseConfig = {
            apiKey: "AIzaSyConFpC-5IPOO8dxrYggy8JusWtC7BsgWs",
            authDomain: "lotacao-97c37.firebaseapp.com",
            projectId: "lotacao-97c37",
            databaseURL: "https://lotacao-97c37-default-rtdb.firebaseio.com",
            storageBucket: "lotacao-97c37.appspot.com",
            messagingSenderId: "782139851070",
            appId: "1:782139851070:web:dd2f3327c33a45f443ec6f"
        };

        let db = null;
        let auth = null;
        try {
            if (typeof firebase !== 'undefined') {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                db = firebase.database(); 
                auth = firebase.auth();
            } else {
                console.error("SDK do Firebase n√£o encontrado.");
            }
        } catch(e) { 
            console.error("Erro na Inicializa√ß√£o do Firebase:", e.message || e); 
        }

        /* --- GEMINI API --- */
        const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";

        const callGemini = async (prompt, apiKey) => {
            if (!apiKey) throw new Error("Chave API Gemini n√£o configurada!");
            const response = await fetch(`${GEMINI_API_URL}?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error?.message || "Erro na API Gemini");
            }
            const data = await response.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text || "";
        };

        /* --- DADOS --- */
        const BAIRROS = [ "Forte / Canto do Forte", "Tude Bastos / Chico de Paula", "Boqueirao", "Guilhermina", "Avia√ß√£o", "Tupi", "Tupiry", "Ocian", "Gloria", "Vila Antartica", "Vila Sonia", "Quietude", "Mirim", "Anhanguera", "Maracana", "Ribeiropolis", "Esmeralda", "Samambaia", "Melvi", "Cai√ßara", "Imperador", "Real", "Princesa", "Florida", "Cidade das Crian√ßas", "Solemar" ];
        // Fallback colors caso o tema n√£o tenha paleta
        const COLORS = ['#f59e0b', '#d97706', '#b45309', '#ef4444', '#10b981', '#3b82f6', '#8b5cf6'];
        
        const INITIAL_SP_LIST = [
            {vaga: '02', name: 'Cristian'}, {vaga: '20', name: 'Aquiles'}, {vaga: '06', name: 'Bruno'},
            {vaga: '21', name: 'Campos'}, {vaga: '01', name: 'Max'},
            {vaga: '17', name: 'Max'}, 
            {vaga: '10', name: 'Salles'}, {vaga: '11', name: 'Reginaldo'}, {vaga: '03', name: 'Chaiene'},
            {vaga: '22', name: 'Wash'}, {vaga: '08', name: 'Cristina'}, {vaga: '16', name: 'Sergio'},
            {vaga: '09', name: 'Wash'}, {vaga: '13', name: 'Rafael'}, {vaga: '12', name: 'Del'},
            {vaga: '07', name: 'Martins'}, {vaga: '04', name: 'Martins'}, {vaga: '14', name: 'Wash'},
            {vaga: '15', name: 'Julia'}, {vaga: '19', name: 'Jos√©'}, {vaga: '18', name: 'Domingos'},
            {vaga: '05', name: 'Fernando'}, {vaga: '00', name: 'Topic'}
        ];

        /* --- USERS (Database Simulado) --- */
        const USERS_DB = {
            'Admin': { pass: 'Admin', role: 'admin' },
            'Operador': { pass: 'Operador', role: 'operador' },
            'Breno': { pass: '15744751', role: 'admin' }
        };

        /* --- TEMAS --- */
        const THEMES = {
            default: { 
                name: 'Padr√£o', 
                bg: 'bg-slate-950', 
                card: 'bg-slate-800 border-slate-700', 
                text: 'text-slate-200', 
                primary: 'bg-amber-600 text-white', 
                accent: 'text-amber-400', 
                border: 'border-slate-700', 
                radius: 'rounded-xl',
                palette: ['#f59e0b', '#d97706', '#fbbf24', '#b45309', '#78350f'] 
            },
            wood: { 
                name: 'R√∫stico (Madeira)', 
                bg: 'bg-[#1a110e]', 
                card: 'bg-[#2e1f18] border-[#4a342a]', 
                text: 'text-[#e6dace]', 
                primary: 'bg-[#8b5a2b] text-white', 
                accent: 'text-[#d4a373]', 
                border: 'border-[#4a342a]', 
                radius: 'rounded-xl', 
                palette: ['#8b5a2b', '#d4a373', '#6f4e37', '#a67b5b', '#c19a6b'] 
            },
            dark: { 
                name: 'Escuro Profundo', 
                bg: 'bg-black', 
                card: 'bg-zinc-900 border-zinc-800', 
                text: 'text-zinc-200', 
                primary: 'bg-orange-600 text-white', 
                accent: 'text-orange-400', 
                border: 'border-zinc-800', 
                radius: 'rounded-xl',
                palette: ['#ea580c', '#f97316', '#fdba74', '#c2410c', '#7c2d12'] 
            },
            cyberpunk: { 
                name: 'Cyberpunk', 
                bg: 'bg-[#0b0c15]', 
                card: 'bg-[#181926] border-[#2f3146]', 
                text: 'text-[#e0def4]', 
                primary: 'bg-[#eb6f92] text-white', 
                accent: 'text-[#f6c177]', 
                border: 'border-[#2f3146]', 
                radius: 'rounded-none',
                palette: ['#eb6f92', '#f6c177', '#9ccfd8', '#c4a7e7', '#31748f'] 
            },
            dracula: { 
                name: 'Dr√°cula', 
                bg: 'bg-[#282a36]', 
                card: 'bg-[#44475a] border-[#6272a4]', 
                text: 'text-[#f8f8f2]', 
                primary: 'bg-[#bd93f9] text-[#282a36]', 
                accent: 'text-[#50fa7b]', 
                border: 'border-[#6272a4]', 
                radius: 'rounded-xl',
                palette: ['#bd93f9', '#50fa7b', '#ff79c6', '#8be9fd', '#ffb86c'] 
            },
            solar: { 
                name: 'Solar (Claro)', 
                bg: 'bg-[#fdf6e3]', 
                card: 'bg-[#eee8d5] border-[#d2b589]', 
                text: 'text-[#657b83]', 
                primary: 'bg-[#b58900] text-white', 
                accent: 'text-[#cb4b16]', 
                border: 'border-[#d2b589]', 
                radius: 'rounded-2xl',
                palette: ['#b58900', '#cb4b16', '#dc322f', '#d33682', '#6c71c4'] 
            },
            midnight: { 
                name: 'Meia-noite', 
                bg: 'bg-indigo-950', 
                card: 'bg-indigo-900 border-indigo-800', 
                text: 'text-indigo-100', 
                primary: 'bg-cyan-600 text-white', 
                accent: 'text-cyan-300', 
                border: 'border-indigo-700', 
                radius: 'rounded-xl',
                palette: ['#0891b2', '#06b6d4', '#67e8f9', '#4338ca', '#3730a3'] 
            },
            forest: { 
                name: 'Floresta', 
                bg: 'bg-green-950', 
                card: 'bg-green-900 border-green-800', 
                text: 'text-green-100', 
                primary: 'bg-emerald-600 text-white', 
                accent: 'text-emerald-400', 
                border: 'border-green-800', 
                radius: 'rounded-xl',
                palette: ['#059669', '#10b981', '#34d399', '#065f46', '#064e3b'] 
            },
        };

        /* --- ICONES --- */
        const Icon = ({ children, size=20, className="" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {children}
            </svg>
        );
        
        const Icons = {
            Menu: () => <Icon><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></Icon>,
            Home: () => <Icon><rect x="3" y="3" width="7" height="9" rx="1"/><rect x="14" y="3" width="7" height="5" rx="1"/><rect x="14" y="12" width="7" height="9" rx="1"/><rect x="3" y="16" width="7" height="5" rx="1"/></Icon>,
            Users: () => <Icon><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></Icon>,
            Car: () => <Icon><path d="M19 17h2c.6 0 1-.4 1-1v-3c0-.9-.7-1.7-1.5-1.9"/><path d="M2 12h17a1 1 0 0 0 .9-1.5l-2.4-3.2"/><path d="M2 12v6"/><circle cx="7" cy="18" r="2"/><circle cx="17" cy="18" r="2"/></Icon>,
            Van: () => <Icon><rect x="1" y="3" width="15" height="13" rx="2" ry="2"/><line x1="16" y1="8" x2="20" y2="8"/><path d="M16 8h4a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-6"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></Icon>,
            Map: () => <Icon><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="8" y1="2" x2="8" y2="18"/><line x1="16" y1="6" x2="16" y2="22"/></Icon>,
            Calendar: () => <Icon><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></Icon>,
            Settings: () => <Icon><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0 2.83l.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></Icon>,
            Plus: () => <Icon><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></Icon>,
            X: () => <Icon><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></Icon>,
            Trash: () => <Icon><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></Icon>,
            Copy: () => <Icon><rect width="14" height="14" x="8" y="8" rx="2" ry="2"/><path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"/></Icon>,
            Phone: () => <Icon><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></Icon>,
            Edit: () => <Icon><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></Icon>,
            Refresh: () => <Icon><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"/></Icon>,
            Check: () => <Icon><polyline points="20 6 9 17 4 12"/></Icon>,
            Back: () => <Icon><polyline points="9 14 4 9 9 4"/><path d="M20 20v-7a4 4 0 0 0-4-4H4"/></Icon>,
            Send: () => <Icon><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></Icon>,
            Zap: () => <Icon><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></Icon>,
            Download: () => <Icon><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></Icon>,
            Mic: () => <Icon><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></Icon>,
            Stop: () => <Icon><rect x="9" y="9" width="6" height="6"/></Icon>,
            Stars: () => <Icon><path d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"/></Icon>,
            ChevronLeft: () => <Icon><polyline points="15 18 9 12 15 6" /></Icon>,
            ChevronRight: () => <Icon><polyline points="9 18 15 12 9 6" /></Icon>,
            ChevronDown: () => <Icon><polyline points="6 9 12 15 18 9" /></Icon>,
            ChevronUp: () => <Icon><polyline points="18 15 12 9 6 15" /></Icon>,
            Search: () => <Icon><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></Icon>,
            Dollar: () => <Icon><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></Icon>,
            Clipboard: () => <Icon><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path><rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect></Icon>,
            Box: () => <Icon><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></Icon>,
            Repeat: () => <Icon><polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></Icon>,
            Lock: () => <Icon><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></Icon>,
            LogOut: () => <Icon><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></Icon>,
            Shield: () => <Icon><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></Icon>,
            List: () => <Icon><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></Icon>,
            CheckCircle: () => <Icon><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></Icon>,
            Edit3: () => <Icon><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></Icon>,
            ArrowUp: () => <Icon><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></Icon>,
            ArrowDown: () => <Icon><line x1="12" y1="5" x2="12" y2="19"></line><polyline points="19 12 12 19 5 12"></polyline></Icon>,
            Moon: () => <Icon><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></Icon>,
            Sun: () => <Icon><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></Icon>,
            Clock: () => <Icon><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></Icon>,
            Slash: () => <Icon><circle cx="12" cy="12" r="10"></circle><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line></Icon>,
            CalendarX: () => <Icon><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/><line x1="10" y1="14" x2="14" y2="18"/><line x1="14" y1="14" x2="10" y2="18"/></Icon>,
            Print: () => <Icon><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></Icon>,
            Message: () => <Icon><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></Icon>
        };

        /* --- HELPERS --- */
        const getTodayDate = () => {
            const d = new Date();
            const local = new Date(d.getTime() - (d.getTimezoneOffset() * 60000));
            return local.toISOString().split('T')[0];
        };

        const getOperationalDate = () => {
            const d = new Date();
            if (d.getHours() > 19 || (d.getHours() === 19 && d.getMinutes() >= 30)) {
                 d.setDate(d.getDate() + 1);
            }
            const local = new Date(d.getTime() - (d.getTimezoneOffset() * 60000));
            return local.toISOString().split('T')[0];
        };

        const formatDisplayDate = (d) => {
            if(!d) return '';
            const [y, m, day] = d.split('-');
            return `${day}/${m}/${y}`;
        };
        
        const dateAddDays = (dateStr, days) => {
            const d = new Date(dateStr + 'T00:00:00');
            d.setDate(d.getDate() + days);
            return d.toISOString().split('T')[0];
        };

        const formatTime = (t) => t; 

        const getBairroIdx = b => { const i=BAIRROS.indexOf(b); return i===-1?99:i; };

        const getAvatarUrl = (name) => {
            if(name && name.toLowerCase() === 'breno') {
                return `https://api.dicebear.com/7.x/avataaars/svg?seed=Robert`; 
            }
            return `https://api.dicebear.com/7.x/avataaars/svg?seed=${name}`;
        };

        const generateUniqueId = () => Date.now().toString(36) + Math.random().toString(36).substr(2);

        const addMinutes = (time, mins) => {
            if(!time) return '';
            // Prote√ß√£o: Se o hor√°rio j√° for um intervalo (ex: Madrugada), n√£o calcula
            if (time.includes('/')) return time;
            
            const parts = time.split(':');
            if (parts.length < 2) return time;

            const [h, m] = parts.map(Number);
            if (isNaN(h) || isNaN(m)) return time;

            const date = new Date();
            date.setHours(h);
            date.setMinutes(m + mins);
            return date.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit', hour12: false});
        }

        const calculateTimeSlot = (t) => { 
            if(!t) return '-'; 
            
            // CORRE√á√ÉO: Tratamento para hor√°rios de madrugada (ex: "4:00/4:45")
            // Se tiver barra, apenas substitui por h√≠fen para ficar bonito, sem recalcular
            if (t.includes('/')) {
                return t.replace('/', ' - ');
            }

            const endTime = addMinutes(t, 45);
            return `${t} - ${endTime}`; 
        };
        
        const generateWhatsappMessage = (tripId, passengers, driverName, time, date) => {
            if(!passengers?.length) return "";
            
            const [y, m, d] = date.split('-');
            const formattedDate = `${d}/${m}/${y}`;

            let msg = `*DADOS DA VIAGEM - ${formattedDate}*\n\n`;
            msg += `*C√≥digo:* ${tripId}\n`;
            msg += `*Hor√°rio:* ${time}\n`;
            msg += `*PASSAGEIRO(S):*\n\n`;

            const sorted = passengers.sort((a,b)=>getBairroIdx(a.neighborhood)-getBairroIdx(b.neighborhood));

            sorted.forEach((p, index) => {
                const endTime = addMinutes(p.time || time, 45);
                msg += `*Passageiro ${index + 1}:*\n`;
                msg += `‚Ä¢ Nome: ${p.name}\n`;
                msg += `‚Ä¢ Telefone: ${p.phone || 'Sem n√∫mero'}\n`;
                msg += `‚Ä¢ Endere√ßo: ${p.address || ''}\n`;
                msg += `‚Ä¢ Refer√™ncia: ${p.reference || ''}\n`;
                msg += `‚Ä¢ Bairro: ${p.neighborhood || ''}\n`;
                msg += `‚Ä¢ Qtd: ${p.passengerCount || 1} passageiro(s)\n`;
                msg += `‚Ä¢ Hor√°rio: ${p.time || time}/${endTime}\n`;
                msg += `‚Ä¢ Bagagens: ${p.luggageCount || 0} bagagens\n\n`;
            });

            msg += `_Enviado via Bora de Van Transportes_`;
            return msg;
        };

        const sendPaxWhatsapp = (p) => {
            if(!p.phone) return alert('Passageiro sem telefone.');
            const msg = encodeURIComponent(`Ol√° ${p.name}, sobre seu agendamento para ${formatDisplayDate(p.date)} √†s ${p.time}...`);
            window.open(`https://wa.me/55${p.phone.replace(/\D/g,'')}?text=${msg}`, '_blank');
        };

        const generateTripListText = (passengers, driverName, time) => {
            const sorted = passengers.sort((a,b)=>getBairroIdx(a.neighborhood)-getBairroIdx(b.neighborhood));
            return `VIAGEM ${time} - ${driverName}\n\n` + sorted.map(p=> `‚Ä¢ ${p.name} - ${p.neighborhood}\n  ${p.address} (${p.reference || ''})`).join('\n\n');
        };

        // NOVO COMPONENTE: Timer em Tempo Real para Viagens Tempor√°rias
        const TempTripTimer = ({ date, time }) => {
            const [timeLeft, setTimeLeft] = useState('');
            
            useEffect(() => {
                const tick = () => {
                    if (!date || !time) return;
                    const [y, mo, d] = date.split('-').map(Number);
                    const [h, mi] = time.split(':').map(Number);
                    // Cria data de in√≠cio baseada nos dados da viagem (que est√° +60min do slot real)
                    const tripStart = new Date(y, mo - 1, d, h, mi, 0);
                    
                    // AJUSTE: O timer deve expirar 15 minutos ANTES do hor√°rio visual da viagem
                    // Motivo: Viagem visual √© Slot+60min. Exclus√£o deve ser Slot+45min.
                    // Logo: (Slot+60) - 15 = Slot+45.
                    const expiration = new Date(tripStart.getTime() - 15 * 60000);
                    
                    const now = new Date();
                    const diff = expiration - now;
                    
                    if (diff <= 0) {
                        setTimeLeft('Expirado');
                    } else {
                        const m = Math.floor(diff / 60000);
                        const s = Math.floor((diff % 60000) / 1000);
                        setTimeLeft(`${m}m ${s}s restantes`);
                    }
                };
                tick(); // Atualiza imediatamente
                const int = setInterval(tick, 1000); // Atualiza a cada segundo
                return () => clearInterval(int);
            }, [date, time]);

            return <span>{timeLeft}</span>;
        };

        /* --- PRINT FUNCTION --- */
        const handlePrint = async (targetId, filename, title, options = {}) => {
            const element = document.getElementById(targetId);
            if (!element) return alert("Elemento n√£o encontrado para impress√£o.");

            const activeBtn = document.activeElement;
            const originalHTML = activeBtn ? activeBtn.innerHTML : '';
            if(activeBtn) {
                activeBtn.innerText = 'Gerando...';
                activeBtn.disabled = true;
            }

            try {
                let target = element;
                let clone = null;
                let wrapper = null;

                const itemCount = element.children.length;
                let columns = 1;

                if (options.forceCols) {
                    columns = options.forceCols;
                } else if (options.mode === 'confirmados') {
                    columns = itemCount > 12 ? 2 : 1;
                } else if (options.mode === 'lousa') {
                    columns = Math.ceil(itemCount / 12);
                    if (columns < 1) columns = 1;
                }

                wrapper = document.createElement('div');
                wrapper.style.position = 'fixed';
                wrapper.style.left = '-9999px';
                wrapper.style.top = '0';
                wrapper.style.backgroundColor = '#1e293b';
                wrapper.style.color = 'white';
                wrapper.style.padding = '40px'; 
                wrapper.style.zIndex = '99999';
                
                // DATA DO T√çTULO DO PRINT
                let dateStr = new Date().toLocaleDateString('pt-BR');
                if (options.date) {
                    const [y, m, d] = options.date.split('-');
                    dateStr = `${d}/${m}/${y}`;
                }

                const titleEl = document.createElement('h1');
                titleEl.innerText = `${title} - ${dateStr}`;
                titleEl.style.textAlign = 'center';
                titleEl.style.marginBottom = '25px';
                titleEl.style.fontSize = '32px'; 
                titleEl.style.fontWeight = 'bold';
                titleEl.style.color = '#fbbf24'; 
                titleEl.style.width = '100%';
                wrapper.appendChild(titleEl);

                clone = element.cloneNode(true);
                
                const toHide = clone.querySelectorAll('.hide-on-print');
                toHide.forEach(el => el.remove());

                const toShow = clone.querySelectorAll('.show-on-print');
                toShow.forEach(el => {
                    el.classList.remove('hidden');
                    el.style.display = 'block';
                });

                // --- CORRE√á√ÉO DE CORTE DE NOMES (TRUNCATE) ---
                // Removemos qualquer classe ou estilo que possa cortar o texto
                const truncatedElements = clone.querySelectorAll('.truncate');
                truncatedElements.forEach(el => {
                    el.classList.remove('truncate');
                    el.style.overflow = 'visible';
                    el.style.textOverflow = 'clip';
                    el.style.whiteSpace = 'nowrap'; // Mant√©m em uma linha, mas expande a largura
                    el.style.maxWidth = 'none';
                    el.style.width = 'auto';
                });

                const textElements = clone.querySelectorAll('.font-bold, .font-mono');
                textElements.forEach(el => {
                    const style = window.getComputedStyle(el);
                    const fontSize = parseFloat(style.fontSize);
                    if (fontSize) {
                        el.style.fontSize = `${fontSize * 1.25}px`; 
                    }
                    // Garante que o texto n√£o seja cortado verticalmente
                    el.style.lineHeight = '1.4';
                    el.style.overflow = 'visible';
                });

                // CORRE√á√ÉO DE LAYOUT PARA PRINT
                Array.from(clone.children).forEach(child => {
                    child.style.display = 'flex';
                    child.style.alignItems = 'center'; 
                    
                    // AJUSTE: Se for Madrugada, alinha √† esquerda. Se n√£o, mant√©m separado (space-between).
                    if (options.mode === 'madrugada') {
                        child.style.justifyContent = 'flex-start';
                        child.style.gap = '20px'; // Espa√ßo entre a vaga e o nome na madrugada
                    } else {
                        child.style.justifyContent = 'space-between';
                    }

                    child.style.padding = '10px 15px'; 
                    child.style.height = 'auto';
                    child.style.minHeight = '50px'; 
                    child.style.overflow = 'visible'; // Permite que conte√∫dos passem do limite se precisar
                    
                    // For√ßa alinhamento nos containers internos
                    const innerFlexs = child.querySelectorAll('div.flex, .flex');
                    innerFlexs.forEach(g => {
                        g.style.display = 'flex';
                        g.style.alignItems = 'center'; 
                        g.style.height = '100%';
                        g.style.overflow = 'visible';
                    });

                    // Corre√ß√£o espec√≠fica para o quadrado do n√∫mero da vaga
                    // AJUSTE: Procura tanto rounded quanto rounded-full (Tabela Geral) para garantir que pegue em todas
                    const vagaBox = child.querySelector('.font-mono.rounded') || child.querySelector('.font-mono.rounded-full');
                    
                    if (vagaBox) {
                        vagaBox.style.padding = '0'; 
                        vagaBox.style.display = 'flex';
                        vagaBox.style.alignItems = 'center';
                        vagaBox.style.justifyContent = 'center';
                        
                        // Aumenta o container para caber o n√∫mero maior
                        vagaBox.style.height = '40px'; 
                        vagaBox.style.width = '45px'; 
                        vagaBox.style.lineHeight = '1';
                        
                        // AJUSTE SOLICITADO: Fonte GRANDE e BOLD fixo para visualiza√ß√£o f√°cil
                        vagaBox.style.fontSize = '26px'; 
                        vagaBox.style.fontWeight = '900'; // Extra Bold
                        vagaBox.style.opacity = '1'; // Remove transpar√™ncia se houver

                        // 1. O QUADRADO FICA NO MESMO LUGAR
                        vagaBox.style.marginTop = '0px'; 
                        vagaBox.style.marginBottom = '0';

                        // 2. AJUSTE DO N√öMERO (TEXTO)
                        // Criamos um span interno para mover S√ì o n√∫mero
                        const originalText = vagaBox.textContent || vagaBox.innerText;
                        vagaBox.textContent = ''; 
                        
                        const textSpan = document.createElement('span');
                        textSpan.textContent = originalText;
                        textSpan.style.position = 'relative';
                        // Sobe 10px conforme solicitado (antes era 5px)
                        textSpan.style.top = '-10px'; 
                        
                        vagaBox.appendChild(textSpan);
                    }

                    // Corre√ß√£o para o Nome (evitar corte e alinhar risco)
                    const nameSpan = child.querySelector('span.font-bold');
                    if (nameSpan) {
                        nameSpan.style.display = 'inline-block'; 
                        nameSpan.style.lineHeight = '1.1'; 
                        nameSpan.style.verticalAlign = 'middle';
                        
                        // AJUSTE: Fonte Aumentada para 26px
                        nameSpan.style.fontSize = '26px';
                        
                        // AJUSTE: Sobe 10px (ficando em -15px para alinhar mais acima)
                        nameSpan.style.position = 'relative';
                        nameSpan.style.top = '-13px';
                        nameSpan.style.marginTop = '0px'; 
                        
                        nameSpan.style.overflow = 'visible'; 
                        
                        // --- CORRE√á√ÉO DEFINITIVA DO RISCADO ---
                        // Substitui o text-decoration nativo por uma linha f√≠sica (div)
                        if (nameSpan.classList.contains('line-through') || nameSpan.style.textDecoration.includes('line-through')) {
                            // Remove o riscado nativo bugado
                            nameSpan.style.textDecoration = 'none';
                            nameSpan.classList.remove('line-through');
                            
                            // Cria a linha manualmente
                            const strikeLine = document.createElement('div');
                            strikeLine.style.position = 'absolute';
                            strikeLine.style.left = '-2px';   // Um pouco mais largo que o texto
                            strikeLine.style.right = '-2px';
                            
                            // AJUSTE FINO: Mant√©m relativo ao centro do pai (+12px)
                            // Como o pai subiu para -13px, a linha sobe junto visualmente
                            strikeLine.style.top = 'calc(50% + 12px)';     
                            
                            strikeLine.style.height = '3px';  // Espessura do risco
                            strikeLine.style.backgroundColor = '#f87171'; // Cor vermelha (red-400) para garantir visibilidade
                            strikeLine.style.borderRadius = '2px';
                            strikeLine.style.zIndex = '10';
                            
                            // Adiciona a linha dentro do nome
                            nameSpan.appendChild(strikeLine);
                            
                            // For√ßa opacidade visual de "item desativado"
                            nameSpan.style.opacity = '0.7';
                        }
                    }

                    // AJUSTE: Corre√ß√£o para o Hor√°rio (Time) seguindo o mesmo padr√£o do Nome
                    const timeSpan = child.querySelector('span.font-mono.text-lg') || child.querySelector('.show-on-print span');
                    if (timeSpan) {
                        timeSpan.style.display = 'inline-block';
                        timeSpan.style.lineHeight = '1.1';
                        timeSpan.style.verticalAlign = 'middle';
                        
                        // AJUSTE: Fonte Aumentada para 26px
                        timeSpan.style.fontSize = '26px';

                        // AJUSTE: Sobe 10px (ficando em -15px)
                        timeSpan.style.position = 'relative';
                        timeSpan.style.top = '-13px';
                        timeSpan.style.marginTop = '0px'; 
                        
                        timeSpan.style.overflow = 'visible';

                        // Se estiver riscado, aplicamos a linha manual
                        if (timeSpan.classList.contains('line-through') || timeSpan.style.textDecoration.includes('line-through')) {
                            timeSpan.style.textDecoration = 'none';
                            timeSpan.classList.remove('line-through');
                            
                            const strikeLine = document.createElement('div');
                            strikeLine.style.position = 'absolute';
                            strikeLine.style.left = '-2px';
                            strikeLine.style.right = '-2px';
                            
                            // Mant√©m relativo (+12px)
                            strikeLine.style.top = 'calc(50% + 12px)';     
                            
                            strikeLine.style.height = '3px';
                            strikeLine.style.backgroundColor = '#f87171'; // Vermelho
                            strikeLine.style.borderRadius = '2px';
                            strikeLine.style.zIndex = '10';
                            
                            timeSpan.appendChild(strikeLine);
                            
                            timeSpan.style.opacity = '0.7';
                        }
                    }
                });
                
                clone.style.width = '100%';
                clone.style.height = 'auto';
                clone.style.display = 'block';

                const contentContainer = document.createElement('div');
                if (columns > 1) {
                    const colWidth = 600; // Aumentei a largura da coluna para dar mais espa√ßo aos nomes
                    wrapper.style.width = `${columns * colWidth + 80}px`; 
                    contentContainer.style.columnCount = columns.toString();
                    contentContainer.style.columnGap = '40px';
                    
                    Array.from(clone.children).forEach(child => {
                        child.style.breakInside = 'avoid';
                        child.style.pageBreakInside = 'avoid';
                        child.style.marginBottom = '15px';
                    });
                } else {
                    // Largura din√¢mica baseada no conte√∫do, com m√≠nimo seguro
                    wrapper.style.width = `${Math.max(element.scrollWidth + 100, 700)}px`;
                }

                contentContainer.appendChild(clone);
                wrapper.appendChild(contentContainer);
                
                document.body.appendChild(wrapper);
                target = wrapper;

                const canvas = await html2canvas(target, {
                    backgroundColor: '#1e293b',
                    scale: 2,
                    useCORS: true,
                    windowWidth: target.scrollWidth,
                    width: target.scrollWidth,
                    height: target.scrollHeight + 50 // Garante altura extra no canvas
                });

                const link = document.createElement('a');
                link.download = `${filename}_${new Date().toLocaleDateString('pt-BR').replace(/\//g,'-')}.png`;
                link.href = canvas.toDataURL();
                link.click();

                if (wrapper) document.body.removeChild(wrapper);

            } catch (err) {
                console.error("Erro no print:", err);
                alert("Erro ao gerar imagem.");
            } finally {
                if(activeBtn) {
                    activeBtn.innerHTML = originalHTML;
                    activeBtn.disabled = false;
                }
            }
        };

        /* --- COMPONENTS --- */
        const Button = ({ onClick, children, theme, variant='primary', icon:I, disabled, className='', size='md', id='' }) => {
            const t = theme || THEMES.default;
            const sz = { sm:'px-3 py-2 text-sm', md:'px-4 py-3.5 text-base' };
            const v = {
                primary: `${t.primary} shadow-md premium-click`,
                secondary: `${t.card} ${t.text} premium-click border ${t.border}`,
                danger: `bg-rose-500/10 text-rose-500 border border-rose-500/20 active:bg-rose-500/20 premium-click`,
                success: `bg-emerald-500/10 text-emerald-500 border border-emerald-500/20 active:bg-emerald-500/20 premium-click`,
                ai: `bg-ai text-white shadow-lg premium-click border-none`
            };
            return <button id={id} onClick={onClick} disabled={disabled} className={`flex items-center justify-center gap-2 ${t.radius} font-bold transition-all disabled:opacity-50 disabled:cursor-not-allowed ${v[variant]} ${sz[size]} ${className}`}>{I && <I size={size==='sm'?16:20} />} {children}</button>;
        };

        const IconButton = ({ onClick, icon:I, variant='default', theme, disabled }) => {
             const t = theme || THEMES.default;
             const v = {
                 default: `${t.card} ${t.text} hover:opacity-80 border ${t.border}`,
                 danger: `bg-rose-500/10 text-rose-500 border border-rose-500/20`,
                 success: `bg-emerald-500/10 text-emerald-500 border border-emerald-500/20`
             }
             return <button onClick={onClick} disabled={disabled} className={`w-12 h-12 flex-shrink-0 flex items-center justify-center ${t.radius} transition-all active:scale-95 disabled:opacity-50 ${v[variant]}`}><I size={22}/></button>
        }

        const Input = ({ label, theme, ...props }) => {
            const t = theme || THEMES.default;
            return (
                <div className="flex flex-col gap-1 w-full">
                    <label className={`text-xs font-bold uppercase tracking-wider opacity-60 ml-1`}>{label}</label>
                    <input className={`bg-black/10 border border-white/10 ${t.text} ${t.radius} px-4 py-3.5 outline-none focus:border-current transition-colors w-full`} {...props} />
                </div>
            );
        };

        /* --- CHARTS (ANIMATED) --- */
        const DonutChart = ({ data, theme }) => {
            const t = theme || THEMES.default;
            // Usa a paleta do tema ou cai para as cores padr√£o
            const palette = t.palette || COLORS;
            
            const [mounted, setMounted] = useState(false);
            useEffect(() => { setTimeout(() => setMounted(true), 100); }, []);

            const total = data.reduce((a, b) => a + b.value, 0);
            let accumulatedCircumference = 0;
            const radius = 40;
            const circumference = 2 * Math.PI * radius; // aprox 251.32

            return (
                <div className="flex items-center gap-6">
                    <div className="relative w-32 h-32 flex-shrink-0">
                        <svg viewBox="0 0 100 100" className="transform -rotate-90 w-full h-full">
                            {data.map((d, i) => {
                                const percentage = total > 0 ? d.value / total : 0;
                                const strokeDasharray = `${percentage * circumference} ${circumference}`;
                                const strokeDashoffset = -accumulatedCircumference;
                                accumulatedCircumference += percentage * circumference;
                                
                                return (
                                    <circle
                                        key={i}
                                        cx="50"
                                        cy="50"
                                        r={radius}
                                        fill="transparent"
                                        stroke={palette[i % palette.length]}
                                        strokeWidth="15"
                                        strokeDasharray={strokeDasharray}
                                        strokeDashoffset={strokeDashoffset}
                                        style={{
                                            transition: 'stroke-dasharray 1s ease-out, stroke 0.5s ease',
                                            strokeDasharray: mounted ? strokeDasharray : `0 ${circumference}`
                                        }}
                                    />
                                );
                            })}
                        </svg>
                         <div className={`absolute inset-0 flex flex-col items-center justify-center pointer-events-none`}>
                            <span className="text-2xl font-bold">{total}</span>
                            <span className="text-[10px] opacity-60 uppercase">Total</span>
                        </div>
                    </div>
                    <div className="flex flex-col gap-2 w-full">
                        {data.map((d, i) => (
                            <div key={i} className="flex items-center gap-2 text-xs w-full">
                                <div className="w-3 h-3 rounded-full flex-shrink-0 transition-colors duration-500" style={{ backgroundColor: palette[i % palette.length] }} />
                                <span className="opacity-70 truncate flex-1">{d.label}</span>
                                <span className="font-bold">{d.value}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };
        
        const HorizontalBarChart = ({ data, theme }) => {
            const t = theme || THEMES.default;
            // Usa a paleta do tema ou cai para as cores padr√£o
            const palette = t.palette || COLORS;

            const [mounted, setMounted] = useState(false);
            useEffect(() => { setTimeout(() => setMounted(true), 100); }, []);

            const max = Math.max(...data.map(d=>d.value)) || 1;
            return (
                <div className="flex flex-col gap-3">
                    {data.map((d,i) => (
                        <div key={i} className="flex flex-col gap-1">
                            <div className="flex justify-between text-xs opacity-70">
                                <span>{d.label}</span>
                                <span className="font-bold">{d.value}</span>
                            </div>
                            <div className="h-2 w-full bg-black/20 rounded-full overflow-hidden">
                                <div 
                                    className="h-full rounded-full transition-all duration-1000 ease-out" 
                                    style={{
                                        width: mounted ? `${(d.value/max)*100}%` : '0%', 
                                        backgroundColor: palette[i % palette.length]
                                    }}
                                />
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        /* --- TOUR COMPONENT --- */
        const TourGuide = ({ steps, currentStep, onNext, onPrev, onClose, theme }) => {
            const [targetRect, setTargetRect] = useState(null);
            const [position, setPosition] = useState({ top: 0, left: 0 });
            const [arrowPos, setArrowPos] = useState({});
            const [isVisible, setIsVisible] = useState(false); // Evita mostrar antes de calcular
            
            // Effect para calcular posi√ß√£o do destaque
            useEffect(() => {
                const step = steps[currentStep];
                if (!step) return;
                
                setIsVisible(false); // Esconde ao mudar de passo

                // CORRE√á√ÉO 1: Se n√£o tem target (Card Inicial/Final), exibe na hora sem delay
                if (!step.target) {
                    setTargetRect(null);
                    const scrollTop = window.scrollY || document.documentElement.scrollTop;
                    // Centraliza na tela considerando o scroll atual
                    setPosition({ top: window.innerHeight/2 + scrollTop - 150, left: window.innerWidth/2 - 160 });
                    setArrowPos(null);
                    setIsVisible(true);
                    return;
                }

                const findTarget = (retryCount = 0) => {
                    const targets = document.querySelectorAll(step.target);
                    let target = null;
                    const isMobile = window.innerWidth < 768;

                    // Encontra o primeiro elemento que est√° vis√≠vel e tem tamanho
                    for (let t of targets) {
                        const r = t.getBoundingClientRect();
                        if (r.width > 0 && r.height > 0) {
                            target = t;
                            break;
                        }
                    }

                    // Verifica se o alvo existe e se est√° vis√≠vel (largura > 0)
                    if (target) {
                        const rect = target.getBoundingClientRect();
                        const scrollTop = window.scrollY || document.documentElement.scrollTop;
                        const scrollLeft = window.scrollX || document.documentElement.scrollLeft;

                        setTargetRect({
                            top: rect.top + scrollTop - 5,
                            left: rect.left + scrollLeft - 5,
                            width: rect.width + 10,
                            height: rect.height + 10
                        });

                        // L√≥gica de posicionamento Padr√£o
                        let tooltipTop = rect.bottom + scrollTop + 20;
                        let tooltipLeft = rect.left + scrollLeft + (rect.width / 2) - 160; 
                        let arrow = { top: -8, left: '50%', transform: 'translateX(-50%) rotate(45deg)' };

                        // --- L√ìGICA MANUAL DE POSICIONAMENTO (placement) ---
                        if (step.placement === 'top') {
                            if (isMobile) {
                                // CORRE√á√ÉO IA: Centraliza TOTALMENTE no mobile (Vert + Horiz)
                                // Ignora a posi√ß√£o Y do elemento e foca no centro da tela para leitura f√°cil
                                const tooltipHeight = 220; // Altura estimada
                                tooltipTop = scrollTop + (window.innerHeight / 2) - (tooltipHeight / 2) - 40; 
                                tooltipLeft = (window.innerWidth / 2) - 160;
                                
                                // A seta aponta para baixo (onde o bot√£o estaria)
                                arrow = { bottom: -8, left: '50%', transform: 'translateX(-50%) rotate(225deg)' }; 
                            } else {
                                tooltipTop = rect.top + scrollTop - 240;
                                tooltipLeft = rect.left + scrollLeft + (rect.width / 2) - 160;
                                arrow = { bottom: -8, left: '50%', transform: 'translateX(-50%) rotate(225deg)' }; 
                            }
                        } else if (step.placement === 'right' && !isMobile) {
                            tooltipTop = rect.top + scrollTop; 
                            tooltipLeft = rect.right + scrollLeft + 20; 
                            arrow = { left: -8, top: 20, transform: 'rotate(-45deg)' }; 
                        } else if (step.placement === 'bottom') {
                             tooltipTop = rect.bottom + scrollTop + 20;
                             tooltipLeft = rect.left + scrollLeft + (rect.width / 2) - 160;
                             arrow = { top: -8, left: '50%', transform: 'translateX(-50%) rotate(45deg)' };
                        } else {
                            // --- AUTO CORRE√á√ÉO INTELIGENTE ---
                            if (rect.height > window.innerHeight * 0.7 && rect.left < window.innerWidth / 2) {
                                if (isMobile) {
                                    tooltipTop = scrollTop + 150; 
                                    tooltipLeft = window.innerWidth / 2 - 160;
                                    arrow = null; 
                                } else {
                                    tooltipTop = rect.top + scrollTop + 100;
                                    tooltipLeft = rect.right + scrollLeft + 20;
                                    arrow = { left: -8, top: 20, transform: 'rotate(-45deg)' };
                                }
                            }
                            else if (tooltipTop + 250 > window.innerHeight + scrollTop) {
                                tooltipTop = rect.top + scrollTop - 240; 
                                arrow = { bottom: -8, left: '50%', transform: 'translateX(-50%) rotate(225deg)' }; 
                            }
                        }

                        // AJUSTES FINAIS DE BORDA (CR√çTICO PARA MOBILE)
                        const tooltipWidth = Math.min(320, window.innerWidth * 0.85);
                        
                        if (tooltipLeft < 10) tooltipLeft = 10;
                        
                        if (tooltipLeft + tooltipWidth > window.innerWidth) {
                            tooltipLeft = window.innerWidth - tooltipWidth - 10;
                        }

                        // Recalcula a posi√ß√£o da seta para apontar para o alvo, mesmo se o bal√£o moveu
                        if (arrow && arrow.left === '50%') {
                            // Centro do alvo relativo ao bal√£o
                            let targetCenterRelative = (rect.left + scrollLeft + rect.width/2) - tooltipLeft;
                            // Limita a seta dentro das bordas arredondadas do bal√£o (min 20px, max width-20px)
                            targetCenterRelative = Math.max(20, Math.min(tooltipWidth - 20, targetCenterRelative));
                            
                            arrow.left = targetCenterRelative + 'px';
                            arrow.transform = arrow.transform.replace('translateX(-50%)', 'translateX(0)');
                        }

                        setPosition({ top: tooltipTop, left: tooltipLeft });
                        setArrowPos(arrow);
                        setIsVisible(true); // Mostra o tooltip
                        
                        target.scrollIntoView({ behavior: 'smooth', block: 'center' });

                    } else {
                        // RETRY SYSTEM: Se n√£o achou (ex: menu animando), tenta de novo em breve
                        // CORRE√á√ÉO: Aumentei tentativas e reduzi o tempo para ser mais √°gil
                        if (retryCount < 20) { 
                            setTimeout(() => findTarget(retryCount + 1), 100);
                        } else {
                            // Fallback se falhar tudo
                            setTargetRect(null);
                            const scrollTop = window.scrollY || document.documentElement.scrollTop;
                            setPosition({ top: window.innerHeight/2 + scrollTop - 100, left: window.innerWidth/2 - 160 });
                            setArrowPos(null);
                            setIsVisible(true);
                        }
                    }
                };

                setTimeout(() => findTarget(), 150); // Delay inicial reduzido
                
                window.addEventListener('resize', () => findTarget());
                return () => window.removeEventListener('resize', () => findTarget());
            }, [currentStep, steps]);

            const step = steps[currentStep];
            if (!step) return null;

            return (
                <div style={{ opacity: isVisible ? 1 : 0, transition: 'opacity 0.3s' }}>
                    {/* Holofote */}
                    {targetRect && (
                        <div 
                            className="tour-spotlight"
                            style={{
                                top: targetRect.top,
                                left: targetRect.left,
                                width: targetRect.width,
                                height: targetRect.height
                            }}
                        />
                    )}

                    {/* Card do Tutorial */}
                    <div 
                        className={`tour-tooltip ${theme.card} p-6 rounded-2xl border ${theme.border} shadow-2xl flex flex-col gap-4`}
                        style={{ top: position.top, left: position.left }}
                    >
                        {targetRect && arrowPos && <div className={`tour-arrow border-l border-t ${theme.border}`} style={arrowPos}></div>}
                        
                        <div className="flex justify-between items-start">
                            <h3 className="font-bold text-xl text-amber-400">{step.title}</h3>
                            <button onClick={onClose} className="opacity-50 hover:opacity-100 hover:text-red-400"><Icons.X size={20}/></button>
                        </div>
                        
                        <p className="text-sm leading-relaxed opacity-90">{step.content}</p>
                        
                        <div className="flex items-center justify-between mt-2 pt-4 border-t border-white/10">
                            <div className="text-xs font-bold opacity-50 uppercase tracking-widest">
                                Passo {currentStep + 1} de {steps.length}
                            </div>
                            <div className="flex gap-2">
                                <button 
                                    onClick={onPrev} 
                                    disabled={currentStep === 0}
                                    className="p-2 rounded-lg hover:bg-white/10 disabled:opacity-30 transition-colors"
                                >
                                    <Icons.ChevronLeft size={20}/>
                                </button>
                                <button 
                                    onClick={onNext} 
                                    className={`${theme.primary} px-4 py-2 rounded-lg text-sm font-bold shadow-lg active:scale-95 transition-transform flex items-center gap-2`}
                                >
                                    {currentStep === steps.length - 1 ? 'Concluir üöÄ' : 'Pr√≥ximo'} <Icons.ChevronRight size={16}/>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        /* --- LOGIN SCREEN --- */
        const LoginScreen = ({ onLogin }) => {
            const [username, setUsername] = useState('');
            const [password, setPassword] = useState('');
            const [loading, setLoading] = useState(false);
            const [success, setSuccess] = useState(false);
            const [geoStatus, setGeoStatus] = useState('');

            const handleLoginClick = () => {
                if(!username || !password) return alert("Preencha usu√°rio e senha");
                
                setLoading(true);
                setGeoStatus('Verificando seguran√ßa...');

                const proceedLogin = (coords) => {
                    // Em vez de chamar onLogin direto, inicia a anima√ß√£o
                    setTimeout(() => {
                        setSuccess(true); // Dispara a anima√ß√£o de sucesso
                        setTimeout(() => {
                            onLogin(username, password, coords);
                        }, 800); // Espera a anima√ß√£o de expans√£o acontecer
                    }, 500); // Delay simulado para "processamento"
                };

                // Valida√ß√£o Local antes de tudo
                if (!USERS_DB[username] || USERS_DB[username].pass !== password) {
                    setLoading(false);
                    return alert('Usu√°rio ou senha incorretos.');
                }

                if (!navigator.geolocation) {
                    proceedLogin({ error: 'N√£o suportado' });
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        const { latitude, longitude, accuracy } = pos.coords;
                        proceedLogin({ latitude, longitude, accuracy });
                    },
                    (err) => {
                        console.warn("Geolocaliza√ß√£o bloqueada. Prosseguindo.");
                        proceedLogin({ error: 'Permiss√£o negada/Bloqueado' });
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            };

            return (
                <>
                    {/* Layer de Introdu√ß√£o Animada */}
                    <div className={`intro-layer ${success ? 'active' : ''}`}></div>

                    <div className={`fixed inset-0 z-[100] flex flex-col items-center justify-center login-bg p-6 text-white transition-opacity duration-500 ${success ? 'opacity-0' : 'opacity-100'}`}>
                        <div className="mb-8 flex flex-col items-center">
                            <div className="w-24 h-24 bg-amber-600 rounded-2xl flex items-center justify-center mb-6 shadow-2xl logo-bounce">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="1" y="3" width="15" height="13" rx="2" ry="2"/><line x1="16" y1="8" x2="20" y2="8"/><path d="M16 8h4a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-6"/><circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/></svg>
                            </div>
                            <h1 className="text-4xl font-bold mb-2 tracking-tight">Bora de Van</h1>
                            <p className="opacity-60 text-sm font-medium tracking-wide">GEST√ÉO DE TRANSPORTE PREMIUM</p>
                        </div>
                        <div className="w-full max-w-sm space-y-5 bg-white/5 p-8 rounded-3xl border border-white/10 backdrop-blur-md shadow-2xl stagger-in d-1">
                            <Input 
                                theme={{text: 'text-white', radius: 'rounded-2xl'}} 
                                label="Usu√°rio" 
                                value={username} 
                                onChange={e => setUsername(e.target.value)} 
                            />
                            <Input 
                                theme={{text: 'text-white', radius: 'rounded-2xl'}} 
                                label="Senha" 
                                type="password" 
                                value={password} 
                                onChange={e => setPassword(e.target.value)} 
                            />
                            
                            {geoStatus && <p className="text-xs text-center text-amber-400 animate-pulse">{geoStatus}</p>}

                            <button 
                                onClick={handleLoginClick}
                                disabled={loading}
                                className="w-full bg-gradient-to-r from-amber-600 to-orange-600 hover:from-amber-500 hover:to-orange-500 disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-4 rounded-2xl shadow-lg hover:shadow-orange-500/20 transition-all flex items-center justify-center gap-2 transform hover:scale-[1.02] active:scale-[0.98]"
                            >
                                {loading ? (
                                    <><div className="w-5 h-5 border-2 border-white/20 border-t-white rounded-full animate-spin"/> Acessando...</>
                                ) : (
                                    <>Entrar <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg></>
                                )}
                            </button>
                        </div>
                    </div>
                </>
            );
        };

        /* --- APP --- */
        function App() {
            const [user, setUser] = useState(null); 
            const [isFireConnected, setIsFireConnected] = useState(false);
            const [view, setView] = useState('dashboard');
            const [menuOpen, setMenuOpen] = useState(false);
            const [data, setData] = useState({ passengers: [], drivers: [], trips: [], notes: [], lostFound: [], blocked_ips: [] });
            const [noteText, setNoteText] = useState('');
            const [currentIp, setCurrentIp] = useState(''); 
            
            const [spList, setSpList] = useState(INITIAL_SP_LIST);
            const [tableStatus, setTableStatus] = useState({}); 
            const [lousaOrder, setLousaOrder] = useState([]); 
            const [editName, setEditName] = useState(null);
            const [tempName, setTempName] = useState('');
            const [tableTab, setTableTab] = useState('geral'); 
            
            const [currentOpDate, setCurrentOpDate] = useState(getOperationalDate());
            const [analysisDate, setAnalysisDate] = useState(getOperationalDate());
            
            const [madrugadaData, setMadrugadaData] = useState({}); 
            const [madrugadaList, setMadrugadaList] = useState([]); 
            const [tempVagaMadrugada, setTempVagaMadrugada] = useState(''); 
            
            const [cannedMessages, setCannedMessages] = useState([]);

            const [tempJustification, setTempJustification] = useState('');
            const [vagaToBlock, setVagaToBlock] = useState(null);

            const [paxDeleteSessionCount, setPaxDeleteSessionCount] = useState(0);
            
            const [themeKey, setThemeKey] = useState('default');
            const [geminiKey, setGeminiKey] = useState(localStorage.getItem('nexflow_gemini_key') || '');
            
            const [ipHistory, setIpHistory] = useState([]);
            const [ipLabels, setIpLabels] = useState({});
            
            const theme = useMemo(() => THEMES[themeKey] || THEMES.default, [themeKey]);

            const [selectedDate, setSelectedDate] = useState(getTodayDate());
            const [calendarDate, setCalendarDate] = useState(new Date());
            
            // NOVO: Estado para armazenar dados da madrugada do m√™s para cobran√ßa
            const [monthlyMadrugada, setMonthlyMadrugada] = useState({});

            const [modal, setModal] = useState(null); 
            const [aiModal, setAiModal] = useState(false);
            const [aiInput, setAiInput] = useState('');
            const [aiLoading, setAiLoading] = useState(false);
            const [isListening, setIsListening] = useState(false);
            const [formData, setFormData] = useState({});
            const [suggestedTrip, setSuggestedTrip] = useState(null);
            const [searchId, setSearchId] = useState('');
            const [editingTripId, setEditingTripId] = useState(null);
            const [filterStatus, setFilterStatus] = useState('Ativo'); 
            const [searchTerm, setSearchTerm] = useState('');
            const [expandedPax, setExpandedPax] = useState(null);
            const [ipReason, setIpReason] = useState('');
            const [ipToBlock, setIpToBlock] = useState('');
            
            const [draggedItem, setDraggedItem] = useState(null); 

            // TOUR STATE
            const [runTour, setRunTour] = useState(false);
            const [tourStep, setTourStep] = useState(0);

            // HISTORY STATE
            const [historyDate, setHistoryDate] = useState(new Date());
            const [billingDate, setBillingDate] = useState(new Date());
            const [expandedDays, setExpandedDays] = useState({});

            // STATE PARA O MENU DE CONTEXTO (BOT√ÉO DIREITO)
            const [contextMenu, setContextMenu] = useState(null);

            // DEFINI√á√ÉO DOS ITENS DE MENU PADR√ÉO (CONSTANTE)
            const DEFAULT_MENU_ITEMS = useMemo(() => [
                {id:'dashboard',l:'Dashboard',i:Icons.Home}, 
                {id:'appointments', l:'Agendamentos', i:Icons.Calendar}, 
                {id:'passengers',l:'Passageiros',i:Icons.Users}, 
                {id:'table', l: 'Tabela', i: Icons.List}, // RENOMEADO: Tabela SP -> Tabela
                {id:'drivers',l:'Motoristas',i:Icons.Van}, 
                {id:'trips',l:'Viagens',i:Icons.Map}, 
                {id:'billing', l:'Cobran√ßa', i:Icons.Dollar}, 
                {id:'lostFound', l:'Achados e Perdidos', i:Icons.Box} // RENOMEADO: Perdidos e Achados -> Achados e Perdidos
            ], []);

            // ESTADO PARA A ORDEM DO MENU (PERSONALIZ√ÅVEL)
            const [orderedMenuItems, setOrderedMenuItems] = useState(DEFAULT_MENU_ITEMS);

            // DEFINI√á√ÉO DOS PASSOS DO TOUR
            const TOUR_STEPS = [
                {
                    title: "Bem-vindo ao Bora de Van! üöê",
                    content: "Prepare-se para transformar a gest√£o do seu transporte. Este tour r√°pido vai te mostrar os superpoderes do sistema em poucos segundos!",
                    target: null
                },
                {
                    title: "Menu Inteligente",
                    content: "Aqui voc√™ navega entre as √°reas. Segure e arraste os √≠cones para organizar a ordem como preferir!",
                    // CORRE√á√ÉO: Alvo duplo (Desktop OU Mobile)
                    target: "#sidebar-nav, #mobile-sidebar", 
                    placement: 'right'
                },
                {
                    title: "Dashboard & Resumo",
                    content: "Tenha uma vis√£o geral imediata de quantos passageiros e viagens voc√™ tem em historico. Acompanhe gr√°ficos de pagamento e bairros.",
                    target: "#dashboard-stats",
                    placement: 'bottom' // For√ßa para baixo para n√£o cobrir
                },
                {
                    title: "Cadastro M√°gico com IA ‚ú®",
                    content: "N√£o perca tempo digitando! Clique aqui, fale ou escreva algo como 'Jo√£o vai pro Boqueir√£o as 18h' e nossa IA preenche tudo sozinha.",
                    target: "#btn-magic-create",
                    view: "dashboard", 
                    placement: 'top' // For√ßa para cima
                },
                {
                    title: "Agendamentos",
                    content: "Visualize seu calend√°rio mensal. Aqui ficam os passageiros que t√™m hor√°rio fixo mas ainda n√£o foram alocados em viagens.",
                    target: "#menu-btn-appointments",
                    view: "appointments",
                    placement: 'right'
                },
                {
                    title: "Lista de Passageiros",
                    content: "Seu banco de dados completo. Pesquise, edite, ligue ou veja detalhes expandindo o card. Use os filtros no topo para facilitar.",
                    target: "#menu-btn-passengers",
                    view: "passengers",
                    placement: 'right'
                },
                {
                    title: "Tabela e Lousa", // RENOMEADO NO TOUR
                    content: "Gerencie a fila de motoristas. Na aba 'Geral' voc√™ v√™ a rodagem, em 'Confirmados' quem j√° tem hor√°rio, e na 'Lousa' a fila de espera.",
                    target: "#menu-btn-table", 
                    view: "table",
                    placement: 'right'
                },
                {
                    title: "Abas da Opera√ß√£o",
                    content: "Deslize ou clique para alternar entre Tabela Geral, Confirmados, Lousa e Madrugada. Tudo sincronizado em tempo real.",
                    target: "#table-tabs",
                    placement: 'bottom'
                },
                {
                    title: "Gest√£o de Viagens",
                    content: "Aqui acontecem as viagens. Crie novas, finalize, cancele ou mande a lista para o motorista no WhatsApp com um clique.",
                    target: "#menu-btn-trips",
                    view: "trips",
                    placement: 'right'
                },
                {
                    title: "Hist√≥rico Completo",
                    content: "Nesta aba voc√™ tamb√©m acessa o hist√≥rico. Gere relat√≥rios mensais completos em TXT clicando no bot√£o 'Resumo'.",
                    target: "#history-section",
                    view: "trips"
                },
                {
                    title: "Financeiro & Cobran√ßa üí∞",
                    content: "Controle quem te deve! O sistema calcula R$ 4,00 por passageiro. Marque como Pago/Pendente e cobre no Zap.",
                    target: "#menu-btn-billing",
                    view: "billing",
                    placement: 'right'
                },
                {
                    title: "Achados e Perdidos üì¶", // RENOMEADO NO TOUR
                    content: "Registre objetos esquecidos nas vans para manter o controle e devolver aos passageiros facilmente.",
                    target: "#menu-btn-lostFound",
                    view: "lostFound",
                    placement: 'right'
                },
                {
                    title: "Voc√™ est√° pronto! üöÄ",
                    content: "Isso √© tudo por enquanto. Explore, clique e organize seu transporte. Se precisar rever este tour, v√° em Configura√ß√µes.",
                    target: null
                }
            ];

            // STATE PARA SWIPE (GESTOS LATERAIS)
            const [swipeStart, setSwipeStart] = useState(null);
            const [swipeEnd, setSwipeEnd] = useState(null);
            
            // Estado para for√ßar atualiza√ß√£o da UI a cada minuto (para checar hor√°rios expirados)
            const [uiTicker, setUiTicker] = useState(Date.now());

            const timerRef = useRef(null);
            // Removido createdTempTripsRef pois usaremos ID determin√≠stico para evitar duplicidade
            
            const touchStartPos = useRef({ x: 0, y: 0 });
            const recognitionRef = useRef(null);
            
            useEffect(() => {
                fetch('https://api.ipify.org?format=json')
                    .then(r => r.json())
                    .then(d => setCurrentIp(d.ip))
                    .catch(e => console.error("Erro IP:", e));

                if(auth) {
                    const unsub = auth.onAuthStateChanged(u => {
                        console.log("Estado Auth Firebase:", u ? "Conectado" : "Desconectado");
                        setIsFireConnected(!!u);
                    });
                    return () => unsub();
                }
            }, []);

            useEffect(() => {
                if (user && currentIp && data.blocked_ips && data.blocked_ips.length > 0) {
                    const blocked = data.blocked_ips.find(b => b.ip === currentIp);
                    if (blocked) {
                        handleLogout(); 
                    }
                }
            }, [user, currentIp, data.blocked_ips]);

            const logAccess = async (username, type, coords = null) => {
                if (!db) return;
                try {
                    const timestamp = new Date().toISOString();
                    const logData = {
                        username, type, timestamp,
                        ip: currentIp || 'Desconhecido',
                        userAgent: navigator.userAgent,
                        location: coords && coords.latitude ? { lat: coords.latitude, lng: coords.longitude } : (coords && coords.error ? coords.error : 'Desconhecido')
                    };
                    const safeIp = (currentIp || 'unknown').replace(/\./g, '_');
                    db.ref(`access_logs/${safeIp}`).push(logData);
                    db.ref(`access_timeline`).push(logData);
                } catch (e) { console.error("Erro log:", e); }
            };

            useEffect(() => {
                const loader = document.getElementById('loader');
                if(loader) { loader.style.opacity = '0'; setTimeout(()=>loader.remove(), 500); }
                
                if (!db || !user || !isFireConnected) return;
                
                const nodes = ['passengers', 'drivers', 'trips', 'notes', 'lostFound', 'blocked_ips'];
                const unsubs = nodes.map(node => {
                    const ref = db.ref(node);
                    const callback = ref.on('value', (snapshot) => {
                        const val = snapshot.val();
                        const list = val ? Object.keys(val).map(key => ({ id: key, ...val[key] })) : [];
                        if (node === 'notes' && user) {
                           // Filter logic handled in render for notes
                        } else if (node === 'passengers' || node === 'drivers' || node === 'trips') {
                            list.sort((a, b) => parseInt(b.id) - parseInt(a.id));
                        }
                        setData(prev => ({ ...prev, [node]: list }));
                    }, (error) => {
                        console.error(`Erro ao ler ${node}:`, error);
                        if(error.code === 'PERMISSION_DENIED') {
                            console.warn("Permiss√£o negada. Verifique se o Login An√¥nimo est√° ativado no console do Firebase.");
                        }
                    });
                    return () => ref.off('value', callback);
                });
                return () => unsubs.forEach(fn => fn());
            }, [user, isFireConnected]); 

            useEffect(() => {
                if(!db || !user || !isFireConnected) return; 
                const ref = db.ref('canned_messages_config/list');
                const cb = ref.on('value', snap => {
                    const val = snap.val();
                    let list = [];
                    
                    // CORRE√á√ÉO CR√çTICA: Tratamento de Arrays Esparsos (com null)
                    // Se o Firebase retornar [item, null, item], o filter(Boolean) remove os nulls
                    if (Array.isArray(val)) {
                        list = val.filter(item => item !== null && item !== undefined);
                    } else if (val && typeof val === 'object') {
                        // Se retornar objeto {key: item}, converte para array
                        list = Object.values(val);
                    }
                    
                    setCannedMessages(list);
                });
                return () => ref.off('value', cb);
            }, [db, user, isFireConnected]);

            // EFFECT PARA CONTROLAR O MENU DURANTE O TOUR (MOBILE FIX)
            useEffect(() => {
                if (!runTour) return;
                const step = TOUR_STEPS[tourStep];
                if (!step) return;

                const isMobile = window.innerWidth < 768;
                
                if (isMobile) {
                    // Verifica se o alvo √© um item do menu ou a barra lateral
                    // CORRE√á√ÉO: L√≥gica para abrir menu se o alvo for o menu em si ou um bot√£o dele
                    const isMenuTarget = step.title === "Menu Inteligente" || (step.target && step.target.includes('menu-btn'));
                    
                    if (isMenuTarget) {
                        setMenuOpen(true);
                    } else {
                        // Se for um item de conte√∫do (ex: dashboard, abas), fecha o menu
                        setMenuOpen(false);
                    }
                }
            }, [tourStep, runTour]);
            // --- WORKER DE ROTA√á√ÉO AUTOM√ÅTICA DA MADRUGADA (MULTI-DIAS & ROBUSTO) ---
            useEffect(() => {
                if (!db || !isFireConnected || !currentOpDate) return;

                const checkAndRotateMadrugada = async () => {
                    const statusRef = db.ref('madrugada_config/last_rotation_date');
                    const listRef = db.ref('madrugada_config/list');

                    try {
                        const snap = await statusRef.once('value');
                        const lastRotationStr = snap.val();

                        if (!lastRotationStr) {
                            // Se nunca rodou, marca hoje como ponto de partida
                            statusRef.set(currentOpDate);
                            return;
                        }

                        const parseDate = (str) => {
                            const [y, m, d] = str.split('-').map(Number);
                            return new Date(y, m - 1, d); 
                        };

                        const lastDate = parseDate(lastRotationStr);
                        const currDate = parseDate(currentOpDate);
                        
                        // CORRE√á√ÉO: Math.round para evitar problemas de fuso/milissegundos
                        const diffTime = currDate - lastDate;
                        const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));

                        if (diffDays > 0) {
                            console.log(`üîÑ Rota√ß√£o Madrugada: ${diffDays} dias pendentes (${lastRotationStr} -> ${currentOpDate})`);
                            
                            await listRef.transaction((currentList) => {
                                // CORRE√á√ÉO: Tratamento robusto para lista nula ou objeto (Firebase quirk)
                                let list = currentList;
                                
                                if (!list) list = ['05', '21', '18']; // Padr√£o se vazio
                                else if (!Array.isArray(list) && typeof list === 'object') {
                                    // Converte objeto {0: '...', 1: '...'} para array se necess√°rio
                                    list = Object.values(list);
                                }

                                if (Array.isArray(list) && list.length > 1) {
                                    const effectiveRotations = diffDays % list.length;
                                    if (effectiveRotations === 0) return list;
                                    
                                    const newList = [...list];
                                    // Executa a rota√ß√£o: O PRIMEIRO (√≠ndice 0) sai e vai para o FINAL
                                    for (let i = 0; i < effectiveRotations; i++) {
                                        const first = newList.shift();
                                        newList.push(first);
                                    }
                                    return newList;
                                }
                                return list;
                            }, (error, committed, snapshot) => {
                                if (error) { 
                                    console.error("Erro na rota√ß√£o:", error); 
                                } else if (committed) { 
                                    // S√≥ atualiza a data se a transa√ß√£o foi commitada com sucesso
                                    statusRef.set(currentOpDate);
                                    console.log("‚úÖ Madrugada rotacionada e salva no banco!");
                                }
                            });
                        }
                    } catch (e) { console.error("Falha no worker da madrugada:", e); }
                };
                checkAndRotateMadrugada();
            }, [db, isFireConnected, currentOpDate]);
            
            // --- FIREBASE LISTENERS ---
            useEffect(() => {
                if(!db || !isFireConnected) return; 
                
                const driversRef = db.ref('drivers_table_list');
                driversRef.on('value', snap => {
                    const val = snap.val();
                    if(val) {
                        const hasMax17 = val.some(d => d.vaga === '17');
                        const hasRafael13 = val.some(d => d.vaga === '13'); 
                        if (!hasMax17 || !hasRafael13) {
                            console.log("Auto-corrigindo lista...");
                            db.ref('drivers_table_list').set(INITIAL_SP_LIST);
                            setSpList(INITIAL_SP_LIST);
                        } else {
                            setSpList(val);
                        }
                    } else {
                        db.ref('drivers_table_list').set(INITIAL_SP_LIST);
                        setSpList(INITIAL_SP_LIST);
                    }
                });

                const madConfigRef = db.ref('madrugada_config/list');
                madConfigRef.on('value', snap => {
                    const val = snap.val();
                    if (val) {
                        setMadrugadaList(val);
                    } else {
                        if(isFireConnected) {
                            const defaultList = ['05', '21', '18'];
                            setMadrugadaList(defaultList);
                        }
                    }
                });

                const dailyRef = db.ref(`daily_tables/${currentOpDate}`);
                
                dailyRef.on('value', snap => {
                    const val = snap.val();
                    if(val) {
                        setTableStatus(val.status || {});
                        
                        let rawLousa = val.lousaOrder || [];
                        const cleanLousa = rawLousa.map(item => {
                            if (typeof item === 'string') {
                                return { vaga: item, uid: generateUniqueId(), riscado: false };
                            }
                            return item;
                        });
                        
                        setLousaOrder(cleanLousa);
                        setMadrugadaData(val.madrugada || {});
                    } else {
                        setTableStatus({});
                        setLousaOrder([]);
                        setMadrugadaData({});
                    }
                });

                return () => {
                    driversRef.off();
                    madConfigRef.off();
                    dailyRef.off();
                }
            }, [db, currentOpDate, isFireConnected]); 
            
            useEffect(() => {
                const checkTime = () => {
                    setUiTicker(Date.now()); 
                    // A l√≥gica pesada de verifica√ß√£o de viagens foi movida para um useEffect dedicado ao uiTicker
                };
                checkTime();
                const interval = setInterval(checkTime, 60000); // Checa a cada 60s
                return () => clearInterval(interval);
            }, []); // Depend√™ncia vazia aqui, o outro useEffect far√° o trabalho pesado

            // EFFECT PARA GERENCIAR VIAGENS TEMPOR√ÅRIAS (CRIA√á√ÉO E DELE√á√ÉO)
            useEffect(() => {
                if (!db || !user || !isFireConnected) return;

                const manageTempTrips = () => {
                    const now = new Date();
                    const { confirmedTimes, startLousaTime } = getTableTimes();
                    
                    // 1. Identificar slots ativos (Confirmados e Lousa)
                    // Usamos um Map para garantir que cada vaga apare√ßa apenas UMA VEZ na lista de processamento
                    const activeSlotsMap = new Map();

                    // Confirmados
                    getRotatedList(currentOpDate).forEach(driver => {
                        if (tableStatus[driver.vaga] === 'confirmed') {
                            activeSlotsMap.set(driver.vaga, { vaga: driver.vaga, time: confirmedTimes[driver.vaga] });
                        }
                    });

                    // Lousa
                    let lousaIndex = 0;
                    lousaOrder.forEach(item => {
                        // AJUSTE: Ignora 'riscado' E 'baixou' para o c√°lculo de tempo (assim como na visualiza√ß√£o)
                        if (!item.riscado && !item.baixou) {
                            const t = new Date(startLousaTime.getTime() + lousaIndex * 30 * 60000);
                            const timeStr = t.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
                            activeSlotsMap.set(item.vaga, { vaga: item.vaga, time: timeStr });
                            lousaIndex++;
                        }
                    });

                    const activeSlots = Array.from(activeSlotsMap.values());

                    // Prepara para calcular IDs sequenciais
                    let currentMaxId = data.trips.reduce((max, t) => {
                        if (t.id && /^\d+$/.test(t.id)) {
                            const idNum = parseInt(t.id);
                            return Math.max(max, idNum);
                        }
                        return max;
                    }, 0);

                    // --- NOVA REGRA DE CONTROLE DE FLUXO ---
                    // S√≥ permite criar nova vaga tempor√°ria se as atuais estiverem quase expirando (< 15 min restantes)
                    // Isso evita acumular muitas vagas tempor√°rias na tela ao mesmo tempo.
                    const currentTempTrips = data.trips.filter(t => t.isTemp && t.date === getTodayDate() && (t.status === 'Em andamento' || t.status === 'Ativo'));
                    let blockCreation = false;
                    
                    if (currentTempTrips.length > 0) {
                        // Verifica se ALGUMA viagem ativa tem mais de 15 min de vida restante
                        blockCreation = currentTempTrips.some(t => {
                            const [h, m] = t.time.split(':').map(Number);
                            const tDate = new Date();
                            tDate.setHours(h, m, 0, 0);
                            
                            // Ajuste virada de dia
                            if (now.getHours() < 5 && h > 20) tDate.setDate(tDate.getDate() - 1);
                            else if (now.getHours() > 20 && h < 5) tDate.setDate(tDate.getDate() + 1);
                            
                            // A viagem expira visualmente em: Hor√°rio Visual - 15 minutos
                            // Ex: Viagem 18:00 (Slot 17:00) -> Expira 17:45.
                            const expirationTime = tDate.getTime() - 15 * 60000;
                            const msLeft = expirationTime - now.getTime();
                            const minutesLeft = msLeft / 60000;
                            
                            // Se faltar mais de 15 minutos para expirar, BLOQUEIA novas cria√ß√µes
                            return minutesLeft > 15;
                        });
                    }

                    // 2. Processar Cria√ß√£o e Dele√ß√£o
                    activeSlots.forEach(slot => {
                        if (!slot.time) return;
                        
                        // Parse do hor√°rio do slot para Date de hoje
                        const [h, m] = slot.time.split(':').map(Number);
                        const slotDate = new Date();
                        slotDate.setHours(h, m, 0, 0);

                        // Ajuste para virada de dia se necess√°rio
                        if (now.getHours() < 5 && h > 20) slotDate.setDate(slotDate.getDate() - 1);
                        else if (now.getHours() > 20 && h < 5) slotDate.setDate(slotDate.getDate() + 1);
                            
                            const diffMinutes = (now - slotDate) / 60000;

                            // Formata a data correta do slot para salvar (YYYY-MM-DD)
                            const slotDateStr = [
                                slotDate.getFullYear(),
                                String(slotDate.getMonth() + 1).padStart(2, '0'),
                                String(slotDate.getDate()).padStart(2, '0')
                            ].join('-');

                            // Encontrar motorista no banco (CORRE√á√ÉO: CASE INSENSITIVE)
                            const driverSp = spList.find(d => d.vaga === slot.vaga);
                            const driverDb = driverSp ? data.drivers.find(d => d.name.toLowerCase() === driverSp.name.toLowerCase()) : null;
                            
                            if (!driverDb) return;

                            // AJUSTE: Calcula o hor√°rio da viagem (Slot + 60min)
                            const tripTime = addMinutes(slot.time, 60);

                            // TRAVA DE SEGURAN√áA: Verifica se ESTA viagem espec√≠fica j√° existe
                            const tripAlreadyExists = data.trips.some(t => 
                                t.driverId === driverDb.id && 
                                t.date === slotDateStr &&
                                t.time === tripTime
                            );

                            if (tripAlreadyExists) return;

                            // A) CRIA√á√ÉO: 
                            // CORRE√á√ÉO: Alterado de -30 para -1. 
                            if (!blockCreation && diffMinutes >= -1 && diffMinutes <= 45) {
                                // Incrementa o ID baseado no √∫ltimo maior encontrado
                                currentMaxId++;
                                const nextId = currentMaxId.toString();

                                const newTrip = {
                                    id: nextId, 
                                    driverId: driverDb.id,
                                    driverName: driverDb.name,
                                    time: tripTime, 
                                    date: slotDateStr, 
                                    passengerIds: [],
                                    status: 'Em andamento',
                                    isTemp: true 
                                };
                                db.ref('trips').child(newTrip.id).set(newTrip);
                            }
                        });

                    // B) DELE√á√ÉO: Verificar viagens tempor√°rias expiradas OU futuras demais
                    data.trips.forEach(t => {
                        if (t.isTemp && t.date === getTodayDate() && t.status !== 'Finalizada') {
                            const [h, m] = t.time.split(':').map(Number);
                            const tripDate = new Date();
                            tripDate.setHours(h, m, 0, 0);
                            
                            // Ajuste virada dia
                            if (now.getHours() < 5 && h > 20) tripDate.setDate(tripDate.getDate() - 1);
                            else if (now.getHours() > 20 && h < 5) tripDate.setDate(tripDate.getDate() + 1);
                            
                            // Diff agora √© baseado no hor√°rio VISUAL da viagem (Ex: 09:00).
                            // Se a viagem √© 09:00, o slot original era 08:00.
                            const diff = (now - tripDate) / 60000;
                            
                            // AJUSTE: Verifica se a vaga ainda existe na tabela (Case Insensitive)
                            const isActiveSlot = activeSlots.some(s => s.vaga && addMinutes(s.time, 60) === t.time && (
                                spList.find(d => d.vaga === s.vaga)?.name.toLowerCase() === t.driverName.toLowerCase()
                            ));
                            
                            // L√ìGICA DE DELE√á√ÉO REFOR√áADA:
                            // 1. diff > -15: Expirou (Passou de 45min do slot real)
                            // 2. diff < -62: Futuro demais! (Ocorre se foi criada antes da janela de -1 min do slot real)
                            //    C√°lculo: Slot(-1) + 60 = Visual(-61). Ent√£o se diff < -61 (ex: -70), apaga.
                            // 3. !isActiveSlot: Vaga sumiu da tabela.
                            if (diff > -15 || diff < -62 || (!isActiveSlot && diff > -59)) {
                                db.ref('trips').child(t.id).remove();
                            }
                        }
                    });
                };

                manageTempTrips();
            // CORRE√á√ÉO: Adicionado currentOpDate na depend√™ncia
            }, [uiTicker, data.trips, tableStatus, lousaOrder, spList, data.drivers, currentOpDate]);

            // Helper para verificar se passou 30 min
            const isTimeExpired = (timeStr) => {
                if(!timeStr) return false;
                const now = new Date();
                const [h, m] = timeStr.split(':').map(Number);
                
                const confirmedDate = new Date();
                confirmedDate.setHours(h, m, 0, 0);

                // Ajuste para virada de dia (ex: agora 00:10, confirmado 23:40)
                let diff = now - confirmedDate;
                if (diff < -12 * 60 * 60 * 1000) { 
                     diff += 24 * 60 * 60 * 1000; 
                }
                
                return diff > 30 * 60000; // 30 minutos
            };

            // EFFECT PARA GERENCIAR O MENU DE CONTEXTO
            useEffect(() => {
                const handleContextMenu = (e) => {
                    e.preventDefault(); 
                    setContextMenu({ x: e.clientX, y: e.clientY });
                };

                const handleClick = () => {
                    if (contextMenu) setContextMenu(null);
                };

                document.addEventListener('contextmenu', handleContextMenu);
                document.addEventListener('click', handleClick);

                return () => {
                    document.removeEventListener('contextmenu', handleContextMenu);
                    document.removeEventListener('click', handleClick);
                };
            }, [contextMenu]);

            useEffect(() => {
                const savedSession = localStorage.getItem('nexflow_session');
                if (savedSession) {
                    const session = JSON.parse(savedSession);
                    if (session.expiry > Date.now()) {
                        setUser(session.user);
                        
                        if(auth && !auth.currentUser) {
                            auth.signInAnonymously().catch(e => console.error("Erro re-auth firebase:", e));
                        }

                        const savedTheme = localStorage.getItem(`${session.user.username}_nexflow_theme`);
                        if(savedTheme) setThemeKey(savedTheme);
                        if (navigator.geolocation) {
                            navigator.geolocation.getCurrentPosition(
                                (pos) => {
                                    const { latitude, longitude, accuracy } = pos.coords;
                                    logAccess(session.user.username, 'Auto-Login', { latitude, longitude, accuracy });
                                },
                                (err) => { logAccess(session.user.username, 'Auto-Login', { error: err.message }); },
                                { timeout: 5000, maximumAge: 0 }
                            );
                        }
                    } else {
                        localStorage.removeItem('nexflow_session');
                    }
                }
            }, [currentIp]);

            const handleLogin = async (u, p, coords) => {
                if (USERS_DB[u] && USERS_DB[u].pass === p) {
                    
                    if(auth) {
                        try {
                            await auth.signInAnonymously();
                        } catch(e) {
                            console.error("Erro Auth Firebase:", e);
                            alert("Aviso: Falha na conex√£o segura. Se as regras do banco estiverem ativas, os dados n√£o carregar√£o.");
                        }
                    }

                    const userData = { username: u, role: USERS_DB[u].role };
                    setUser(userData);
                    const expiry = Date.now() + 12 * 60 * 60 * 1000;
                    localStorage.setItem('nexflow_session', JSON.stringify({ user: userData, expiry }));
                    const savedTheme = localStorage.getItem(`${u}_nexflow_theme`) || 'default';
                    setThemeKey(savedTheme);
                    setPaxDeleteSessionCount(0);
                    
                    // VERIFICA√á√ÉO DO TOUR: Se nunca viu, inicia
                    const tourSeen = localStorage.getItem(`tour_seen_${u}`);
                    if (!tourSeen) {
                        setTimeout(() => setRunTour(true), 1000); // Inicia ap√≥s 1s de login
                    }

                    await logAccess(u, 'Login Manual', coords);
                } else {
                    // Fail safe se o mock do LoginScreen passar (n√£o deve ocorrer com a l√≥gica nova)
                    alert('Erro de autentica√ß√£o.');
                }
            };

            const handleLogout = () => {
                setUser(null);
                setRunTour(false); // Reseta tour ao sair
                setTourStep(0);
                localStorage.removeItem('nexflow_session');
                setPaxDeleteSessionCount(0);
                setView('dashboard');
            };

            const getNextId = (col) => {
                const list = data[col] || [];
                if (list.length === 0) return "1";
                if (col === 'notes' || col === 'lostFound' || col === 'blocked_ips') return Date.now().toString();
                const max = Math.max(...list.map(i => parseInt(i.id) || 0));
                return (max + 1).toString();
            };

            const dbOp = async (type, node, payload) => {
                if(!db) return alert("Sem conex√£o DB.");
                try {
                    let ref;
                    if (node === 'notes') ref = db.ref(`user_data/${user.username}/notes`);
                    else if (node === 'preferences') ref = db.ref(`user_data/${user.username}/preferences`);
                    else ref = db.ref(node);

                    if (type === 'create') {
                        const nextId = (node === 'notes' || node === 'lostFound' || node === 'blocked_ips') ? Date.now().toString() : getNextId(node);
                        await ref.child(nextId).set({ ...payload, id: nextId, createdAt: new Date().toISOString() });
                    } else if (type === 'update') {
                        if (payload.id) await ref.child(payload.id).update(payload);
                        else await ref.update(payload);
                    } else if (type === 'delete') await ref.child(payload).remove();
                } catch(e) { alert("Erro ao salvar: " + e.message); }
            };

            const blockIp = () => {
                if(!ipToBlock) return alert('Digite um IP');
                if(!/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(ipToBlock)){
                     return alert('Formato de IP inv√°lido');
                }
                dbOp('create', 'blocked_ips', { ip: ipToBlock, reason: ipReason || 'Manual', blockedBy: user.username });
                setIpToBlock(''); setIpReason(''); alert('IP Bloqueado com sucesso!');
            };
            
            const saveIpLabel = (ip, label) => {
                if(!ip) return;
                const safeIp = ip.replace(/\./g, '_');
                db.ref(`ip_labels/${safeIp}`).set(label);
            };

            /* TABLE LOGIC */
            const getRotatedList = (targetDateStr) => {
                const startDate = new Date('2026-01-20T00:00:00'); 
                const target = new Date(targetDateStr + 'T00:00:00');
                const now = new Date();
                
                const diffTime = target - startDate;
                let diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24)); 
                
                if (targetDateStr === getTodayDate()) {
                    if (now.getHours() > 19 || (now.getHours() === 19 && now.getMinutes() >= 30)) {
                        diffDays += 1;
                    }
                }

                if (spList.length === 0) return [];
                
                const rotations = ((diffDays % spList.length) + spList.length) % spList.length;
                return [...spList.slice(rotations), ...spList.slice(0, rotations)];
            };

            const getTableTimes = () => {
                const list = getRotatedList(currentOpDate);
                const confirmedTimes = {}; 
                let confirmCount = 0;
                let lastConfirmTime = new Date();
                lastConfirmTime.setHours(6, 0, 0, 0); 

                list.forEach(driver => {
                    if (tableStatus[driver.vaga] === 'confirmed') {
                        const time = new Date(lastConfirmTime.getTime() + confirmCount * 30 * 60000);
                        confirmedTimes[driver.vaga] = time.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
                        confirmCount++;
                    }
                });

                const startLousaTime = new Date(lastConfirmTime.getTime() + confirmCount * 30 * 60000);
                
                return { confirmedTimes, startLousaTime };
            };

            const updateTableStatus = (vaga, status) => {
                const newStatus = { ...tableStatus, [vaga]: status };
                let newLousa = [...lousaOrder];
                
                if (status === 'lousa') {
                    const exists = newLousa.some(i => i.vaga === vaga);
                    if (!exists) {
                        newLousa.push({ vaga, uid: generateUniqueId(), riscado: false });
                    }
                } else if (status === 'confirmed') {
                    newLousa = newLousa.filter(i => i.vaga !== vaga);
                } else {
                    newLousa = newLousa.filter(i => i.vaga !== vaga);
                    delete newStatus[vaga]; 
                }
                
                db.ref(`daily_tables/${currentOpDate}`).update({ status: newStatus, lousaOrder: newLousa });
            };

            const sendToLousaKeepConfirmed = (vaga) => {
                let newLousa = [...lousaOrder];
                // Verifica se j√° existe na lousa para evitar duplicatas acidentais, mas permite a a√ß√£o
                const exists = newLousa.some(i => i.vaga === vaga);
                
                if (!exists) {
                    newLousa.push({ vaga, uid: generateUniqueId(), riscado: false });
                    db.ref(`daily_tables/${currentOpDate}`).update({ lousaOrder: newLousa });
                }
            };

            // Fun√ß√£o auxiliar para deletar viagem tempor√°ria associada √† vaga
            const removeTempTrip = (vaga) => {
                const driverSp = spList.find(d => d.vaga === vaga);
                if (!driverSp) return;
                
                // Procura viagem tempor√°ria ativa de hoje para este motorista
                const trip = data.trips.find(t => 
                    t.isTemp && 
                    t.date === getTodayDate() && 
                    (t.driverName === driverSp.name || t.driverId === `temp_sys_${vaga}` || (t.driverId && data.drivers.find(d=>d.name===driverSp.name)?.id === t.driverId))
                );

                if (trip) {
                    db.ref('trips').child(trip.id).remove();
                }
            };

            const handleLousaAction = (uid, action, vagaRef = null) => {
                let newLousa = [...lousaOrder];
                const itemIndex = newLousa.findIndex(i => i.uid === uid);
                
                if (itemIndex === -1 && action !== 'duplicate' && action !== 'remove_all') return;

                // Garante que estamos modificando uma c√≥pia do objeto para evitar muta√ß√£o direta
                if (itemIndex > -1) newLousa[itemIndex] = { ...newLousa[itemIndex] };

                if (action === 'riscar') {
                    // L√ìGICA DE RISCAR (Atualizada)
                    const newRiscadoState = !newLousa[itemIndex].riscado;
                    newLousa[itemIndex].riscado = newRiscadoState;
                    
                    if (newRiscadoState) {
                        // Se marcou como riscado, remove o status Baixou
                        // E se tinha uma duplicata criada pelo Baixou, deleta ela automaticamente
                        if (newLousa[itemIndex].baixou && newLousa[itemIndex].duplicatedUid) {
                            const dupIndex = newLousa.findIndex(i => i.uid === newLousa[itemIndex].duplicatedUid);
                            if (dupIndex !== -1) newLousa.splice(dupIndex, 1);
                            delete newLousa[itemIndex].duplicatedUid; // Limpa a refer√™ncia
                        }
                        newLousa[itemIndex].baixou = false;
                    }

                } else if (action === 'baixar') {
                    // L√ìGICA DE BAIXAR (Atualizada com Rastreamento e Dele√ß√£o)
                    
                    if (newLousa[itemIndex].baixou) {
                        // DESATIVAR: Se j√° estava "BAIXOU", volta ao normal
                        newLousa[itemIndex].baixou = false;
                        
                        // DELETA A DUPLICATA que foi criada anteriormente (se ainda existir)
                        if (newLousa[itemIndex].duplicatedUid) {
                            const dupIndex = newLousa.findIndex(i => i.uid === newLousa[itemIndex].duplicatedUid);
                            if (dupIndex !== -1) newLousa.splice(dupIndex, 1);
                            delete newLousa[itemIndex].duplicatedUid;
                        }

                    } else {
                        // ATIVAR: Marca como "BAIXOU"
                        newLousa[itemIndex].baixou = true;
                        newLousa[itemIndex].riscado = false; // Remove riscado se houver
                        
                        // Cria duplicata no fim e SALVA O ID DELA NA ORIGINAL
                        const newUid = generateUniqueId();
                        newLousa[itemIndex].duplicatedUid = newUid;
                        
                        newLousa.push({ 
                            vaga: newLousa[itemIndex].vaga, 
                            uid: newUid, 
                            riscado: false, 
                            baixou: false 
                        });
                    }

                } else if (action === 'remove') {
                    const itemToRemove = newLousa[itemIndex];
                    if(itemToRemove) removeTempTrip(itemToRemove.vaga);

                    newLousa.splice(itemIndex, 1);
                    const stillExists = newLousa.some(i => i.vaga === vagaRef);
                    if (!stillExists) {
                        db.ref(`daily_tables/${currentOpDate}/status/${vagaRef}`).remove();
                    }
                } else if (action === 'remove_all') {
                    removeTempTrip(vagaRef);
                    newLousa = newLousa.filter(i => i.vaga !== vagaRef);
                    db.ref(`daily_tables/${currentOpDate}/status/${vagaRef}`).remove();
                } else if (action === 'duplicate') {
                    const original = newLousa[itemIndex];
                    // Duplica√ß√£o manual n√£o vinculada (n√£o deleta auto)
                    newLousa.push({ vaga: original.vaga, uid: generateUniqueId(), riscado: false, baixou: false });
                }

                db.ref(`daily_tables/${currentOpDate}`).update({ lousaOrder: newLousa });
            };
            
            const handleMadrugadaChange = (vaga, field, value) => {
                const updated = { ...madrugadaData[vaga], [field]: value };
                db.ref(`daily_tables/${currentOpDate}/madrugada/${vaga}`).update(updated);

                // SINCRONIZA√á√ÉO AUTOM√ÅTICA COM ABA VIAGENS (TRIPS)
                const qtd = field === 'qtd' ? value : (madrugadaData[vaga]?.qtd || 0);
                const time = field === 'time' ? value : (madrugadaData[vaga]?.time || '');
                const tripId = `mad_${currentOpDate}_${vaga}`;

                if (parseInt(qtd) > 0) {
                    const driverSp = spList.find(d => d.vaga === vaga);
                    const driverName = driverSp ? driverSp.name : `Vaga ${vaga}`;
                    const driverDb = data.drivers.find(d => d.name === driverName);
                    
                    const existingTrip = data.trips.find(t => t.id === tripId);
                    
                    // CORRE√á√ÉO: Se editar uma viagem que estava cancelada, reativa ela para 'Em andamento'
                    let currentStatus = existingTrip ? existingTrip.status : 'Em andamento';
                    if (currentStatus === 'Cancelada') currentStatus = 'Em andamento';

                    const tripPayload = {
                        id: tripId,
                        date: currentOpDate,
                        time: time || '00:00', 
                        driverName: driverName,
                        driverId: driverDb ? driverDb.id : null,
                        pCount: parseInt(qtd),
                        isMadrugada: true, 
                        status: currentStatus,
                        isTemp: false,
                        pCountSnapshot: existingTrip?.pCountSnapshot || null
                    };

                    db.ref(`trips/${tripId}`).update(tripPayload);
                } else {
                    const existingTrip = data.trips.find(t => t.id === tripId);
                    if (existingTrip && existingTrip.status !== 'Finalizada') {
                         db.ref(`trips/${tripId}`).remove();
                    }
                }
            };

            const toggleMadrugadaRiscado = (vaga) => {
                const current = madrugadaData[vaga] || {};
                const isRiscado = !!current.riscado;
                
                if (!isRiscado) {
                    setVagaToBlock(vaga);
                    setTempJustification('');
                    setModal('madrugadaBlock');
                } else {
                    const updated = { ...current, riscado: false, comment: '' };
                    db.ref(`daily_tables/${currentOpDate}/madrugada/${vaga}`).update(updated);
                }
            };
            
            const confirmMadrugadaBlock = () => {
                if (!vagaToBlock) return;
                const current = madrugadaData[vagaToBlock] || {};
                
                const updated = { ...current, riscado: true, comment: tempJustification };
                db.ref(`daily_tables/${currentOpDate}/madrugada/${vagaToBlock}`).update(updated);
                
                setModal(null);
                setVagaToBlock(null);
            };
            
            const addMadrugadaVaga = () => {
                setTempVagaMadrugada('');
                setModal('madrugadaVaga');
            };

            const confirmAddMadrugadaVaga = () => {
                const vaga = tempVagaMadrugada;
                if(!vaga) return alert("Digite o n√∫mero da vaga.");
                
                const driver = spList.find(d => d.vaga === vaga);
                if(!driver) return alert("Essa vaga n√£o existe na tabela geral.");
                
                const newList = [...madrugadaList, vaga];
                const uniqueList = [...new Set(newList)];
                
                db.ref('madrugada_config/list').set(uniqueList);
                setModal(null);
            };

            const removeMadrugadaVaga = (vagaToRemove) => {
                if(!confirm(`Remover vaga ${vagaToRemove} da madrugada permanentemente?`)) return;
                const newList = madrugadaList.filter(v => v !== vagaToRemove);
                db.ref('madrugada_config/list').set(newList);
            };
            
            const saveDriverName = (vaga) => {
                if(!tempName.trim()) return;
                const newList = spList.map(d => d.vaga === vaga ? { ...d, name: tempName } : d);
                db.ref('drivers_table_list').set(newList);
                setEditName(null);
            };

            /* --- CANNED MESSAGES HANDLERS --- */
            const addCannedMessage = () => {
                const newMsg = { id: generateUniqueId(), title: 'Nova Mensagem', text: '' };
                const newList = [...cannedMessages, newMsg];
                db.ref('canned_messages_config/list').set(newList);
            };

            const updateCannedMessage = (id, field, value) => {
                const newList = cannedMessages.map(m => m.id === id ? { ...m, [field]: value } : m);
                db.ref('canned_messages_config/list').set(newList);
            };

            const deleteCannedMessage = (id) => {
                if(!confirm('Excluir esta mensagem?')) return;
                const newList = cannedMessages.filter(m => m.id !== id);
                db.ref('canned_messages_config/list').set(newList);
            };

            /* --- DRAG AND DROP LOGIC --- */
            
            const handleDragStart = (e, index) => { e.dataTransfer.setData("text/plain", index); };
            const handleDrop = (e, dropIndex) => {
                const dragIndex = parseInt(e.dataTransfer.getData("text/plain"));
                if (dragIndex === dropIndex) return;
                const newLousa = [...lousaOrder];
                const [removed] = newLousa.splice(dragIndex, 1);
                newLousa.splice(dropIndex, 0, removed);
                db.ref(`daily_tables/${currentOpDate}`).update({ lousaOrder: newLousa });
            };

            const handleMadrugadaDragStart = (e, index) => { e.dataTransfer.setData("madIndex", index); };
            const handleMadrugadaDrop = (e, dropIndex) => {
                const dragIndex = parseInt(e.dataTransfer.getData("madIndex"));
                if (isNaN(dragIndex) || dragIndex === dropIndex) return;
                const newList = [...madrugadaList];
                const [removed] = newList.splice(dragIndex, 1);
                newList.splice(dropIndex, 0, removed);
                db.ref('madrugada_config/list').set(newList);
            };

            const handleCannedDragStart = (e, index) => { e.dataTransfer.setData("cannedIndex", index); };
            const handleCannedDrop = (e, dropIndex) => {
                const dragIndex = parseInt(e.dataTransfer.getData("cannedIndex"));
                if (isNaN(dragIndex) || dragIndex === dropIndex) return;
                const newList = [...cannedMessages];
                const [removed] = newList.splice(dragIndex, 1);
                newList.splice(dropIndex, 0, removed);
                db.ref('canned_messages_config/list').set(newList);
            };

            // CONTROLE DO TOUR
            const handleNextStep = () => {
                if (tourStep < TOUR_STEPS.length - 1) {
                    const nextStep = TOUR_STEPS[tourStep + 1];
                    setTourStep(prev => prev + 1);
                    if (nextStep.view) setView(nextStep.view); // Troca de aba automaticamente
                } else {
                    handleCloseTour();
                }
            };

            const handlePrevStep = () => {
                if (tourStep > 0) {
                    const prevStep = TOUR_STEPS[tourStep - 1];
                    setTourStep(prev => prev - 1);
                    if (prevStep.view) setView(prevStep.view);
                }
            };

            const handleCloseTour = () => {
                setRunTour(false);
                setTourStep(0);
                setView('dashboard'); // Volta pro inicio
                if(user) localStorage.setItem(`tour_seen_${user.username}`, 'true');
            };
            
            const restartTour = () => {
                setTourStep(0);
                setView('dashboard');
                setRunTour(true);
            };

            // HANDLERS PARA DRAG AND DROP DO MENU
            const handleMenuDragStart = (e, index) => { 
                e.dataTransfer.setData("menuIndex", index); 
                // Efeito visual leve
                e.target.style.opacity = '0.5';
            };
            
            const handleMenuDragEnd = (e) => {
                e.target.style.opacity = '1';
            };

            const handleMenuDrop = (e, dropIndex) => {
                e.preventDefault();
                e.target.style.opacity = '1';
                
                const dragIndex = parseInt(e.dataTransfer.getData("menuIndex"));
                if (isNaN(dragIndex) || dragIndex === dropIndex) return;
                
                const newList = [...orderedMenuItems];
                const [removed] = newList.splice(dragIndex, 1);
                newList.splice(dropIndex, 0, removed);
                
                setOrderedMenuItems(newList);
                
                // Salva a nova ordem (apenas IDs) no Firebase do usu√°rio
                const newOrderIds = newList.map(i => i.id);
                dbOp('update', 'preferences', { menuOrder: newOrderIds });
            };

            const handleTouchStart = (e, index, listType) => {
                const touch = e.touches[0];
                touchStartPos.current = { x: touch.clientX, y: touch.clientY };
                
                if (timerRef.current) clearTimeout(timerRef.current);

                timerRef.current = setTimeout(() => {
                    setDraggedItem({ index, listType });
                    if (navigator.vibrate) navigator.vibrate(50); 
                }, 800); // Reduzi um pouco o tempo para ficar mais responsivo (800ms)
            };

            const handleTouchMove = (e) => {
                const touch = e.touches[0];
                const dx = Math.abs(touch.clientX - touchStartPos.current.x);
                const dy = Math.abs(touch.clientY - touchStartPos.current.y);

                if (!draggedItem && (dx > 5 || dy > 5)) {
                    if (timerRef.current) {
                        clearTimeout(timerRef.current);
                        timerRef.current = null;
                    }
                }
                
                if (draggedItem) {
                    if (e.cancelable) e.preventDefault(); 
                }
            };

            const handleTouchEnd = (e, dropIndex, listType) => {
                if (timerRef.current) {
                    clearTimeout(timerRef.current);
                    timerRef.current = null;
                }

                if (!draggedItem || draggedItem.listType !== listType) {
                    setDraggedItem(null);
                    return;
                }
                
                if (draggedItem.index === dropIndex) {
                    setDraggedItem(null);
                    return;
                }

                if (listType === 'lousa') {
                    const newLousa = [...lousaOrder];
                    const [removed] = newLousa.splice(draggedItem.index, 1);
                    newLousa.splice(dropIndex, 0, removed);
                    db.ref(`daily_tables/${currentOpDate}`).update({ lousaOrder: newLousa });
                } else if (listType === 'madrugada') {
                    const newList = [...madrugadaList];
                    const [removed] = newList.splice(draggedItem.index, 1);
                    newList.splice(dropIndex, 0, removed);
                    db.ref('madrugada_config/list').set(newList);
                } else if (listType === 'canned') {
                    const newList = [...cannedMessages];
                    const [removed] = newList.splice(draggedItem.index, 1);
                    newList.splice(dropIndex, 0, removed);
                    db.ref('canned_messages_config/list').set(newList);
                } else if (listType === 'menu') {
                    const newList = [...orderedMenuItems];
                    const [removed] = newList.splice(draggedItem.index, 1);
                    
                    // No mobile, se soltar fora, pode dar dropIndex -1
                    if(dropIndex >= 0) {
                        newList.splice(dropIndex, 0, removed);
                        setOrderedMenuItems(newList);
                        const newOrderIds = newList.map(i => i.id);
                        dbOp('update', 'preferences', { menuOrder: newOrderIds });
                    }
                }
                
                setDraggedItem(null);
            };

            /* SWIPE HANDLERS FOR TABLE TABS */
            const onTouchStartTable = (e) => {
                setSwipeEnd(null);
                setSwipeStart(e.targetTouches[0].clientX);
            }

            const onTouchMoveTable = (e) => {
                setSwipeEnd(e.targetTouches[0].clientX);
            }

            const onTouchEndTable = () => {
                if (!swipeStart || !swipeEnd) return;
                
                if (draggedItem) return;

                const distance = swipeStart - swipeEnd;
                const minSwipeDistance = 50;
                const isLeftSwipe = distance > minSwipeDistance;
                const isRightSwipe = distance < -minSwipeDistance;
                
                const tabs = ['geral', 'confirmados', 'lousa', 'madrugada', 'mensagens'];
                const currentIndex = tabs.indexOf(tableTab);
                
                if (isLeftSwipe) {
                    if (currentIndex < tabs.length - 1) {
                        setTableTab(tabs[currentIndex + 1]);
                    }
                } else if (isRightSwipe) {
                    if (currentIndex > 0) {
                        setTableTab(tabs[currentIndex - 1]);
                    }
                }
            }

            /* --- GLOBAL MENU SWIPE (NOVO) --- */
            const globalTouchRef = useRef({ x: 0, y: 0 });

            const handleGlobalTouchStart = (e) => {
                // Bloqueia se estiver na tabela (j√° tem swipe pr√≥prio) ou se o menu j√° estiver aberto
                if (view === 'table' || menuOpen) return;
                
                // Salva a posi√ß√£o inicial do toque
                globalTouchRef.current = { 
                    x: e.touches[0].clientX, 
                    y: e.touches[0].clientY 
                };
            };

            const handleGlobalTouchEnd = (e) => {
                // Bloqueia na tabela, se estiver arrastando item ou menu j√° aberto
                if (view === 'table' || draggedItem || menuOpen) return;
                
                const endX = e.changedTouches[0].clientX;
                const endY = e.changedTouches[0].clientY;
                
                const diffX = endX - globalTouchRef.current.x;
                const diffY = Math.abs(endY - globalTouchRef.current.y);

                // L√≥gica: 
                // 1. Arraste horizontal para direita > 80px
                // 2. Movimento vertical pequeno (< 60px) para n√£o confundir com scroll
                if (diffX > 80 && diffY < 60) {
                    setMenuOpen(true);
                }
            };


            /* AI FUNCTIONS */
            const handleSmartCreate = async () => {
                if(!aiInput.trim()) return alert("Diga algo!");
                if(!geminiKey) return alert("Configure a API Key nas configura√ß√µes.");
                setAiLoading(true);
                try {
                    const bairros = BAIRROS.join(',');
                    // ATUALIZA√á√ÉO NO PROMPT:
                    // 1. Adicionado pedido expl√≠cito de 'luggageCount'.
                    // 2. Refor√ßada a regra de pagamento para retornar exatamente um dos valores permitidos.
                    const prompt = `Analise este texto: "${aiInput}". Extraia um JSON ESTRITAMENTE V√ÅLIDO (sem markdown, sem crases) com: name, phone, neighborhood (escolha o mais pr√≥ximo de: ${bairros}), address, reference, passengerCount (n√∫mero, padr√£o 1), luggageCount (n√∫mero de malas, padr√£o 0), payment (Escolha EXATAMENTE um: "Dinheiro", "Pix" ou "Cart√£o"), time (HH:mm). Se faltar info, use null. Exemplo de sa√≠da: {"name": "Jo√£o", ...}`;
                    
                    const res = await callGemini(prompt, geminiKey);
                    
                    const cleanJson = res.replace(/```json/g, '').replace(/```/g, '').trim();
                    const json = JSON.parse(cleanJson);

                    // CORRE√á√ÉO E PADRONIZA√á√ÉO DOS DADOS
                    // Garante que o pagamento seja um dos v√°lidos, sen√£o define 'Dinheiro'
                    const validPayments = ['Dinheiro', 'Pix', 'Cart√£o'];
                    let finalPayment = 'Dinheiro';
                    
                    if (json.payment) {
                        // Tenta encontrar o pagamento correspondente ignorando mai√∫sculas/min√∫sculas
                        const found = validPayments.find(p => p.toLowerCase() === json.payment.toLowerCase());
                        if (found) finalPayment = found;
                    }

                    setFormData({
                        ...json,
                        payment: finalPayment, // Usa o valor padronizado
                        luggageCount: json.luggageCount || 0, // Usa o valor da IA ou 0
                        status: 'Ativo', 
                        date: getTodayDate()
                    });
                    
                    setAiModal(false); 
                    setModal('passenger'); 
                    setAiInput('');
                } catch(e) { alert("Erro IA: " + e.message); console.error(e); }
                finally { setAiLoading(false); }
            };

            const toggleMic = () => {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognition) return alert("Seu navegador n√£o suporta reconhecimento de voz.");
                if (isListening) { if (recognitionRef.current) recognitionRef.current.stop(); setIsListening(false); return; }
                const recognition = new SpeechRecognition();
                recognition.lang = 'pt-BR'; recognition.continuous = false; recognition.interimResults = false;
                recognition.onstart = () => setIsListening(true);
                recognition.onresult = (e) => { setAiInput(prev => (prev ? prev + ' ' : '') + e.results[0][0].transcript); setIsListening(false); };
                recognition.onerror = (e) => { console.error("Erro voz:", e); setIsListening(false); };
                recognition.onend = () => setIsListening(false);
                recognition.start(); recognitionRef.current = recognition;
            };

            /* Handlers */
            const save = (col) => {
                if(col === 'passengers' && !formData.name) return alert('Nome obrigat√≥rio');
                if(col === 'drivers' && !formData.name) return alert('Nome obrigat√≥rio');
                if (col === 'drivers' && !formData.status) formData.status = 'Ativo';
                dbOp(formData.id?'update':'create', col, formData); setModal(null);
            };

            const saveExtraCharge = () => {
                if (!formData.value || !formData.date) return alert("Valor e Data s√£o obrigat√≥rios.");
                
                const payload = {
                    id: formData.id || generateUniqueId(),
                    isExtra: true,
                    driverName: 'Carro Extra', // Identificador padr√£o
                    extraPhone: formData.phone, // WhatsApp do carro extra
                    value: formData.value,
                    date: formData.date,
                    time: '12:00', // Hor√°rio fict√≠cio para ordena√ß√£o
                    notes: formData.notes,
                    paymentStatus: 'Pendente',
                    status: 'Finalizada', // Para n√£o aparecer como viagem em andamento
                    pCount: 0 // Sem passageiros vinculados diretamente
                };
                
                dbOp(payload.id ? 'update' : 'create', 'trips', payload);
                setModal(null);
            };

            const saveNote = () => { if(!noteText.trim()) return; dbOp('create', 'notes', { text: noteText, completed: false }); setNoteText(''); };
            
            const del = (col, id) => { 
                // Regra de seguran√ßa para Operadores
                if (user && user.role === 'operador' && col === 'passengers') {
                    if (paxDeleteSessionCount >= 5) return alert('üîí SEGURAN√áA: Limite de exclus√£o de passageiros atingido nesta sess√£o.');
                    if(confirm('Excluir este item permanentemente?')) { dbOp('delete', col, id); setPaxDeleteSessionCount(prev => prev + 1); } return;
                }

                // --- CORRE√á√ÉO: Exclus√£o de Viagem Madrugada (Virtual) ---
                // Intercepta IDs que come√ßam com 'mad_' na cole√ß√£o de viagens
                if (col === 'trips' && typeof id === 'string' && id.startsWith('mad_')) {
                    if(!confirm('Excluir este registro da Madrugada?')) return;
                    
                    const parts = id.split('_'); // Formato: mad_YYYY-MM-DD_VAGA
                    if (parts.length === 3) {
                        const dateKey = parts[1];
                        const vagaKey = parts[2];
                        
                        // Remove do n√≥ correto no Firebase (daily_tables)
                        db.ref(`daily_tables/${dateKey}/madrugada/${vagaKey}`).remove();
                        
                        // Atualiza√ß√£o Otimista da Interface (remove o item da lista sem esperar reload)
                        setMonthlyMadrugada(prev => {
                            const newState = { ...prev };
                            if (newState[dateKey] && newState[dateKey].madrugada) {
                                const newMad = { ...newState[dateKey].madrugada };
                                delete newMad[vagaKey];
                                newState[dateKey] = { ...newState[dateKey], madrugada: newMad };
                            }
                            return newState;
                        });
                    }
                    return; // Interrompe para n√£o tentar deletar de 'trips'
                }

                // CORRE√á√ÉO: Restaurar agendamento ao excluir viagem finalizada
                if (col === 'trips') {
                    const trip = data.trips.find(t => t.id === id);
                    
                    // Se a viagem estava finalizada, os passageiros tiveram o hor√°rio limpo anteriormente.
                    // Precisamos restaurar esses dados para que eles voltem para a aba "Agendamentos".
                    if (trip && trip.status === 'Finalizada' && trip.passengerIds && Array.isArray(trip.passengerIds)) {
                        if(confirm('Excluir viagem finalizada? Os passageiros voltar√£o para a lista de Agendamentos (Pendentes).')) {
                            
                            // Restaura data e hora nos passageiros baseando-se na viagem exclu√≠da
                            trip.passengerIds.forEach(pid => {
                                db.ref(`passengers/${pid}`).update({ 
                                    time: trip.time, 
                                    date: trip.date 
                                });
                            });
                            
                            dbOp('delete', col, id);
                        }
                        return; // Interrompe para n√£o cair no confirm padr√£o abaixo
                    }
                }

                if(confirm('Excluir este item permanentemente?')) dbOp('delete', col, id); 
            };
            
            const changeTheme = (t) => { setThemeKey(t); if(user) { dbOp('update', 'preferences', { theme: t }); localStorage.setItem(`${user.username}_nexflow_theme`, t); } };
            const saveApiKey = (k) => { setGeminiKey(k); localStorage.setItem('nexflow_gemini_key', k); };
            
            const copyToClip = (txt) => {
                const textArea = document.createElement("textarea"); textArea.value = txt; textArea.style.position = "fixed"; document.body.appendChild(textArea); textArea.focus(); textArea.select();
                try { document.execCommand('copy'); alert(`Texto copiado!`); } catch (err) { prompt("Copie:", txt); } document.body.removeChild(textArea);
            };
            const copyPassengerData = (p) => { copyToClip(`*PASSAGEIRO*\n‚Ä¢ Nome: ${p.name}\n‚Ä¢ Tel: ${p.phone}\n‚Ä¢ End: ${p.address}\n‚Ä¢ Ref: ${p.reference||''}\n‚Ä¢ Bairro: ${p.neighborhood}\n‚Ä¢ Pagamento: ${p.payment}\n‚Ä¢ Data: ${formatDisplayDate(p.date)} - ${p.time}\n‚Ä¢ Qtd: ${p.passengerCount} pessoa(s)`); };
            const copyDaySummary = () => {
                const dayTrips = data.trips.filter(t => t.date === selectedDate).sort((a,b) => (a.time||'').localeCompare(b.time||''));
                if (dayTrips.length === 0) return alert("Nenhuma viagem neste dia.");
                let summary = `üìÖ RESUMO DO DIA ${formatDisplayDate(selectedDate)}\n\n`;
                dayTrips.forEach(t => { const pList = data.passengers.filter(p=>(t.passengerIds||[]).includes(p.id)); summary += `‚è∞ ${t.time} - ${t.driverName} (${t.status})\n`; pList.forEach(p => summary += `  - ${p.name} (${p.neighborhood})\n`); summary += `\n`; });
                copyToClip(summary);
            };
            const callPhone = (ph) => { if(!ph) return alert("Sem n√∫mero"); window.location.href = `tel:${ph.replace(/\D/g,'')}`; }
            
            const isBusy = (pid, date, time) => data.trips.some(t => t.date === date && t.time === time && t.status !== 'Cancelada' && (t.passengerIds||[]).map(String).includes(String(pid)) && t.id !== editingTripId);
            const getPaxIdx = (l) => l.sort((a,b) => (b.passengerCount - a.passengerCount) || (getBairroIdx(a.neighborhood) - getBairroIdx(b.neighborhood)));

            const simulate = () => {
                const driver = data.drivers.find(d=>d.id==formData.driverId); 
                const time = formData.time; 
                const date = formData.date || getTodayDate(); 
                
                if(!driver || !time) return alert('Selecione Motorista e Hor√°rio');
                
                // CORRE√á√ÉO: Tratamento de hor√°rio para Madrugada (Intervalos)
                // Se for "04:00/04:45", busca passageiros de "04:00"
                let targetPaxTime = time;
                if (formData.isMadrugada && time.includes('/')) {
                    targetPaxTime = time.split('/')[0];
                }

                let pool = data.passengers.filter(p => p.status==='Ativo' && p.date === date && p.time === targetPaxTime && !isBusy(p.id, date, time) );
                pool = getPaxIdx(pool);
                let current = [], cap = 0;
                for (const p of pool) { if (cap + parseInt(p.passengerCount) <= driver.capacity) { current.push(p); cap += parseInt(p.passengerCount); } }
                current.sort((a,b)=>getBairroIdx(a.neighborhood)-getBairroIdx(b.neighborhood));
                setSuggestedTrip({ driver, time, passengers: current, occupancy: cap, date });
            };

            const autoFill = () => {
                if(!suggestedTrip) return;
                const tripDate = formData.date || suggestedTrip.date || getTodayDate(); 
                const tripTime = formData.time || suggestedTrip.time;
                
                // CORRE√á√ÉO: Tratamento de hor√°rio para Madrugada (Intervalos)
                let targetPaxTime = tripTime;
                if (formData.isMadrugada && tripTime.includes('/')) {
                    targetPaxTime = tripTime.split('/')[0];
                }

                let pool = data.passengers.filter(p => p.status==='Ativo' && p.date === tripDate && p.time === targetPaxTime && !isBusy(p.id, tripDate, tripTime) && !suggestedTrip.passengers.find(x=>x.id===p.id));
                pool = getPaxIdx(pool);
                let current = [...suggestedTrip.passengers], cap = suggestedTrip.occupancy;
                for(const p of pool) { if(cap + parseInt(p.passengerCount) <= suggestedTrip.driver.capacity) { current.push(p); cap += parseInt(p.passengerCount); } }
                current.sort((a,b)=>getBairroIdx(a.neighborhood)-getBairroIdx(b.neighborhood));
                setSuggestedTrip({...suggestedTrip, passengers: current, occupancy: cap, date: tripDate});
            };

            const addById = () => {
                const term = searchId.toString().trim();
                if (!term) return alert("Digite um ID ou Nome para adicionar.");

                const tripDate = formData.date || suggestedTrip.date; 
                const tripTime = formData.time || suggestedTrip.time;
                
                const p = data.passengers.find(x => (x.id && x.id === term) || (x.name && x.name.toLowerCase().includes(term.toLowerCase())));
                
                if(!p) return alert('N√£o encontrado');
                if(isBusy(p.id, tripDate, tripTime)) return alert(`Passageiro j√° em viagem`);
                if(suggestedTrip.passengers.find(x=>x.id==p.id)) return alert('J√° na lista');
                if(suggestedTrip.occupancy + parseInt(p.passengerCount) > suggestedTrip.driver.capacity) return alert('Sem vaga');
                
                const nw = [...suggestedTrip.passengers, p].sort((a,b)=>getBairroIdx(a.neighborhood)-getBairroIdx(b.neighborhood));
                setSuggestedTrip({...suggestedTrip, passengers: nw, occupancy: suggestedTrip.occupancy + parseInt(p.passengerCount)});
                setSearchId('');
            };

            const removePax = (pid) => {
                const nw = suggestedTrip.passengers.filter(x => String(x.id) !== String(pid));
                const removed = suggestedTrip.passengers.find(x => String(x.id) === String(pid));
                if (removed) setSuggestedTrip({...suggestedTrip, passengers:nw, occupancy:suggestedTrip.occupancy-parseInt(removed.passengerCount)});
            };
            
            const clearPaxSchedule = (pid) => {
                if(confirm("Remover o hor√°rio deste passageiro? Ele sair√° da lista de agendamentos.")) {
                    dbOp('update', 'passengers', { id: pid, time: '' });
                }
            };

            const confirmTrip = () => {
                const driver = data.drivers.find(d => d.id === formData.driverId);
                if (!driver) return alert("Selecione um motorista v√°lido.");
                
                // CORRE√á√ÉO: Preservar status original se for edi√ß√£o
                let statusToSave = 'Em andamento';
                let isTemp = false;

                if (editingTripId) {
                    const originalTrip = data.trips.find(t => t.id === editingTripId);
                    if (originalTrip) {
                        statusToSave = originalTrip.status;
                        isTemp = false; 
                    }
                }

                // C√ÅLCULO DO SNAPSHOT COMPLETO (DADOS + QUANTIDADE)
                const passengersSnapshot = suggestedTrip.passengers.map(p => ({
                    id: p.id,
                    name: p.name,
                    neighborhood: p.neighborhood,
                    passengerCount: parseInt(p.passengerCount || 1),
                    address: p.address,
                    reference: p.reference
                }));

                const totalPaxSnapshot = passengersSnapshot.reduce((acc, p) => acc + p.passengerCount, 0);
                const tripDate = formData.date || getTodayDate();
                const tripTime = suggestedTrip.time;

                // PAYLOAD BASE
                const pl = { 
                    driverId: driver.id, 
                    driverName: driver.name, 
                    time: tripTime, 
                    passengerIds: suggestedTrip.passengers.map(p=>p.id), 
                    date: tripDate, 
                    status: statusToSave, 
                    isTemp: isTemp,
                    passengersSnapshot: passengersSnapshot,
                    pCountSnapshot: totalPaxSnapshot
                };

                // L√ìGICA ESPEC√çFICA PARA MADRUGADA
                if (formData.isMadrugada) {
                    // Encontra a vaga associada ao motorista para gerar o ID correto e sincronizar com a tabela
                    const spDriver = spList.find(s => s.name === driver.name);
                    if (!spDriver) return alert("Erro: Motorista n√£o vinculado a uma vaga na tabela.");
                    
                    const vaga = spDriver.vaga;
                    // ID padronizado para vincular viagem e tabela
                    const tripId = `mad_${tripDate}_${vaga}`;
                    
                    pl.id = tripId;
                    pl.isMadrugada = true;
                    // Madrugada pode usar pCount direto se necess√°rio, mas o snapshot √© o principal
                    pl.pCount = totalPaxSnapshot; 
                    
                    // 1. Salva/Atualiza a viagem na cole√ß√£o principal de trips
                    db.ref(`trips/${tripId}`).update(pl);

                    // 2. Atualiza a Tabela da Madrugada (Sincroniza√ß√£o Visual na aba Tabela)
                    db.ref(`daily_tables/${tripDate}/madrugada/${vaga}`).update({
                        qtd: totalPaxSnapshot,
                        time: tripTime
                    });

                } else {
                    // VIAGEM NORMAL
                    pl.id = editingTripId; // Se for edi√ß√£o, usa o ID existente. Se novo, dbOp cria.
                    dbOp(editingTripId ? 'update' : 'create', 'trips', pl); 
                }
                
                setModal(null); 
                setSuggestedTrip(null);
            };

            const openEditTrip = (t) => {
                // Se for Madrugada, a l√≥gica de carga √© ligeiramente diferente (n√£o tem passengerIds nominais)
                const dr = data.drivers.find(d=>d.id===t.driverId); 
                
                let pax = [];
                let occ = 0;

                if (t.isMadrugada) {
                     // Para madrugada, n√£o temos passageiros nominais, apenas quantidade.
                     // Vamos simular passageiros "An√¥nimos" para preencher a lista visual se necess√°rio,
                     // ou apenas confiar no contador do modal.
                     // Mas o modal atual espera uma lista de passageiros para calcular ocupa√ß√£o.
                     occ = parseInt(t.pCountSnapshot || t.pCount || 0);
                     // Criamos 'occ' passageiros dummy para o modal refletir a quantidade
                     for(let i=0; i<occ; i++) {
                         pax.push({ id: `dummy_${i}`, name: 'Passageiro Madrugada', neighborhood: 'Madrugada', passengerCount: 1 });
                     }
                } else {
                    if (t.passengersSnapshot) {
                        pax = t.passengersSnapshot;
                    } else {
                        pax = data.passengers.filter(p=>(t.passengerIds||[]).includes(p.id));
                    }
                    occ = pax.reduce((a,b)=>a+parseInt(b.passengerCount||1),0);
                }
                
                // Preenche formData incluindo a flag isMadrugada se for o caso
                setFormData({
                    driverId: t.driverId, 
                    time: t.time, 
                    date: t.date,
                    isMadrugada: !!t.isMadrugada 
                }); 
                
                setEditingTripId(t.id);
                setSuggestedTrip({ 
                    driver: dr || {name: 'Desconhecido', capacity: 0}, 
                    time: t.time, 
                    passengers: pax, 
                    occupancy: occ, 
                    date: t.date 
                });
                
                setModal('trip');
            };
            
            // Fun√ß√£o auxiliar para abrir o modal de viagem preenchido para Madrugada (vinda da tabela)
            const openMadrugadaTrip = (vaga) => {
                const driverSp = spList.find(d => d.vaga === vaga);
                if (!driverSp) return;
                const driverDb = data.drivers.find(d => d.name === driverSp.name);
                
                if (!driverDb) return alert("Motorista desta vaga n√£o cadastrado no sistema.");

                const tripId = `mad_${currentOpDate}_${vaga}`;
                const existingTrip = data.trips.find(t => t.id === tripId);

                if (existingTrip) {
                    openEditTrip(existingTrip);
                } else {
                    // Nova viagem de madrugada - Abre no FORMUL√ÅRIO para escolher hor√°rio
                    setFormData({
                        driverId: driverDb.id,
                        date: currentOpDate,
                        time: '04:00', // Hor√°rio padr√£o sugestivo
                        isMadrugada: true
                    });
                    // Deixa null para for√ßar a tela de sele√ß√£o de hor√°rio/rota
                    setSuggestedTrip(null); 
                    setEditingTripId(null);
                    setModal('trip');
                }
            };

            const handleCreateTripFromPax = (p) => {
                setFormData({ driverId: '', time: p.time, date: p.date });
                setSuggestedTrip({ driver: { name: 'Selecione', capacity: 0 }, time: p.time, passengers: [p], occupancy: parseInt(p.passengerCount || 1), date: p.date });
                setEditingTripId(null); setModal('trip');
            };

            const sendWhatsapp = (trip) => {
                const d = data.drivers.find(x => x.id === trip.driverId); 
                
                // Usa Snapshot se dispon√≠vel
                let p = [];
                if (trip.passengersSnapshot) {
                    p = trip.passengersSnapshot;
                } else {
                    p = data.passengers.filter(x => (trip.passengerIds||[]).includes(x.id));
                }

                if (!d || !d.phone) return alert('Motorista sem telefone.');
                const msg = encodeURIComponent(generateWhatsappMessage(trip.id, p, d.name, trip.time, trip.date));
                window.open(`https://wa.me/55${d.phone.replace(/\D/g,'')}?text=${msg}`, '_blank');
            };

            // FUN√á√ÉO PARA GERAR RESUMO DO M√äS (HIST√ìRICO)
            const generateMonthSummary = () => {
                const targetMonth = historyDate.getMonth();
                const targetYear = historyDate.getFullYear();
                
                const monthTrips = data.trips.filter(t => {
                    if(!t.date) return false;
                    const [y, m, d] = t.date.split('-').map(Number);
                    return (m - 1) === targetMonth && y === targetYear;
                });

                const totalTrips = monthTrips.length;
                const cancelledTrips = monthTrips.filter(t => t.status === 'Cancelada').length;
                
                const validTrips = monthTrips.filter(t => t.status !== 'Cancelada');
                const totalPax = validTrips.reduce((acc, t) => {
                    // L√ìGICA DE SNAPSHOT NO RESUMO
                    let pCount = 0;
                    if (t.pCountSnapshot !== undefined && t.pCountSnapshot !== null) {
                        pCount = parseInt(t.pCountSnapshot);
                    } else {
                        pCount = data.passengers.filter(p => (t.passengerIds || []).includes(p.id))
                                                  .reduce((a, b) => a + parseInt(b.passengerCount || 1), 0);
                    }
                    return acc + pCount;
                }, 0);

                const monthName = historyDate.toLocaleDateString('pt-BR', {month:'long', year:'numeric'});
                
                const summary = `üìä RESUMO DE ${monthName.toUpperCase()}\n\n` +
                                `üöê Total de Viagens: ${totalTrips}\n` +
                                `üë• Total de Passageiros: ${totalPax}\n` +
                                `üö´ Canceladas: ${cancelledTrips}`;
                
                const blob = new Blob([summary], { type: 'text/plain' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Resumo_${monthName.replace(/ /g, '_')}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            };

            // Ao atualizar status manualmente (Finalizar/Cancelar), tamb√©m tornamos permanente (isTemp: false)
            // Se for CANCELAR uma tempor√°ria, deleta de vez.
            const updateTripStatus = (id, status) => { 
                const trip = data.trips.find(t => t.id === id);
                if (!trip) return;

                if (trip.isTemp && status === 'Cancelada') {
                    db.ref('trips').child(id).remove();
                } else {
                    const updates = { status, isTemp: false };
                    
                    // CORRE√á√ÉO CR√çTICA: GARANTIA DE SNAPSHOT AO FINALIZAR
                    if (status === 'Finalizada') {
                        // Se for Madrugada, o snapshot √© o pCount atual (n√£o tem lista de passageiros)
                        if (trip.isMadrugada) {
                            if (trip.pCountSnapshot === undefined || trip.pCountSnapshot === null) {
                                updates.pCountSnapshot = parseInt(trip.pCount || 0);
                            }
                        } 
                        // Viagem normal sem snapshot: cria agora
                        else if (trip.pCountSnapshot === undefined || trip.pCountSnapshot === null) {
                            const currentTotal = data.passengers
                                .filter(p => (trip.passengerIds || []).includes(p.id))
                                .reduce((acc, p) => acc + parseInt(p.passengerCount || 1), 0);
                            updates.pCountSnapshot = parseInt(currentTotal);
                        }

                        // Limpa o hor√°rio do cadastro dos passageiros (apenas viagens normais)
                        if (trip.passengerIds && Array.isArray(trip.passengerIds)) {
                            trip.passengerIds.forEach(pid => {
                                db.ref(`passengers/${pid}`).update({ time: '' });
                            });
                        }
                    }

                    db.ref('trips').child(id).update(updates);
                }
            };

            const duplicateTrip = (t) => { if(!confirm('Duplicar esta viagem para hoje?')) return; dbOp('create', 'trips', { ...t, id: null, date: getTodayDate(), status: 'Ativo', isTemp: false }); };

            const stats = useMemo(() => {
                const pay = {}; const b = {};
                data.passengers.forEach(x => { if(x.status==='Ativo') { pay[x.payment] = (pay[x.payment]||0)+1; b[x.neighborhood] = (b[x.neighborhood]||0)+1; } });
                return { p: Object.entries(pay).map(([l,v])=>({label:l,value:v})), b: Object.entries(b).map(([l,v])=>({label:l,value:v})).sort((a,b)=>b.value-a.value).slice(0,5) };
            }, [data]);

            const filteredList = useMemo(() => {
                let list = data[view] || [];
                if(filterStatus === 'Ativo' && view !== 'lostFound') list = list.filter(i => !i.status || i.status === 'Ativo'); 
                if (searchTerm) {
                    const lower = searchTerm.toLowerCase().trim();
                    const exactIdMatch = list.find(item => String(item.id) === lower);
                    if (exactIdMatch) return [exactIdMatch];
                    list = list.filter(item => (item.name && item.name.toLowerCase().includes(lower)) || (item.neighborhood && item.neighborhood.toLowerCase().includes(lower)) || (item.phone && item.phone.includes(lower)) || (item.description && item.description.toLowerCase().includes(lower)) || (String(item.id).toLowerCase().includes(lower)));
                }
                return list;
            }, [data, view, filterStatus, searchTerm]);

            // CORRE√á√ÉO: Aplicando filtro de busca (searchTerm) nas listas de viagens
            const activeTrips = useMemo(() => {
                let list = data.trips.filter(t => t.status === 'Em andamento' || t.status === 'Ativo');
                if (searchTerm && view === 'trips') {
                    const lower = searchTerm.toLowerCase().trim();
                    list = list.filter(t => String(t.id).includes(lower) || (t.driverName && t.driverName.toLowerCase().includes(lower)));
                }
                return list.sort((a,b) => parseInt(b.id) - parseInt(a.id));
            }, [data.trips, searchTerm, view]);

            const historyTrips = useMemo(() => {
                let list = data.trips.filter(t => t.status !== 'Em andamento' && t.status !== 'Ativo');
                if (searchTerm && view === 'trips') {
                    const lower = searchTerm.toLowerCase().trim();
                    list = list.filter(t => String(t.id).includes(lower) || (t.driverName && t.driverName.toLowerCase().includes(lower)));
                }
                return list.sort((a,b) => parseInt(b.id) - parseInt(a.id));
            }, [data.trips, searchTerm, view]);

            const tripsForSelectedDate = useMemo(() => data.trips.filter(t => t.date === selectedDate).sort((a,b) => (a.time||'').localeCompare(b.time||'')), [data.trips, selectedDate]); 
            const { pendingPax, assignedPax } = useMemo(() => {
                const paxOfDay = data.passengers.filter(p => p.date === selectedDate);
                const assigned = []; const pending = [];
                paxOfDay.forEach(p => { 
                    const isAssigned = data.trips.some(t => t.date === selectedDate && t.status !== 'Cancelada' && (t.passengerIds||[]).some(id => String(id) === String(p.id))); 
                    if (isAssigned) assigned.push(p); 
                    else if (p.time) pending.push(p); 
                });
                return { 
                    pendingPax: pending.sort((a, b) => (a.time||'').localeCompare(b.time||'')), 
                    assignedPax: assigned.sort((a, b) => (a.time||'').localeCompare(b.time||'')) 
                };
            }, [data.passengers, selectedDate, data.trips]);

            // HISTORY GROUPING LOGIC
            const historyGroups = useMemo(() => {
                const targetMonth = historyDate.getMonth();
                const targetYear = historyDate.getFullYear();
                
                const filtered = historyTrips.filter(t => {
                    // AJUSTE: Se tiver termo de busca, ignora filtro de data para achar a viagem em qualquer m√™s
                    if (searchTerm && view === 'trips') return true;

                    if(!t.date) return false;
                    const [y, m, d] = t.date.split('-').map(Number);
                    return (m - 1) === targetMonth && y === targetYear;
                });

                const groups = {};
                filtered.forEach(t => {
                    if(!groups[t.date]) groups[t.date] = [];
                    groups[t.date].push(t);
                });

                const sortedDates = Object.keys(groups).sort((a, b) => b.localeCompare(a));
                
                return sortedDates.map(date => ({
                    date,
                    trips: groups[date].sort((a, b) => (b.time || '').localeCompare(a.time || ''))
                }));
            }, [historyTrips, historyDate, searchTerm, view]);

            // LOGICA DA ABA COBRAN√áA (MOVED UP FOR REACT HOOK COMPLIANCE)
            const billingData = useMemo(() => {
                if (view !== 'billing') return { groups: [], summary: { pending: 0, paid: 0, total: 0 } };
                // ... (c√≥digo existente de billingData) ...
                const targetMonth = billingDate.getMonth();
                const targetYear = billingDate.getFullYear();

                const validTrips = data.trips.filter(t => {
                    if (t.status === 'Cancelada') return false;
                    if (!t.date) return false;
                    const [y, m, d] = t.date.split('-').map(Number);
                    return (m - 1) === targetMonth && y === targetYear;
                });

                const groups = {};
                let totalPending = 0;
                let totalPaid = 0;

                validTrips.forEach(t => {
                    let value = 0;
                    let pCount = 0;

                    if (t.isExtra) {
                        value = parseFloat(t.value) || 0;
                        pCount = 0; 
                    } else if (t.isMadrugada) {
                        // L√≥gica para Madrugada (Real Trip)
                        pCount = t.pCountSnapshot !== undefined ? parseInt(t.pCountSnapshot) : parseInt(t.pCount || 0);
                        value = pCount * 4;
                    } else {
                        // L√≥gica para Viagens Normais
                        if (t.pCountSnapshot !== undefined && t.pCountSnapshot !== null) {
                            pCount = parseInt(t.pCountSnapshot);
                        } else if (t.passengersSnapshot) {
                             pCount = t.passengersSnapshot.reduce((acc, p) => acc + parseInt(p.passengerCount), 0);
                        } else {
                            pCount = data.passengers.filter(p=>(t.passengerIds||[]).includes(p.id)).reduce((a,b)=>a+parseInt(b.passengerCount||1),0);
                        }
                        value = pCount * 4; 
                    }

                    const isPaid = t.paymentStatus === 'Pago';
                    if (isPaid) totalPaid += value; else totalPending += value;

                    const dateKey = t.date; 
                    if (!groups[dateKey]) groups[dateKey] = { date: dateKey, trips: [], totalValue: 0 };
                    
                    groups[dateKey].trips.push({ ...t, pCount, value, isPaid });
                    groups[dateKey].totalValue += value;
                });

                Object.entries(monthlyMadrugada).forEach(([date, dayData]) => {
                    if (!dayData.madrugada) return;
                    const dailyDrivers = getRotatedList(date);
                    
                    Object.entries(dayData.madrugada).forEach(([vaga, mData]) => {
                        // --- CORRE√á√ÉO: EVITAR DUPLICIDADE ---
                        // Se j√° existe uma viagem real criada para esta vaga/data em 'trips', 
                        // ignoramos aqui para n√£o duplicar na cobran√ßa (o loop 'validTrips' acima j√° pegou).
                        const tripId = `mad_${date}_${vaga}`;
                        if (data.trips.some(t => t.id === tripId)) return;

                        if (mData.qtd && parseInt(mData.qtd) > 0) {
                            const driver = dailyDrivers.find(d => d.vaga === vaga);
                            const driverName = driver ? driver.name : `Vaga ${vaga}`;
                            const fullDriver = data.drivers.find(d => d.name === driverName);
                            const value = parseInt(mData.qtd) * 4; 
                            const isPaid = mData.paid === true;

                            if (isPaid) totalPaid += value; else totalPending += value;

                            const dateKey = date;
                            if (!groups[dateKey]) groups[dateKey] = { date: dateKey, trips: [], totalValue: 0 };

                            groups[dateKey].trips.push({
                                id: tripId, 
                                isMadrugada: true,
                                date: date,
                                time: mData.time || 'Madrugada',
                                driverName: driverName,
                                driverId: fullDriver ? fullDriver.id : null,
                                pCount: mData.qtd,
                                value: value,
                                isPaid: isPaid,
                                vaga: vaga, 
                                notes: mData.comment || ''
                            });
                            groups[dateKey].totalValue += value;
                        }
                    });
                });

                const sortedGroups = Object.values(groups).sort((a, b) => b.date.localeCompare(a.date));
                sortedGroups.forEach(g => {
                    g.trips.sort((a, b) => (b.time || '').localeCompare(a.time || ''));
                });

                return { 
                    groups: sortedGroups, 
                    summary: { pending: totalPending, paid: totalPaid, total: totalPending + totalPaid } 
                };
            // CORRE√á√ÉO: Adicionado 'billingDate' aqui para for√ßar recalculo ao trocar o m√™s
            }, [data.trips, data.passengers, view, billingDate, monthlyMadrugada, data.drivers]);

            const toggleHistoryDay = (date) => {
                setExpandedDays(prev => ({...prev, [date]: !prev[date]}));
            };
            
            // ... (Fun√ß√µes de navega√ß√£o de data mantidas) ...
            const prevHistoryMonth = () => setHistoryDate(new Date(historyDate.getFullYear(), historyDate.getMonth() - 1, 1));
            const nextHistoryMonth = () => setHistoryDate(new Date(historyDate.getFullYear(), historyDate.getMonth() + 1, 1));
            const prevBillingMonth = () => setBillingDate(new Date(billingDate.getFullYear(), billingDate.getMonth() - 1, 1));
            const nextBillingMonth = () => setBillingDate(new Date(billingDate.getFullYear(), billingDate.getMonth() + 1, 1));

            // ... (Calendar e RenderCalendar mantidos) ...
            const getDaysInMonth = (date) => {
                const year = date.getFullYear(); const month = date.getMonth();
                const days = new Date(year, month + 1, 0).getDate(); const firstDay = new Date(year, month, 1).getDay();
                return { days, firstDay, month, year };
            };
            const renderCalendar = () => {
                const { days, firstDay, month, year } = getDaysInMonth(calendarDate);
                const monthName = calendarDate.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                const dayElements = [];
                for(let i = 0; i < firstDay; i++) dayElements.push(<div key={`empty-${i}`} className="h-10"></div>);
                for(let i = 1; i <= days; i++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                    const isSelected = selectedDate === dateStr;
                    const hasTrip = data.trips.some(t => t.date === dateStr); const hasPax = data.passengers.some(p => p.date === dateStr);
                    dayElements.push(<button key={i} onClick={() => setSelectedDate(dateStr)} className={`h-10 w-full rounded-lg flex flex-col items-center justify-center relative transition-colors ${isSelected ? theme.primary : 'hover:bg-white/5'}`}><span className={`text-sm ${isSelected ? 'font-bold' : 'opacity-80'}`}>{i}</span><div className="flex gap-0.5 mt-0.5">{hasTrip && <div className="w-1 h-1 rounded-full bg-blue-400"></div>}{hasPax && <div className="w-1 h-1 rounded-full bg-green-400"></div>}</div></button>);
                }
                return { monthName, dayElements };
            };
            const { monthName, dayElements } = renderCalendar();

            // ... (renderContextMenu e LoginScreen check mantidos) ...
            const renderContextMenu = () => {
                if (!contextMenu) return null;
                const x = Math.min(contextMenu.x, window.innerWidth - 200);
                const y = Math.min(contextMenu.y, window.innerHeight - 250);

                return (
                    <div 
                        className={`fixed z-[9999] w-52 ${theme.card} ${theme.border} border shadow-2xl rounded-xl py-2 flex flex-col anim-fade`}
                        style={{ top: y, left: x }}
                    >
                        <div className="px-4 py-2 text-xs font-bold opacity-50 uppercase tracking-wider border-b border-white/10 mb-1">Acesso R√°pido</div>
                        <button onClick={() => { setAiModal(true); setContextMenu(null); }} className="px-4 py-2.5 text-left hover:bg-white/10 flex items-center gap-3 text-sm transition-colors text-amber-400 font-bold">
                            <Icons.Stars size={16}/> Cadastro M√°gico
                        </button>
                        <div className="h-[1px] bg-white/10 my-1 mx-2"></div>
                        <button onClick={() => { setView('passengers'); setFormData({neighborhood:BAIRROS[0],status:'Ativo',payment:'Dinheiro',passengerCount:1, luggageCount: 0, date: getTodayDate()}); setModal('passenger'); setContextMenu(null); }} className="px-4 py-2.5 text-left hover:bg-white/10 flex items-center gap-3 text-sm transition-colors">
                            <Icons.Users size={16}/> Novo Passageiro
                        </button>
                        <button onClick={() => { setView('trips'); setSuggestedTrip(null); setModal('trip'); setContextMenu(null); }} className="px-4 py-2.5 text-left hover:bg-white/10 flex items-center gap-3 text-sm transition-colors">
                            <Icons.Map size={16}/> Nova Viagem
                        </button>
                        <button onClick={() => { setView('drivers'); setFormData({status: 'Ativo'}); setModal('driver'); setContextMenu(null); }} className="px-4 py-2.5 text-left hover:bg-white/10 flex items-center gap-3 text-sm transition-colors">
                            <Icons.Van size={16}/> Novo Motorista
                        </button>
                        <div className="h-[1px] bg-white/10 my-1 mx-2"></div>
                        <button onClick={() => { setView('lostFound'); setFormData({date: getTodayDate(), status: 'Pendente'}); setModal('lostFound'); setContextMenu(null); }} className="px-4 py-2.5 text-left hover:bg-white/10 flex items-center gap-3 text-sm transition-colors opacity-80">
                            <Icons.Box size={16}/> Achados e Perdidos
                        </button>
                    </div>
                );
            };

            if (!user) return <LoginScreen onLogin={handleLogin} />;

            const currentRotatedList = getRotatedList(currentOpDate);
            const analysisRotatedList = getRotatedList(analysisDate);
            
            const { confirmedTimes, startLousaTime } = getTableTimes();
            
            let lousaEffectiveIndex = 0;

            const togglePaymentStatus = (trip) => {
                if (trip.isMadrugada) {
                    // L√≥gica para Madrugada: Atualiza daily_tables
                    const newStatus = !trip.isPaid;
                    db.ref(`daily_tables/${trip.date}/madrugada/${trip.vaga}`).update({ paid: newStatus });
                    
                    // Update otimista do estado local para refletir na UI instantaneamente
                    setMonthlyMadrugada(prev => ({
                        ...prev,
                        [trip.date]: {
                            ...prev[trip.date],
                            madrugada: {
                                ...prev[trip.date]?.madrugada,
                                [trip.vaga]: {
                                    ...prev[trip.date]?.madrugada[trip.vaga],
                                    paid: newStatus
                                }
                            }
                        }
                    }));
                } else {
                    // L√≥gica para Viagens Normais/Extras
                    const newStatus = trip.paymentStatus === 'Pago' ? 'Pendente' : 'Pago';
                    dbOp('update', 'trips', { id: trip.id, paymentStatus: newStatus });
                }
            };

            const sendBillingMessage = (trip) => {
                if (trip.isExtra) {
                    if (!trip.extraPhone) return alert("Sem WhatsApp cadastrado para este extra.");
                    const statusStr = trip.paymentStatus === 'Pago' ? 'PAGO \u2705' : 'PENDENTE \u26A0\uFE0F';
                    const msg = `*Cobran√ßa Adicional / Carro Extra*\n\n` +
                                `*Data:* ${formatDisplayDate(trip.date)}\n` +
                                `*Valor:* *R$ ${trip.value},00*\n` +
                                `*Status:* *${statusStr}*\n` +
                                `*Obs:* ${trip.notes || '-'}\n\n` +
                                `_Controle Financeiro Bora de Van_`;
                    window.open(`https://wa.me/55${trip.extraPhone.replace(/\D/g,'')}?text=${encodeURIComponent(msg)}`, '_blank');
                    return;
                }

                // Busca motorista (funciona tanto para viagens normais quanto madrugada se o ID existir)
                const dr = data.drivers.find(d => d.id === trip.driverId);
                
                // Se for madrugada e n√£o achou motorista (ex: deletado), tenta buscar pelo nome
                if (!dr && trip.isMadrugada) {
                     return alert(`Motorista "${trip.driverName}" n√£o encontrado no cadastro ativo.`);
                }
                
                if (!dr || !dr.phone) return alert("Motorista sem telefone.");
                
                const statusStr = trip.isPaid ? 'PAGO \u2705' : 'PENDENTE \u26A0\uFE0F';
                const today = new Date().toLocaleDateString('pt-BR');

                let msg = '';
                
                if (trip.isMadrugada) {
                    msg = `*Debito em aberto (Madrugada)* - ${today}\n\n` +
                          `*RELAT√ìRIO MADRUGADA - ${formatDisplayDate(trip.date)}*\n\n` +
                          `‚Ä¢ *Vaga:* ${trip.vaga}\n` +
                          `‚Ä¢ *Hor√°rio:* ${trip.time}\n` +
                          `‚Ä¢ *Passageiros:* ${trip.pCount}\n` +
                          `‚Ä¢ *Valor:* *R$ ${trip.value},00*\n` +
                          `‚Ä¢ *Status:* *${statusStr}*\n\n` +
                          `_Controle Financeiro Bora de Van_`;
                } else {
                    msg = `*Debito em aberto* - ${today}\n\n` +
                          `*RELAT√ìRIO DE VIAGEM - ${formatDisplayDate(trip.date)}*\n\n` +
                          `‚Ä¢ *ID:* #${trip.id}\n` +
                          `‚Ä¢ *Viagem:* ${trip.time}\n` +
                          `‚Ä¢ *Passageiros:* ${trip.pCount}\n` +
                          `‚Ä¢ *Valor Total:* *R$ ${trip.value},00*\n` +
                          `‚Ä¢ *Status:* *${statusStr}*\n\n` +
                          `_Controle Financeiro Bora de Van_`;
                }
                
                window.open(`https://wa.me/55${dr.phone.replace(/\D/g,'')}?text=${encodeURIComponent(msg)}`, '_blank');
            };

            return (
                <div 
                    className={`flex flex-col md:flex-row h-full w-full theme-transition ${theme.bg} ${theme.text} ${theme.font}`}
                    onTouchStart={handleGlobalTouchStart}
                    onTouchEnd={handleGlobalTouchEnd}
                >
                    {/* ADICIONADO ID 'mobile-sidebar' PARA O TOUR ENCONTRAR */}
                    {menuOpen && <div className="fixed inset-0 z-50 flex"><div id="mobile-sidebar" className={`w-72 h-full shadow-2xl p-6 border-r flex flex-col ${theme.card} ${theme.border} relative`}><div className="flex justify-between items-center mb-8"><h1 className="text-2xl font-bold">Bora de Van</h1><button onClick={()=>setMenuOpen(false)}><Icons.Menu/></button></div><nav className="space-y-2 flex-1">{orderedMenuItems.map((x, i)=>(<button key={x.id} id={`menu-btn-${x.id}`} onClick={()=>{setView(x.id);setMenuOpen(false)}} className={`flex items-center gap-4 w-full p-4 rounded-xl text-lg font-medium transition-all ${view===x.id ? theme.primary : 'opacity-60'}`}><x.i size={24}/> {x.l}</button>))}</nav><div className={`p-4 border-t ${theme.border} flex items-center justify-between cursor-pointer hover:bg-white/5 transition-colors mt-auto`} onClick={() => { setView('settings'); setMenuOpen(false); }}> <div className="flex items-center gap-3"> <div className="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center overflow-hidden border-2 border-white/20"> <img src={getAvatarUrl(user.username)} alt="User" /> </div> <div className="flex flex-col"> <span className="text-sm font-bold">{user.username}</span> <span className="text-xs opacity-60 capitalize">{user.role}</span> </div> </div> </div></div><div className="flex-1 bg-black/60" onClick={()=>setMenuOpen(false)}></div></div>}
                    
                    {/* MENU DESKTOP COM DRAG AND DROP */}
                    <div id="sidebar-nav" className={`hidden md:flex w-64 flex-col border-r shrink-0 ${theme.border} ${theme.card}`}>
                        <div className={`h-20 flex items-center justify-center border-b ${theme.border}`}><h1 className="text-2xl font-bold">Bora de Van</h1></div>
                        <nav className="p-4 space-y-2 flex-1 overflow-y-auto">
                            {orderedMenuItems.map((x, index)=>(
                                <div
                                    key={x.id}
                                    draggable="true"
                                    onDragStart={(e) => handleMenuDragStart(e, index)}
                                    onDragEnd={handleMenuDragEnd}
                                    onDragOver={(e) => e.preventDefault()}
                                    onDrop={(e) => handleMenuDrop(e, index)}
                                    className={`draggable-item relative ${draggedItem?.index === index && draggedItem?.listType === 'menu' ? 'opacity-50 border border-dashed border-white/30 scale-95' : ''}`}
                                >
                                    <button 
                                        id={`menu-btn-${x.id}`} /* ID PARA O TOUR */
                                        onClick={()=>setView(x.id)} 
                                        className={`flex items-center gap-3 w-full p-3 rounded-lg transition-all ${view===x.id ? theme.primary : 'opacity-60 hover:opacity-100 hover:bg-white/5'}`}
                                    >
                                        <div className="cursor-grab active:cursor-grabbing"><x.i size={20}/></div>
                                        {x.l}
                                    </button>
                                </div>
                            ))}
                        </nav>
                        <div id="menu-settings-btn" className={`p-4 border-t ${theme.border} flex items-center justify-between cursor-pointer hover:bg-white/5 transition-colors`} onClick={() => setView('settings')}> <div className="flex items-center gap-3"> <div className="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center overflow-hidden border-2 border-white/20"> <img src={getAvatarUrl(user.username)} alt="User" /> </div> <div className="flex flex-col"> <span className="text-sm font-bold">{user.username}</span> <span className="text-xs opacity-60 capitalize">{user.role}</span> </div> </div> </div>
                    </div>

                    <div className="flex-1 flex flex-col h-full overflow-hidden relative">
                        <header className={`h-16 backdrop-blur-md border-b flex items-center justify-between px-4 shrink-0 z-20 ${theme.border}`}>
                            {/* ATUALIZADO NO CABE√áALHO */}
                            <div className="flex items-center gap-3"><button onClick={()=>setMenuOpen(true)} className="md:hidden p-2 opacity-70"><Icons.Menu/></button><h2 className="text-lg font-bold capitalize">{view === 'appointments' ? 'Agendamentos' : view === 'lostFound' ? 'Achados e Perdidos' : view === 'table' ? 'Tabela' : view === 'billing' ? 'Financeiro / Cobran√ßa' : view}</h2></div>
                            {view !== 'dashboard' && view !== 'settings' && view !== 'billing' && (<div className="flex gap-2">{view!=='trips'&&view!=='appointments'&&view!=='lostFound'&&view!=='table'&&<button onClick={()=>setFilterStatus(filterStatus==='Ativo'?'Todos':'Ativo')} className={`p-2 rounded-lg ${filterStatus==='Ativo'?theme.accent:'opacity-50'}`}><Icons.Refresh size={20}/></button>}<button onClick={()=>{setFormData(view==='passengers'?{neighborhood:BAIRROS[0],status: formData.status || 'Ativo', payment:'Dinheiro',passengerCount:1, luggageCount: 0, date: getTodayDate()}: view==='appointments' ? {date: getTodayDate(), driverId: ''} : view==='lostFound' ? {date: getTodayDate(), status: 'Pendente'} : view==='drivers' ? {status: 'Ativo'} : {}); if(view==='trips' || view==='appointments'){setSuggestedTrip(null); setEditingTripId(null);} setModal(view==='passengers'?'passenger':view==='drivers'?'driver':view==='lostFound'?'lostFound':'trip');}} className={`${theme.primary} p-2.5 rounded-xl shadow-lg active:scale-95`}><Icons.Plus/></button></div>)}
                        </header>

                        {/* --- MAIN CONTENT AREA WITH ANIMATIONS --- */}
                        <div key={view} className="flex-1 scroll-y p-4 space-y-6 pb-24 md:pb-8 page-transition">
                            
                            {/* --- TABELA SP --- */}
                            {view === 'table' && (
                                <div 
                                    className="space-y-6 max-w-4xl mx-auto w-full min-h-[70vh]"
                                    onTouchStart={onTouchStartTable}
                                    onTouchMove={onTouchMoveTable}
                                    onTouchEnd={onTouchEndTable}
                                >
                                    <div id="table-tabs" className="flex p-1 bg-black/20 rounded-xl border border-white/5 gap-1 overflow-x-auto">
                                        <button onClick={()=>setTableTab('geral')} className={`flex-1 min-w-[100px] py-2 text-sm font-bold rounded-lg transition-all ${tableTab==='geral' ? theme.primary : 'hover:bg-white/5 opacity-60'}`}>Tabela</button>
                                        <button onClick={()=>setTableTab('confirmados')} className={`flex-1 min-w-[100px] py-2 text-sm font-bold rounded-lg transition-all ${tableTab==='confirmados' ? theme.primary : 'hover:bg-white/5 opacity-60'}`}>Confirmados</button>
                                        <button onClick={()=>setTableTab('lousa')} className={`flex-1 min-w-[100px] py-2 text-sm font-bold rounded-lg transition-all ${tableTab==='lousa' ? theme.primary : 'hover:bg-white/5 opacity-60'}`}>Lousa</button>
                                        <button onClick={()=>setTableTab('madrugada')} className={`flex-1 min-w-[100px] py-2 text-sm font-bold rounded-lg transition-all ${tableTab==='madrugada' ? theme.primary : 'hover:bg-white/5 opacity-60'}`}>Madrugada</button>
                                        <button onClick={()=>setTableTab('mensagens')} className={`flex-1 min-w-[100px] py-2 text-sm font-bold rounded-lg transition-all ${tableTab==='mensagens' ? theme.primary : 'hover:bg-white/5 opacity-60'}`}>Mensagens</button>
                                    </div>
                                    
                                    {tableTab === 'geral' && (
                                        <div className={`${theme.card} p-5 rounded-xl border ${theme.border} anim-fade`}>
                                            <div className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                                                <h3 className="text-lg font-bold opacity-80">Tabela Geral</h3>
                                                <div className="flex items-center gap-2 bg-black/30 p-1 rounded-lg">
                                                    <button onClick={() => setAnalysisDate(dateAddDays(analysisDate, -1))} className="p-2 hover:bg-white/10 rounded-md"><Icons.ChevronLeft size={20}/></button>
                                                    <div className="px-4 font-mono font-bold text-sm">{formatDisplayDate(analysisDate)}</div>
                                                    <button onClick={() => setAnalysisDate(dateAddDays(analysisDate, 1))} className="p-2 hover:bg-white/10 rounded-md"><Icons.ChevronRight size={20}/></button>
                                                    <button onClick={() => setAnalysisDate(currentOpDate)} className="ml-2 text-xs bg-white/10 px-2 py-1 rounded hover:bg-white/20">{currentOpDate === getTodayDate() ? 'Hoje' : 'Amanh√£ (Op)'}</button>
                                                    <button onClick={() => handlePrint('print-tabela-list', 'Tabela_Geral', 'TABELA GERAL', { forceCols: 2, date: analysisDate })} className="ml-4 p-2 bg-blue-500/20 text-blue-400 rounded-lg hover:bg-blue-500/30 transition-colors" title="Salvar como Imagem (2 Colunas)"><Icons.Print size={20}/></button>
                                                </div>
                                            </div>
                                            <div id="print-tabela-list" className="space-y-2">
                                                {analysisRotatedList.map((driver, idx) => {
                                                    const isOperational = analysisDate === currentOpDate;
                                                    const status = isOperational ? tableStatus[driver.vaga] : null; 
                                                    return (
                                                        <div key={idx} className={`p-3 rounded-lg border ${theme.border} flex flex-col sm:flex-row sm:items-center justify-between bg-white/5 hover:bg-white/10 transition-colors gap-3`}>
                                                            <div className="flex items-center gap-4"><div className="w-9 h-9 rounded-full bg-white/10 flex items-center justify-center font-mono text-sm font-bold opacity-70 flex-shrink-0 leading-none pt-[1px]">{driver.vaga}</div><div className="flex items-center gap-2">{editName === driver.vaga ? (<div className="flex gap-1 hide-on-print"><input className="bg-black/50 border border-white/20 rounded px-2 py-1 text-sm w-32 outline-none focus:border-white/50" value={tempName} onChange={e=>setTempName(e.target.value)} autoFocus /><button onClick={()=>saveDriverName(driver.vaga)} className="text-green-400 hover:text-green-300"><Icons.CheckCircle size={18}/></button></div>) : (<><span className="font-bold text-lg">{driver.name}</span><button onClick={()=>{setEditName(driver.vaga); setTempName(driver.name)}} className="opacity-20 hover:opacity-100 transition-opacity hide-on-print"><Icons.Edit3 size={14}/></button></>)}</div></div>
                                                            {isOperational && (<div className="flex items-center gap-2 hide-on-print">{!status ? (<><button onClick={() => updateTableStatus(driver.vaga, 'confirmed')} className="px-3 py-1.5 bg-green-500/10 hover:bg-green-500/20 text-green-400 border border-green-500/20 rounded-lg text-xs font-bold flex items-center gap-1 transition-colors"><Icons.CheckCircle size={14}/> Confirmar</button><button onClick={() => updateTableStatus(driver.vaga, 'lousa')} className="px-3 py-1.5 bg-yellow-500/10 hover:bg-yellow-500/20 text-yellow-400 border border-yellow-500/20 rounded-lg text-xs font-bold flex items-center gap-1 transition-colors"><Icons.List size={14}/> Lousa</button></>) : (<div className="flex items-center gap-2"><span className={`text-[10px] uppercase font-bold px-2 py-1 rounded border flex items-center gap-1 ${status==='confirmed'?'text-green-400 border-green-500/30 bg-green-500/10':'text-yellow-400 border-yellow-500/30 bg-yellow-500/10'}`}>{status === 'confirmed' ? <Icons.CheckCircle size={10}/> : <Icons.List size={10}/>}{status === 'confirmed' ? 'Confirmado' : 'Na Lousa'}</span><button onClick={() => updateTableStatus(driver.vaga, null)} className="p-1 text-red-400 opacity-50 hover:opacity-100" title="Remover status"><Icons.X size={14}/></button></div>)}</div>)}
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    )}
                                    {tableTab === 'confirmados' && (
                                        <div className="flex flex-col gap-4 anim-fade">
                                            <div className={`${theme.card} p-5 rounded-xl border ${theme.border} border-green-500/30 relative overflow-hidden`}>
                                                <div className="flex justify-between items-start mb-4 border-b border-white/10 pb-2"><h3 className="text-lg font-bold text-green-400 flex items-center gap-2"><span className="w-2 h-2 rounded-full bg-green-500"></span> CONFIRMADOS</h3><button onClick={() => handlePrint('print-confirmados-list', 'Confirmados', 'LISTA DE CONFIRMADOS', { mode: 'confirmados', date: currentOpDate })} className="p-2 bg-white/10 rounded-lg hover:bg-white/20 transition-colors text-white" title="Salvar como Imagem"><Icons.Print size={18}/></button></div><div className="absolute top-0 right-0 p-2 opacity-10 pointer-events-none"><Icons.CheckCircle size={64}/></div>
                                                <div id="print-confirmados-list" className="space-y-2 min-h-[100px]">
                                                    {currentRotatedList.filter(d => tableStatus[d.vaga] === 'confirmed').map((driver) => {
                                                        const timeStr = confirmedTimes[driver.vaga];
                                                        const expired = isTimeExpired(timeStr);
                                                        const isInLousa = lousaOrder.some(i => i.vaga === driver.vaga);
                                                        
                                                        return (
                                                            <div key={driver.vaga} className={`flex justify-between items-center p-2 rounded-lg border transition-all ${expired ? 'bg-red-900/10 border-red-500/20 opacity-80' : 'bg-black/20 border-white/5'}`}>
                                                                <div className="flex items-center gap-3">
                                                                    <div className={`font-mono text-sm w-8 h-7 rounded flex items-center justify-center flex-shrink-0 leading-none pt-[1px] ${expired ? 'bg-red-500/20 text-red-300' : 'bg-green-900/50 text-green-200'}`}>{driver.vaga}</div>
                                                                    <span className={`font-bold text-base ${expired ? 'line-through opacity-60' : ''}`}>{driver.name}</span>
                                                                </div>
                                                                <div className="flex items-center gap-3">
                                                                    <span className={`font-mono font-bold text-lg ${expired ? 'text-red-400 decoration-red-500 line-through' : 'text-green-400'}`}>{timeStr}</span>
                                                                    {expired ? (
                                                                        isInLousa ? (
                                                                            // AJUSTE: Adicionada classe 'hide-on-print' para o badge "Na Lousa" sumir na impress√£o
                                                                            <span className="text-[10px] font-bold text-yellow-500/70 uppercase border border-yellow-500/30 px-2 py-1 rounded bg-yellow-500/10 hide-on-print">Na Lousa</span>
                                                                        ) : (
                                                                            // O bot√£o "Mover p/ Lousa" j√° estava oculto, mantido assim
                                                                            <button onClick={() => sendToLousaKeepConfirmed(driver.vaga)} className="px-3 py-1 bg-yellow-500/20 text-yellow-400 border border-yellow-500/30 rounded-lg text-xs font-bold hover:bg-yellow-500/30 transition-colors shadow-lg animate-pulse hide-on-print">
                                                                                Mover p/ Lousa
                                                                            </button>
                                                                        )
                                                                    ) : (
                                                                        <button onClick={() => handleLousaAction(null, 'remove_all', driver.vaga)} className="text-red-400 hover:text-red-300 transition-colors p-1 hide-on-print"><Icons.X size={14}/></button>
                                                                    )}
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                    {!currentRotatedList.some(d => tableStatus[d.vaga] === 'confirmed') && <div className="text-center opacity-30 text-sm py-10">Nenhum confirmado</div>}
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                    {tableTab === 'lousa' && (
                                        <div className={`${theme.card} p-3 md:p-5 rounded-xl border ${theme.border} border-yellow-500/30 relative anim-fade`}>
                                            <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 border-b border-white/10 pb-2 gap-3 sm:gap-0"><h3 className="text-lg font-bold text-yellow-400 flex items-center gap-2"><span className="w-2 h-2 rounded-full bg-yellow-500"></span> LOUSA</h3><div className="flex w-full sm:w-auto justify-end"><button onClick={() => handlePrint('print-lousa-list', 'Lousa', 'LOUSA / FILA', { mode: 'lousa', date: currentOpDate })} className="p-2 bg-white/10 rounded-lg hover:bg-white/20 transition-colors text-white" title="Salvar como Imagem"><Icons.Print size={18}/></button></div></div><div className="absolute top-0 right-0 p-2 opacity-10 pointer-events-none"><Icons.List size={64}/></div><p className="text-xs opacity-50 mb-3 hide-on-print">Segure o item por 1 segundo para arrastar.</p>
                                            <div id="print-lousa-list" className="space-y-2 min-h-[300px]">{lousaOrder.map((item, index) => { 
                                                const vaga = item.vaga; 
                                                const driver = spList.find(d => d.vaga === vaga) || { name: '' }; 
                                                const isRiscado = item.riscado; 
                                                const isBaixou = item.baixou;
                                                
                                                let displayContent = '---'; 
                                                let isExpired = false;
                                                let timeClass = 'text-yellow-400';

                                                // L√≥gica de Exibi√ß√£o (Texto ou Hora)
                                                if (isRiscado) {
                                                    displayContent = 'RISCOU';
                                                    timeClass = 'text-red-500 font-bold';
                                                } else if (isBaixou) {
                                                    displayContent = 'BAIXOU';
                                                    timeClass = 'text-red-500 font-bold'; // AGORA √â VERMELHO
                                                } else {
                                                    // S√≥ calcula hora se n√£o estiver riscado nem baixado
                                                    // Isso faz com que os pr√≥ximos itens "subam" o hor√°rio automaticamente
                                                    const t = new Date(startLousaTime.getTime() + lousaEffectiveIndex * 30 * 60000); 
                                                    displayContent = t.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'}); 
                                                    isExpired = isTimeExpired(displayContent);
                                                    if (isExpired) timeClass = 'text-red-400 decoration-red-500 line-through';
                                                    lousaEffectiveIndex++; 
                                                }
                                                
                                                const isDraggingThis = draggedItem?.index === index && draggedItem?.listType === 'lousa'; 
                                                
                                                return ( 
                                                    <div key={item.uid} draggable="true" onDragStart={(e) => handleDragStart(e, index)} onDragOver={(e) => e.preventDefault()} onDrop={(e) => handleDrop(e, index)} onTouchStart={(e) => handleTouchStart(e, index, 'lousa')} onTouchMove={handleTouchMove} onTouchEnd={(e) => { const touch = e.changedTouches[0]; const target = document.elementFromPoint(touch.clientX, touch.clientY); const closest = target ? target.closest('.draggable-item') : null; if (closest) { const parent = closest.parentNode; const dropIndex = Array.from(parent.children).indexOf(closest); handleTouchEnd(e, dropIndex, 'lousa'); } else { handleTouchEnd(e, -1, 'lousa'); } }} className={`flex justify-between items-center p-2 rounded-lg border draggable-item ${isDraggingThis ? 'opacity-50 border-yellow-500 scale-105 shadow-2xl z-50 bg-yellow-900/40' : ''} ${isExpired ? 'bg-red-900/10 border-red-500/20 opacity-80' : (isRiscado ? 'bg-red-900/10 border-red-500/20 opacity-60' : 'bg-black/20 border-white/5')}`}> 
                                                        <div className="flex items-center gap-3 min-w-0 flex-1"> 
                                                            <div className={`font-mono text-xs w-8 h-7 rounded flex items-center justify-center flex-shrink-0 leading-none pt-[1px] ${isExpired ? 'bg-red-500/20 text-red-300' : 'bg-white/10 opacity-70'}`}>{vaga}</div> 
                                                            <span className={`font-bold text-base truncate ${isRiscado || isExpired ? 'line-through' : ''} ${isExpired ? 'opacity-60' : ''}`}>{driver.name}</span> 
                                                        </div> 
                                                        <div className="flex items-center gap-1.5 flex-shrink-0"> 
                                                            {/* Exibe o Conte√∫do (Hora, RISCOU ou BAIXOU) */}
                                                            <span className={`font-mono font-bold text-lg mr-1 ${timeClass}`}>{displayContent}</span> 
                                                            
                                                            <button onClick={() => handleLousaAction(item.uid, 'duplicate', vaga)} className="p-1.5 bg-blue-500/20 text-blue-400 rounded hover:bg-blue-500/30 hide-on-print flex-shrink-0" title="Duplicar vaga para o final da fila"> <Icons.Plus size={10}/> </button> 
                                                            
                                                            <button onClick={() => handleLousaAction(item.uid, 'riscar', vaga)} className="p-1.5 bg-white/5 rounded hover:bg-white/10 text-white hide-on-print flex-shrink-0"> <div className={`${isRiscado ? 'text-red-500' : 'opacity-50'}`}> <Icons.Slash size={10}/> </div> </button> 
                                                            
                                                            <button onClick={() => handleLousaAction(item.uid, 'baixar', vaga)} className="p-1.5 bg-white/5 rounded hover:bg-white/10 text-white hide-on-print flex-shrink-0" title="Baixar (Mover para o fim e marcar)"><Icons.ArrowDown size={10}/></button> 
                                                            <button onClick={() => handleLousaAction(item.uid, 'remove', vaga)} className="p-1.5 bg-white/5 rounded hover:bg-red-500/20 text-red-400 hide-on-print flex-shrink-0"><Icons.X size={12}/></button> 
                                                        </div> 
                                                    </div> 
                                                ); 
                                            })} {lousaOrder.length === 0 && <div className="text-center opacity-30 text-sm py-10">Lousa vazia</div>} </div>
                                        </div>
                                    )}
                                    {tableTab === 'madrugada' && (
                                        <div className={`${theme.card} p-3 md:p-5 rounded-xl border ${theme.border} anim-fade overflow-hidden`}>
                                            <div className="flex flex-col md:flex-row md:items-center justify-between mb-6 gap-3 md:gap-0">
                                                <h3 className="text-lg font-bold flex items-center gap-2"><Icons.Moon size={20}/> Tabela Madrugada</h3>
                                                <div className="flex flex-wrap gap-2 items-center justify-between md:justify-end w-full md:w-auto">
                                                    {/* BOT√ÉO ATUALIZADO: Adicionar Motorista */}
                                                    <Button theme={theme} onClick={addMadrugadaVaga} icon={Icons.Plus} size="sm" variant="success">Adicionar Motorista</Button>
                                                    
                                                    <div className="flex items-center gap-2">
                                                        <span className="text-xs opacity-60 bg-white/5 px-2 py-1 rounded flex items-center hidden sm:flex whitespace-nowrap">{formatDisplayDate(getOperationalDate())}</span>
                                                        <button onClick={() => handlePrint('print-madrugada-list', 'Madrugada', 'MADRUGADA', { mode: 'madrugada', date: currentOpDate })} className="p-2 bg-indigo-500/20 text-indigo-400 rounded-lg hover:bg-indigo-500/30 transition-colors" title="Salvar como Imagem"><Icons.Print size={18}/></button>
                                                    </div>
                                                </div>
                                            </div>
                                            <p className="text-xs opacity-50 mb-3 hide-on-print">Os dados abaixo s√£o reflexo das viagens criadas.</p>
                                            <div id="print-madrugada-list" className="space-y-2">
                                                {madrugadaList.map((vaga, index) => { 
                                                    const driver = spList.find(d => d.vaga === vaga) || { name: 'Desconhecido' }; 
                                                    const mData = madrugadaData[vaga] || { qtd: '', time: '', riscado: false, comment: '' }; 
                                                    const isDraggingThis = draggedItem?.index === index && draggedItem?.listType === 'madrugada'; 
                                                    
                                                    const tripId = `mad_${currentOpDate}_${vaga}`;
                                                    const trip = data.trips.find(t => t.id === tripId);
                                                    const isCancelled = trip && trip.status === 'Cancelada';
                                                    const isFinished = trip && trip.status === 'Finalizada';
                                                    
                                                    let rowClass = `flex flex-col md:flex-row items-center gap-2 p-3 rounded-lg border draggable-item cursor-grab active:cursor-grabbing`;
                                                    if (isCancelled) rowClass += ` bg-red-900/10 border-red-500/30 opacity-70`;
                                                    else if (isFinished) rowClass += ` bg-green-900/10 border-green-500/30`;
                                                    else rowClass += ` bg-black/20 border-white/5`;
                                                    
                                                    if (isDraggingThis) rowClass += ` opacity-50 border-indigo-500 scale-105 shadow-2xl z-50 bg-indigo-900/40`;

                                                    return ( 
                                                        <div key={`${vaga}-${index}`} draggable="true" onDragStart={(e) => handleMadrugadaDragStart(e, index)} onDragOver={(e) => e.preventDefault()} onDrop={(e) => handleMadrugadaDrop(e, index)} onTouchStart={(e) => handleTouchStart(e, index, 'madrugada')} onTouchMove={handleTouchMove} onTouchEnd={(e) => { const touch = e.changedTouches[0]; const target = document.elementFromPoint(touch.clientX, touch.clientY); const closest = target ? target.closest('.draggable-item') : null; if (closest) { const parent = closest.parentNode; const dropIndex = Array.from(parent.children).indexOf(closest); handleTouchEnd(e, dropIndex, 'madrugada'); } else { handleTouchEnd(e, -1, 'madrugada'); } }} className={rowClass}> 
                                                            <div className="flex items-center gap-3 w-full md:w-auto flex-1 relative min-w-0"> 
                                                                <div className="opacity-30 cursor-grab hide-on-print flex-shrink-0"><Icons.List size={14}/></div> 
                                                                <button onClick={() => removeMadrugadaVaga(vaga)} className="text-red-400 opacity-50 hover:opacity-100 hide-on-print flex-shrink-0"><Icons.Trash size={14}/></button> 
                                                                <button onClick={() => toggleMadrugadaRiscado(vaga)} className={`p-1 rounded hover:bg-white/10 flex-shrink-0 ${mData.riscado ? 'text-red-400' : 'text-white/30'} hide-on-print`}> <Icons.Slash size={14}/> </button> 
                                                                <div className="font-mono text-sm bg-indigo-500/20 text-indigo-300 w-[35px] h-[30px] rounded flex items-center justify-center flex-shrink-0 leading-none pt-[1px]">{vaga}</div> 
                                                                <div className="flex flex-row items-center gap-2 min-w-0 flex-1"> 
                                                                    <span className={`font-bold text-lg truncate ${mData.riscado || isCancelled ? 'line-through opacity-50' : ''}`}>{driver.name}</span> 
                                                                    {isCancelled && <span className="text-[10px] bg-red-500 text-white px-1.5 py-0.5 rounded uppercase font-bold">Cancelada</span>}
                                                                    {isFinished && <span className="text-[10px] bg-green-500 text-white px-1.5 py-0.5 rounded uppercase font-bold">Finalizada</span>}
                                                                    {mData.riscado && mData.comment && ( <div className="text-[12px] text-red-300 bg-red-900/30 px-2 py-1 rounded w-fit flex items-center justify-center leading-none truncate max-w-full relative top-[3px] font-bold">{mData.comment}</div> )} 
                                                                </div> 
                                                            </div> 
                                                            {!mData.riscado && ( 
                                                                <div className="flex items-center gap-2 w-full md:w-auto md:justify-end flex-shrink-0 mt-2 md:mt-0"> 
                                                                    <div className="flex gap-2 hide-on-print w-full md:w-auto items-center">
                                                                        {/* Campos READ-ONLY (Divs). Edi√ß√£o feita pelo bot√£o Gerenciar */}
                                                                        <div className="bg-black/30 border border-white/10 rounded px-3 py-2 w-full md:w-20 text-center text-white/70">
                                                                            {mData.qtd || '-'}
                                                                        </div>
                                                                        <div className="bg-black/30 border border-white/10 rounded px-3 py-2 w-full md:w-32 text-center text-white/70 text-sm">
                                                                            {mData.time || '-'}
                                                                        </div>
                                                                        
                                                                        <button 
                                                                            onClick={() => openMadrugadaTrip(vaga)}
                                                                            className="p-2 bg-indigo-600/20 text-indigo-400 hover:bg-indigo-600/40 rounded-lg transition-colors font-bold text-xs flex items-center gap-1"
                                                                            title="Editar Viagem"
                                                                        >
                                                                            <Icons.Edit size={14}/> Gerenciar
                                                                        </button>
                                                                    </div>
                                                                    <div className="show-on-print hidden font-bold text-indigo-200 text-lg"> 
                                                                        <span>{mData.time}</span> 
                                                                        {mData.qtd && <span className="ml-2 opacity-70">({mData.qtd})</span>} 
                                                                    </div> 
                                                                </div> 
                                                            )} 
                                                        </div> 
                                                    ); 
                                                })} 
                                                {madrugadaList.length === 0 && <div className="text-center opacity-30 text-sm py-4">Nenhuma vaga na madrugada hoje.</div>} 
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}

                            {(view === 'passengers' || view === 'drivers' || view === 'trips' || view === 'lostFound') && (
                                <div className="mb-4">
                                    <div className="relative stagger-in d-1">
                                        <div className="absolute left-3 top-3 opacity-50"><Icons.Search size={20}/></div>
                                        <input 
                                            className={`w-full bg-black/10 border border-white/10 rounded-xl pl-10 pr-4 py-3 outline-none focus:border-current transition-colors ${theme.text}`} 
                                            placeholder="Pesquisar..." 
                                            value={searchTerm} 
                                            onChange={e => setSearchTerm(e.target.value)}
                                        />
                                    </div>
                                </div>
                            )}

                            {view === 'settings' && (
                                <div className="space-y-6">
                                    <div className={`${theme.card} p-6 ${theme.radius} border ${theme.border} flex items-center gap-4 stagger-in d-1 premium-card`}> <div className="w-16 h-16 rounded-full bg-slate-700 overflow-hidden border-2 border-white/20"> <img src={getAvatarUrl(user.username)} alt="User" className="w-full h-full" /> </div> <div> <h3 className="text-xl font-bold">{user.username}</h3> <p className="opacity-60 text-sm capitalize">{user.role}</p> <button onClick={handleLogout} className="mt-2 text-xs bg-red-500/20 text-red-400 px-3 py-1 rounded-lg border border-red-500/30 flex items-center gap-1"><Icons.LogOut size={12}/> Sair da Conta</button> </div> </div>
                                    
                                    {/* Bot√£o de Reiniciar Tour */}
                                    <div className={`${theme.card} p-5 ${theme.radius} border ${theme.border} stagger-in d-2 premium-card flex justify-between items-center`}>
                                        <div>
                                            <h3 className="font-bold text-lg">üéì Tutorial</h3>
                                            <p className="text-xs opacity-50">Reveja o tour guiado do sistema</p>
                                        </div>
                                        <button onClick={restartTour} className="bg-white/10 hover:bg-white/20 px-4 py-2 rounded-lg font-bold text-sm">Iniciar Tour</button>
                                    </div>

                                    <div className={`${theme.card} p-5 ${theme.radius} border ${theme.border} stagger-in d-2 premium-card`}>
                                        <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><Icons.Stars/> Configura√ß√£o IA (Gemini)</h3>
                                        <div className="flex gap-2">
                                            <input 
                                                type="password" 
                                                className="flex-1 bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm outline-none focus:border-white/50" 
                                                placeholder="Cole sua API Key aqui..." 
                                                value={geminiKey} 
                                                onChange={e=>setGeminiKey(e.target.value)} 
                                            />
                                            <button onClick={()=>saveApiKey(geminiKey)} className="bg-green-600 hover:bg-green-500 text-white px-4 py-2 rounded-lg text-sm font-bold">Salvar</button>
                                        </div>
                                        <p className="text-xs opacity-50 mt-2">Necess√°rio para usar o Cadastro M√°gico.</p>
                                    </div>

                                    {user.username === 'Breno' && (
                                        <div className={`${theme.card} p-5 ${theme.radius} border ${theme.border} stagger-in d-3 premium-card`}>
                                            <h3 className="font-bold text-lg mb-4 text-red-400 flex items-center gap-2"><Icons.Shield/> Seguran√ßa e Bloqueios</h3>
                                            <div className="flex flex-col md:flex-row gap-2 mb-4"><input className="bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm flex-1" placeholder="IP para bloquear" value={ipToBlock} onChange={e=>setIpToBlock(e.target.value)} /><button onClick={blockIp} className="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-bold">Bloquear</button></div>
                                            <div className="space-y-2 max-h-40 overflow-y-auto mb-6">{data.blocked_ips && data.blocked_ips.map(item => (<div key={item.id} className="bg-red-500/10 border border-red-500/20 p-2 rounded-lg flex justify-between items-center"><div><div className="text-sm font-bold font-mono">{item.ip}</div></div><button onClick={()=>del('blocked_ips', item.id)} className="text-red-400 hover:text-red-300 p-2"><Icons.Trash size={16}/></button></div>))}</div>
                                            <h4 className="font-bold text-sm mb-3 border-t border-white/10 pt-3">Hist√≥rico de Acessos</h4>
                                            <div className="space-y-2 max-h-60 overflow-y-auto pr-1">{ipHistory.map((log) => { const safeIp = (log.ip||'').replace(/\./g, '_'); const currentLabel = ipLabels[safeIp] || ''; return (<div key={log.id} className="bg-white/5 p-2 rounded-lg text-xs flex flex-col gap-1 border border-white/5"><div className="flex justify-between opacity-60"><span>{new Date(log.timestamp).toLocaleString()}</span><span>{log.username}</span></div><div className="flex items-center gap-2"><span className="font-mono bg-black/30 px-1.5 rounded">{log.ip}</span><input className="bg-transparent border-b border-white/10 focus:border-white/50 outline-none flex-1 text-yellow-400" placeholder="Nota..." defaultValue={currentLabel} onBlur={(e) => saveIpLabel(log.ip, e.target.value)} /></div></div>); })}</div>
                                        </div>
                                    )}
                                    <div className={`${theme.card} p-5 ${theme.radius} border ${theme.border} stagger-in d-4 premium-card`}><h3 className="font-bold text-lg mb-4">üé® Temas</h3><div className="grid grid-cols-2 gap-3">{Object.keys(THEMES).map(k=>(<button key={k} onClick={()=>changeTheme(k)} className={`p-4 ${theme.radius} border flex items-center gap-2 ${themeKey===k ? theme.primary : 'border-transparent bg-black/10'}`}>{THEMES[k].name}</button>))}</div></div>
                                </div>
                            )}

                            {view === 'dashboard' && (
                                <div className="space-y-6">
                                    <div id="dashboard-stats" className="grid grid-cols-2 gap-4">
                                        {/* ADICIONADO onClick E CURSOR POINTER NOS CARDS */}
                                        <div onClick={() => setView('passengers')} className={`${theme.card} p-4 ${theme.radius} border ${theme.border} stagger-in d-1 premium-card cursor-pointer hover:bg-white/5`}><div className={`mb-2 ${theme.accent}`}><Icons.Users size={24}/></div><div className="text-2xl font-bold">{data.passengers.length}</div><div className="text-xs opacity-70">Passageiros</div></div>
                                        <div onClick={() => setView('trips')} className={`${theme.card} p-4 ${theme.radius} border ${theme.border} stagger-in d-2 premium-card cursor-pointer hover:bg-white/5`}><div className={`mb-2 ${theme.accent}`}><Icons.Map size={24}/></div><div className="text-2xl font-bold">{data.trips.length}</div><div className="text-xs opacity-70">Viagens</div></div>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div className={`${theme.card} p-5 ${theme.radius} border ${theme.border} flex flex-col items-center relative stagger-in d-3 premium-card`}><h3 className="font-bold mb-6 w-full flex justify-between items-center">üí∞ M√©todos</h3>{stats.p.length ? <DonutChart data={stats.p} theme={theme}/> : <p className="opacity-50">Sem dados</p>}</div>
                                        <div className={`${theme.card} p-5 ${theme.radius} border ${theme.border} stagger-in d-4 premium-card`}><h3 className="font-bold mb-6 w-full">üìç Bairros</h3>{stats.b.length ? <HorizontalBarChart data={stats.b} theme={theme}/> : <p className="opacity-50">Sem dados</p>}</div>
                                    </div>
                                    
                                    <div className={`${theme.card} p-5 ${theme.radius} border ${theme.border} stagger-in d-5 premium-card`}>
                                        <h3 className="font-bold mb-4 flex items-center gap-2"><Icons.Clipboard size={20}/> Notas R√°pidas</h3>
                                        <div className="flex gap-2 mb-4">
                                            <input 
                                                className="flex-1 bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm outline-none focus:border-white/30" 
                                                placeholder="Adicionar lembrete..." 
                                                value={noteText} 
                                                onChange={e=>setNoteText(e.target.value)} 
                                                onKeyPress={e=> e.key === 'Enter' && saveNote()} 
                                            />
                                            <button onClick={saveNote} className={`${theme.primary} px-4 rounded-lg`}><Icons.Plus size={18}/></button>
                                        </div>
                                        <div className="space-y-2 max-h-40 overflow-y-auto pr-1">
                                            {data.notes.map(note => (
                                                <div key={note.id} className="flex justify-between items-center bg-white/5 p-2 rounded-lg text-sm group border border-transparent hover:border-white/10 transition-colors">
                                                    <span>{note.text}</span>
                                                    {/* CORRE√á√ÉO: Bot√£o de exclus√£o refor√ßado */}
                                                    <button 
                                                        onClick={(e) => { 
                                                            e.preventDefault();
                                                            e.stopPropagation(); 
                                                            del('notes', note.id); 
                                                        }} 
                                                        className="text-red-400 p-2 hover:bg-white/10 rounded transition-colors cursor-pointer"
                                                        title="Apagar nota"
                                                    >
                                                        <Icons.Trash size={16}/>
                                                    </button>
                                                </div>
                                            ))}
                                            {data.notes.length === 0 && <p className="text-xs opacity-30 text-center py-2">Nenhuma nota.</p>}
                                        </div>
                                    </div>

                                    <div className={`${theme.card} p-4 ${theme.radius} border ${theme.border} stagger-in d-5 premium-card`}><h3 className="font-bold mb-4 flex gap-2"><Icons.Zap/> Acesso R√°pido</h3><div className="grid grid-cols-2 gap-3"><Button id="btn-magic-create" theme={theme} variant="ai" onClick={()=>{setAiModal(true)}} className="col-span-2 flex items-center justify-center gap-2"><Icons.Stars/> Cadastro M√°gico (IA)</Button><Button theme={theme} variant="secondary" onClick={()=>{setView('passengers');setFormData({neighborhood:BAIRROS[0],status:'Ativo',payment:'Dinheiro',passengerCount:1, luggageCount: 0, date: getTodayDate()});setModal('passenger')}} className="text-xs">üë§ Novo Pass</Button><Button theme={theme} variant="primary" onClick={()=>{setView('trips');setSuggestedTrip(null);setModal('trip')}} className="text-xs">üöê Nova Viagem</Button></div></div>
                                </div>
                            )}

                            {view === 'lostFound' && (
                                <div className="space-y-4">
                                    {filteredList.map((item, i) => ( <div key={item.id} style={{animationDelay: `${i * 50}ms`}} className={`${theme.card} p-4 ${theme.radius} border ${theme.border} relative overflow-hidden stagger-in premium-card`}><div className={`absolute left-0 top-0 bottom-0 w-1 ${item.status === 'Entregue' ? 'bg-green-500' : 'bg-yellow-500'}`}></div><div className="pl-3"><div className="flex justify-between items-start"><h3 className="font-bold text-lg">{item.description}</h3><span className={`text-xs px-2 py-0.5 rounded-full border ${item.status === 'Entregue' ? 'bg-green-500/20 text-green-400 border-green-500/30' : 'bg-yellow-500/20 text-yellow-400 border-yellow-500/30'}`}>{item.status}</span></div><p className="text-sm opacity-70 mt-1">üìç {item.location} ‚Ä¢ üìÖ {formatDisplayDate(item.date)}</p></div><div className="pl-3 flex justify-end gap-2 mt-3 pt-2 border-t border-white/10"><button onClick={() => { const newStatus = item.status === 'Pendente' ? 'Entregue' : 'Pendente'; dbOp('update', 'lostFound', { id: item.id, status: newStatus }); }} className="text-xs bg-white/10 hover:bg-white/20 px-3 py-1.5 rounded-lg transition-colors">{item.status === 'Pendente' ? 'Marcar Entregue' : 'Marcar Pendente'}</button><IconButton theme={theme} variant="danger" onClick={()=>del('lostFound', item.id)} icon={Icons.Trash}/></div></div> ))}
                                </div>
                            )}

                            {view === 'appointments' && (
                                <div className="space-y-6">
                                    <div className={`${theme.card} ${theme.radius} border ${theme.border} p-4 stagger-in d-1`}><div className="flex items-center justify-between mb-4"><h3 className="font-bold text-lg capitalize">{monthName}</h3><div className="flex gap-2"><button onClick={()=>setCalendarDate(new Date(calendarDate.setMonth(calendarDate.getMonth()-1)))} className="p-2 hover:bg-white/10 rounded-lg"><Icons.ChevronLeft size={20}/></button><button onClick={()=>setCalendarDate(new Date(calendarDate.setMonth(calendarDate.getMonth()+1)))} className="p-2 hover:bg-white/10 rounded-lg"><Icons.ChevronRight size={20}/></button></div></div><div className="grid grid-cols-7 gap-1 text-center mb-2 text-xs opacity-60">{['D','S','T','Q','Q','S','S'].map((d,i)=><div key={i}>{d}</div>)}</div><div className="grid grid-cols-7 gap-1">{dayElements}</div><div className="mt-4 pt-3 border-t border-white/10 flex gap-2"><button onClick={copyDaySummary} className="w-full bg-white/5 hover:bg-white/10 py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2 transition-colors"><Icons.Copy size={16}/> üìã Copiar Resumo do Dia</button></div></div>
                                    <div className="space-y-4 stagger-in d-2">
                                        <h3 className="font-bold text-lg border-b border-white/10 pb-2">üìÖ {formatDisplayDate(selectedDate)}</h3>
                                        
                                        <div className="space-y-3">
                                            <h4 className="text-xs font-bold uppercase tracking-widest opacity-60 pl-1 text-yellow-400">Passageiros Pendentes (Agendados)</h4>
                                            {(() => {
                                                if (pendingPax.length === 0) return <p className="text-sm opacity-40 italic pl-1">Todos os passageiros est√£o alocados ou sem hor√°rio.</p>;
                                                
                                                const grouped = pendingPax.reduce((acc, p) => {
                                                    const t = p.time || 'Sem Hor√°rio';
                                                    if (!acc[t]) acc[t] = [];
                                                    acc[t].push(p);
                                                    return acc;
                                                }, {});
                                                
                                                const sortedTimes = Object.keys(grouped).sort();

                                                return sortedTimes.map(time => (
                                                    <div key={time} className="mb-4">
                                                        <div className="flex items-center gap-2 mb-2 opacity-80">
                                                            <div className="w-2 h-2 rounded-full bg-yellow-400"></div>
                                                            <span className="font-bold font-mono text-lg">{time}</span>
                                                            <div className="h-[1px] bg-white/10 flex-1"></div>
                                                        </div>
                                                        <div className="space-y-3 pl-2 border-l border-white/5">
                                                            {grouped[time].map(p => (
                                                                <div key={p.id} className={`${theme.card} ${theme.radius} border border-yellow-500/30 p-4 relative bg-yellow-500/5 premium-card`}>
                                                                    <div className="flex justify-between items-start mb-2">
                                                                        <div>
                                                                            <div className="font-bold text-lg">{p.name}</div>
                                                                            <div className="text-xs opacity-70">{p.neighborhood}</div>
                                                                        </div>
                                                                        <div className="flex gap-2 items-center">
                                                                            <div className="text-sm font-bold bg-white/10 px-2 py-1 rounded">{p.luggageCount || 0}üéí</div>
                                                                            <div className="text-sm font-bold bg-white/10 px-2 py-1 rounded">{p.passengerCount}p</div>
                                                                            <button 
                                                                                onClick={(e) => {
                                                                                    e.stopPropagation();
                                                                                    setFormData({ id: p.id, time: p.time, name: p.name });
                                                                                    setModal('reschedule');
                                                                                }}
                                                                                className="ml-1 p-1.5 bg-blue-500/20 text-blue-400 rounded-lg hover:bg-blue-500/30 transition-colors active:scale-95 cursor-pointer"
                                                                                title="Reagendar Passageiro"
                                                                            >
                                                                                <Icons.Clock size={16} />
                                                                            </button>

                                                                            <button 
                                                                                onClick={(e) => {
                                                                                    e.stopPropagation();
                                                                                    clearPaxSchedule(p.id);
                                                                                }} 
                                                                                className="ml-1 p-1.5 bg-red-500/20 text-red-400 rounded-lg hover:bg-red-500/30 transition-colors active:scale-95 cursor-pointer"
                                                                                title="Remover Agendamento"
                                                                            >
                                                                                <Icons.CalendarX size={16} />
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                    <div className="flex gap-2 mt-3 pt-3 border-t border-white/10">
                                                                        <button onClick={() => sendPaxWhatsapp(p)} className="flex-1 bg-green-600/20 text-green-400 hover:bg-green-600/30 py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2"><Icons.Phone size={16}/> WhatsApp</button>
                                                                        <button onClick={() => handleCreateTripFromPax(p)} className="flex-1 bg-blue-600/20 text-blue-400 hover:bg-blue-600/30 py-2 rounded-lg text-sm font-bold flex items-center justify-center gap-2"><Icons.Plus size={16}/> Criar Viagem</button>
                                                                    </div>
                                                                </div>
                                                            ))}
                                                        </div>
                                                    </div>
                                                ));
                                            })()}
                                        </div>

                                        <div className="space-y-3 pt-4 border-t border-white/10">
                                            <h4 className="text-xs font-bold uppercase tracking-widest opacity-60 pl-1 text-blue-400">Em Viagem</h4>
                                            {assignedPax.length > 0 ? (
                                                assignedPax.map(p => {
                                                    const trip = data.trips.find(t => t.date === selectedDate && t.status !== 'Cancelada' && (t.passengerIds||[]).map(String).includes(String(p.id)));
                                                    const isFinalized = trip && trip.status === 'Finalizada';
                                                    
                                                    // CORRE√á√ÉO: Mostra o hor√°rio da viagem se o hor√°rio do passageiro foi apagado
                                                    const displayTime = trip ? trip.time : (p.time || 'Sem hor√°rio');

                                                    return (
                                                        <div key={p.id} className={`${theme.card} ${theme.radius} border border-white/5 p-3 relative opacity-60 hover:opacity-100 transition-opacity`}>
                                                            <div className="flex justify-between items-center">
                                                                <div>
                                                                    <div className="font-bold">{p.name}</div>
                                                                    <div className="text-xs opacity-70">
                                                                        {p.neighborhood} ‚Ä¢ {displayTime}
                                                                    </div>
                                                                </div>
                                                                <div className={`text-xs px-2 py-1 rounded font-bold ${isFinalized ? 'bg-gray-500/20 text-gray-400' : 'bg-green-500/20 text-green-400'}`}>
                                                                    {isFinalized ? 'Viagem Finalizada' : 'Em Viagem'}
                                                                </div>
                                                            </div>
                                                        </div>
                                                    );
                                                })
                                            ) : (
                                                <p className="text-sm opacity-40 italic pl-1">Nenhum.</p>
                                            )}
                                        </div>

                                        <div className="space-y-3 pt-4 border-t border-white/10"><h4 className="text-xs font-bold uppercase tracking-widest opacity-60 pl-1">Viagens do Dia</h4>{tripsForSelectedDate.length > 0 ? (tripsForSelectedDate.map(t => { const pCount = data.passengers.filter(p=>(t.passengerIds||[]).includes(p.id)).reduce((a,b)=>a+parseInt(b.passengerCount||1),0); let statusColor = 'bg-blue-500'; if(t.status === 'Finalizada') statusColor = 'bg-green-500'; if(t.status === 'Cancelada') statusColor = 'bg-red-500'; return (<div key={t.id} className={`${theme.card} ${theme.radius} border ${theme.border} p-4 flex justify-between items-center relative overflow-hidden premium-card`}><div className={`absolute left-0 top-0 bottom-0 w-1 ${statusColor}`}></div><div><div className="font-bold flex items-center gap-2">{t.driverName}<span className={`text-[10px] uppercase px-1.5 py-0.5 rounded border ${statusColor.replace('bg-', 'border-').replace('500', '500/50')} ${statusColor.replace('bg-', 'text-').replace('500', '400')} bg-transparent`}>{t.status}</span></div><div className="text-xs opacity-70 flex gap-2 mt-1"><span>üïí {calculateTimeSlot(t.time)}</span><span>üë• {pCount} pax</span></div></div><IconButton theme={theme} onClick={()=>openEditTrip(t)} icon={Icons.Edit} variant="default" /></div>); })) : (<p className="text-sm opacity-40 italic pl-1">Nenhuma viagem.</p>)}</div>
                                    </div>
                                </div>
                            )}

                            {view === 'passengers' && (
                                <div className="space-y-3">
                                    {filteredList.map((item, i) => (<div key={item.id} style={{animationDelay: `${i * 50}ms`}} onClick={() => setExpandedPax(expandedPax === item.id ? null : item.id)} className={`${theme.card} p-4 ${theme.radius} border ${theme.border} relative overflow-hidden cursor-pointer active:scale-[0.99] transition-transform stagger-in premium-card`}><div className="absolute top-1 right-8 text-4xl font-bold opacity-[0.07] pointer-events-none">#{item.id}</div><div className="absolute top-3 right-3 text-xs opacity-50">{expandedPax === item.id ? <Icons.ChevronUp size={18}/> : <Icons.ChevronDown size={18}/>}</div><div className="pr-8"><div className="flex flex-wrap gap-2 mb-1">{item.tags && item.tags.split(',').map((tag, i) => (<span key={i} className="text-[10px] bg-white/10 px-1.5 py-0.5 rounded font-bold uppercase">{tag.trim()}</span>))}</div><h3 className="font-bold text-lg">{item.name}</h3><p className="text-sm opacity-70">{item.neighborhood}</p></div>{expandedPax === item.id && (<div className="mt-4 pt-4 border-t border-white/10 space-y-2 text-sm expand-content anim-fade"><div className="grid grid-cols-2 gap-4"><div><span className="block opacity-50 text-xs">TELEFONE</span>{item.phone}</div><div><span className="block opacity-50 text-xs">PAGAMENTO</span>{item.payment}</div><div className="col-span-2"><span className="block opacity-50 text-xs">ENDERE√áO</span>{item.address} {item.reference ? `(${item.reference})` : ''}</div><div><span className="block opacity-50 text-xs">DATA/HORA</span>{formatDisplayDate(item.date)} - {item.time}</div><div><span className="block opacity-50 text-xs">DETALHES</span>{item.passengerCount} pax | {item.luggageCount || 0} malas</div><div><span className="block opacity-50 text-xs">STATUS</span><span className={item.status === 'Ativo' ? 'text-green-400' : 'text-red-400'}>{item.status}</span></div></div><div className="flex gap-2 pt-4 mt-2"><Button theme={theme} onClick={(e)=>{e.stopPropagation(); setFormData({...item, date: getTodayDate()}); setModal('passenger')}} variant="secondary" className="flex-1 py-2 text-sm" icon={Icons.Edit}>Editar</Button><IconButton theme={theme} variant="default" onClick={(e)=>{e.stopPropagation(); copyPassengerData(item)}} icon={Icons.Copy}/>{item.phone && <IconButton theme={theme} variant="success" onClick={(e)=>{e.stopPropagation(); callPhone(item.phone)}} icon={Icons.Phone}/>}<IconButton theme={theme} variant="danger" onClick={(e)=>{e.stopPropagation(); del(view, item.id)}} icon={Icons.Trash}/></div></div>)}</div>))}
                                    {!filteredList.length && <div className="text-center opacity-50 py-10">Nenhum passageiro.</div>}
                                </div>
                            )}

                            {(view === 'drivers') && (
                                <div className="space-y-3">
                                    {filteredList.map((item, i) => (<div key={item.id} style={{animationDelay: `${i * 50}ms`}} className={`${theme.card} p-4 ${theme.radius} border ${theme.border} relative overflow-hidden flex flex-col gap-4 group stagger-in premium-card`}><div className={`absolute top-0 right-0 px-3 py-1 rounded-bl-xl text-[10px] font-bold uppercase tracking-wider ${item.status === 'Ativo' ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}`}>{item.status}</div><div className="flex items-center gap-4"><div className={`w-16 h-16 rounded-full p-1 border-2 ${item.status === 'Ativo' ? 'border-green-500/50' : 'border-red-500/50'} flex-shrink-0`}><img src={getAvatarUrl(item.name)} alt="Avatar" className="w-full h-full rounded-full bg-slate-700/50"/></div><div className="flex-1 min-w-0"><h3 className="font-bold text-lg truncate">{item.name}</h3><div className="flex items-center gap-2 text-sm opacity-60"><span className="bg-white/10 px-1.5 py-0.5 rounded text-xs font-mono">{item.plate || 'SEM PLACA'}</span><span>‚Ä¢</span><span className="flex items-center gap-1"><Icons.Users size={12}/> {item.capacity} lug</span></div></div></div><div className="grid grid-cols-2 gap-3 bg-black/20 p-3 rounded-lg text-xs"><div className="flex flex-col"><span className="opacity-50 text-[10px] uppercase">Telefone</span><span className="font-mono">{item.phone || '-'}</span></div><div className="flex flex-col"><span className="opacity-50 text-[10px] uppercase">CNH Validade</span><span className={`${item.cnhValidity && new Date(item.cnhValidity) < new Date() ? 'text-red-400 font-bold' : ''}`}>{item.cnhValidity ? formatDisplayDate(item.cnhValidity) : '-'}</span></div></div><div className="flex gap-2"><button onClick={() => { const msg = encodeURIComponent(`Ol√° ${item.name}, tudo bem?`); window.open(`https://wa.me/55${(item.phone||'').replace(/\D/g,'')}?text=${msg}`, '_blank'); }} className="flex-1 bg-green-600/20 hover:bg-green-600/30 text-green-400 py-2 rounded-lg font-bold text-xs flex items-center justify-center gap-1 transition-colors"><Icons.Phone size={14}/> WhatsApp</button><Button theme={theme} onClick={()=>{setFormData(item); setModal('driver')}} variant="secondary" className="px-3 py-2 text-xs" icon={Icons.Edit}>Editar</Button><IconButton theme={theme} variant="danger" onClick={()=>del('drivers', item.id)} icon={Icons.Trash}/></div></div>))}
                                    {!filteredList.length && <div className="text-center opacity-50 py-10">Vazio.</div>}
                                </div>
                            )}

                            {view === 'trips' && (
                                <div className="space-y-6">
                                    <div className="space-y-4">
                                        <h3 className="text-sm font-bold opacity-70 uppercase tracking-widest pl-1">Hoje / Em Andamento</h3>
                                        {activeTrips.slice().reverse().map((t, i) => {
                                            // L√ìGICA DE SNAPSHOT
                                            let pCount = 0;
                                            if (t.pCountSnapshot !== undefined && t.pCountSnapshot !== null) {
                                                pCount = parseInt(t.pCountSnapshot);
                                            } else if (t.isMadrugada) {
                                                pCount = parseInt(t.pCount || 0);
                                            } else if (t.passengersSnapshot) {
                                                 pCount = t.passengersSnapshot.reduce((acc, p) => acc + parseInt(p.passengerCount || 1), 0);
                                            } else {
                                                pCount = data.passengers.filter(p=>(t.passengerIds||[]).includes(p.id)).reduce((a,b)=>a+parseInt(b.passengerCount||1),0);
                                            }
                                            
                                            const tripPassengers = t.isMadrugada ? [] : data.passengers.filter(p=>(t.passengerIds||[]).includes(p.id));
                                            
                                            // Estilo condicional para Madrugada
                                            const borderClass = t.isMadrugada 
                                                ? 'border-dashed border-indigo-500/50 bg-indigo-500/5' 
                                                : (t.isTemp ? 'border-dashed border-yellow-500/50' : `${theme.border}`);

                                            return (
                                                <div key={t.id} style={{animationDelay: `${i * 100}ms`}} className={`${theme.card} ${theme.radius} border ${borderClass} p-5 relative overflow-hidden shadow-lg stagger-in premium-card`}>
                                                    {t.isMadrugada && (
                                                        <div className="absolute top-0 right-0">
                                                            <div className="bg-indigo-500/20 text-indigo-400 text-[10px] px-2 py-0.5 font-bold uppercase rounded-bl-lg">
                                                                Madrugada
                                                            </div>
                                                        </div>
                                                    )}
                                                    {t.isTemp && !t.isMadrugada && (
                                                        <div className="absolute top-0 right-0 flex">
                                                            <div className="bg-yellow-500/20 text-yellow-500 text-[10px] px-2 py-0.5 font-bold uppercase rounded-bl-lg flex items-center gap-1">
                                                                <span>Tempor√°ria (Auto)</span>
                                                                <span className="w-[1px] h-3 bg-yellow-500/30 mx-1"></span>
                                                                <button onClick={(e) => { e.stopPropagation(); openEditTrip(t); }} className="flex items-center gap-1 hover:text-white transition-colors cursor-pointer" title="Clique para editar o hor√°rio"> <Icons.Clock size={10}/> <TempTripTimer date={t.date} time={t.time} /> </button>
                                                            </div>
                                                        </div>
                                                    )}
                                                    <div className="flex justify-between items-start mb-4">
                                                        <div>
                                                            <h3 className="font-bold text-lg">Viagem #{t.id.replace('mad_','')}</h3>
                                                            <div className={`${theme.accent} font-bold text-sm mt-1`}>{calculateTimeSlot(t.time)}</div>
                                                        </div>
                                                        <div className="flex gap-2">
                                                            {/* CORRE√á√ÉO: Habilitar edi√ß√£o para Madrugada tamb√©m */}
                                                            <IconButton theme={theme} onClick={()=>openEditTrip(t)} icon={Icons.Edit} variant="default" />
                                                            {/* CORRE√á√ÉO: Habilitar exclus√£o correta (que limpa tabela) */}
                                                            <IconButton theme={theme} onClick={()=>del('trips', t.id)} icon={Icons.Trash} variant="danger" />
                                                        </div>
                                                    </div>
                                                    <div className={`bg-black/20 p-3 rounded-lg mb-4 flex justify-between items-center border ${theme.border}`}>
                                                        <div className="flex items-center gap-2 text-sm opacity-80"><Icons.Car size={16}/> {t.driverName}</div>
                                                        <div className="flex items-center gap-2 text-sm font-bold"><Icons.Users size={16}/> {pCount}</div>
                                                    </div>
                                                    <div className="grid grid-cols-3 gap-2 mb-4">
                                                        <Button theme={theme} onClick={()=>updateTripStatus(t.id, 'Finalizada')} variant="success" size="sm" icon={Icons.Check}>Finalizar</Button>
                                                        <Button theme={theme} disabled={true} className="opacity-50" variant="secondary" size="sm">Andamento</Button>
                                                        <Button theme={theme} onClick={()=>updateTripStatus(t.id, 'Cancelada')} variant="danger" size="sm" icon={Icons.X}>Cancelar</Button>
                                                    </div>
                                                    {!t.isMadrugada && (
                                                        <div className="flex gap-2">
                                                            <button onClick={()=>copyToClip(generateTripListText(tripPassengers, t.driverName, t.time))} className="flex-1 bg-white/5 hover:bg-white/10 py-3 rounded-xl font-bold flex items-center justify-center gap-2 text-sm premium-click"><Icons.Copy size={18}/> Copiar Lista</button>
                                                            <button onClick={()=>sendWhatsapp(t)} className="flex-[2] bg-green-600 text-white py-3 rounded-xl font-bold flex items-center justify-center gap-2 shadow-lg active:scale-95 transition-transform premium-click"><Icons.Send size={18}/> WhatsApp</button>
                                                        </div>
                                                    )}
                                                    {/* CORRE√á√ÉO: Se for Madrugada, n√£o tem "Duplicar para hoje" pois depende da vaga e n√£o da trip */}
                                                    {!t.isMadrugada && (
                                                        <div className="mt-3 pt-3 border-t border-white/10">
                                                            <button onClick={()=>duplicateTrip(t)} className="w-full bg-blue-500/20 text-blue-300 hover:bg-blue-500/30 py-2 rounded-lg font-bold text-sm transition-colors flex items-center justify-center gap-2 premium-click"><Icons.Repeat size={16}/> Duplicar para Hoje</button>
                                                        </div>
                                                    )}
                                                </div>
                                            );
                                        })}
                                    </div>
                                    
                                    <div className="space-y-4 pt-6 border-t border-white/10">
                                        <div id="history-section" className="flex items-center justify-between mb-2">
                                            <div className="flex items-center gap-2">
                                                <h3 className="text-sm font-bold opacity-50 uppercase tracking-widest pl-1">Hist√≥rico</h3>
                                                <button onClick={generateMonthSummary} className="bg-white/5 hover:bg-white/10 p-1.5 rounded-lg text-xs font-bold transition-colors flex items-center gap-1 text-blue-400" title="Gerar Resumo do M√™s"><Icons.List size={14}/> Resumo</button>
                                            </div>
                                            <div className="flex items-center gap-3 bg-black/20 p-1 rounded-lg"><button onClick={prevHistoryMonth} className="p-1 hover:bg-white/10 rounded"><Icons.ChevronLeft size={18}/></button><span className="text-sm font-bold capitalize">{historyDate.toLocaleDateString('pt-BR', {month:'long', year:'numeric'})}</span><button onClick={nextHistoryMonth} className="p-1 hover:bg-white/10 rounded"><Icons.ChevronRight size={18}/></button></div>
                                        </div>

                                        {historyGroups.length > 0 ? (
                                            <div className="space-y-3">
                                                {historyGroups.map(group => {
                                                    const isExpanded = expandedDays[group.date];
                                                    const dateParts = group.date.split('-');
                                                    const dateObj = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
                                                    const dayName = dateObj.toLocaleDateString('pt-BR', {weekday: 'long'});

                                                    return (
                                                        <div key={group.date} className={`${theme.card} rounded-xl border border-white/5 overflow-hidden premium-card`}>
                                                            <div onClick={() => toggleHistoryDay(group.date)} className="p-4 flex justify-between items-center cursor-pointer hover:bg-white/5 transition-colors">
                                                                <div className="flex items-center gap-3"><div className={`text-xs p-1 rounded-lg transition-transform ${isExpanded ? 'rotate-180' : ''}`}><Icons.ChevronDown/></div><div><div className="font-bold text-base">{formatDisplayDate(group.date)}</div><div className="text-xs opacity-50 capitalize">{dayName}</div></div></div>
                                                                <div className="text-xs font-bold bg-white/10 px-2 py-1 rounded">{group.trips.length} viagens</div>
                                                            </div>
                                                            {isExpanded && (
                                                                <div className="bg-black/20 border-t border-white/5 p-3 space-y-2 anim-fade">
                                                                    {group.trips.map(t => {
                                                                        // VISUALIZA√á√ÉO NO HIST√ìRICO: Usa o snapshot se existir
                                                                        let pCount = 0;
                                                                        if (t.pCountSnapshot !== undefined && t.pCountSnapshot !== null) {
                                                                            pCount = parseInt(t.pCountSnapshot);
                                                                        } else if (t.passengersSnapshot) {
                                                                            pCount = t.passengersSnapshot.reduce((acc, p) => acc + parseInt(p.passengerCount || 1), 0);
                                                                        } else {
                                                                            pCount = data.passengers.filter(p => (t.passengerIds || []).includes(p.id))
                                                                                                      .reduce((a, b) => a + parseInt(b.passengerCount || 1), 0);
                                                                        }

                                                                        return (
                                                                            <div key={t.id} className="bg-white/5 p-3 rounded-lg flex justify-between items-center hover:bg-white/10 transition-colors border border-transparent hover:border-white/10">
                                                                                <div className="flex items-center gap-3">
                                                                                     <div className={`w-1 h-8 rounded-full ${t.status === 'Finalizada' ? 'bg-green-500' : 'bg-red-500'}`}></div>
                                                                                     <div>
                                                                                        <div className="font-bold text-sm">{t.time} - {t.driverName}</div>
                                                                                        <div className="text-xs opacity-50 flex gap-2">
                                                                                            <span>#{t.id}</span>
                                                                                            <span>‚Ä¢</span>
                                                                                            <span>{t.status}</span>
                                                                                            <span>‚Ä¢</span>
                                                                                            {/* EXIBE QUANTIDADE CONGELADA DE PAX */}
                                                                                            <span>{pCount} pax</span>
                                                                                        </div>
                                                                                     </div>
                                                                                </div>
                                                                                <div className="flex gap-2">
                                                                                    <button onClick={()=>updateTripStatus(t.id, 'Em andamento')} className="p-2 bg-blue-500/10 text-blue-400 rounded-lg hover:bg-blue-500/20" title="Reabrir"><Icons.Back size={16}/></button>
                                                                                    <button onClick={()=>openEditTrip(t)} className="p-2 bg-white/10 text-white rounded-lg hover:bg-white/20" title="Ver/Editar"><Icons.Edit size={16}/></button>
                                                                                    {/* NOVO: Bot√£o de Excluir no Hist√≥rico */}
                                                                                    <button onClick={()=>del('trips', t.id)} className="p-2 bg-red-500/10 text-red-400 rounded-lg hover:bg-red-500/20" title="Excluir Permanentemente"><Icons.Trash size={16}/></button>
                                                                                </div>
                                                                            </div>
                                                                        );
                                                                    })}
                                                                </div>
                                                            )}
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        ) : (
                                            <div className="text-center py-8 opacity-40 text-sm border border-dashed border-white/10 rounded-xl">
                                                Nenhuma viagem no hist√≥rico deste m√™s.
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* --- NOVA ABA COBRAN√áA --- */}
                            {view === 'billing' && (
                                <div className="space-y-6">
                                    {/* Cabe√ßalho com Navega√ß√£o de M√™s */}
                                    <div className="flex items-center justify-between pb-2 border-b border-white/10 stagger-in d-1">
                                        <h3 className="text-lg font-bold opacity-80 flex items-center gap-2"><Icons.Dollar size={20}/> Financeiro</h3>
                                        
                                        {/* Navega√ß√£o de M√™s COM o bot√£o de adicionar integrado */}
                                        <div className="flex items-center gap-1 bg-black/20 p-1 rounded-lg border border-white/5">
                                            {/* Bot√£o Nova Cobran√ßa Extra */}
                                            <button 
                                                onClick={() => { setFormData({ date: getTodayDate(), value: '', notes: '', phone: '' }); setModal('extraCharge'); }}
                                                className={`${theme.primary} w-7 h-7 rounded-lg flex items-center justify-center shadow-md transition-all active:scale-95 mr-2`}
                                                title="Adicionar Cobran√ßa Extra"
                                            >
                                                <Icons.Plus size={16}/>
                                            </button>

                                            <button onClick={prevBillingMonth} className="p-1.5 hover:bg-white/10 rounded transition-colors"><Icons.ChevronLeft size={18}/></button>
                                            <span className="text-sm font-bold capitalize w-32 text-center">{billingDate.toLocaleDateString('pt-BR', {month:'long', year:'numeric'})}</span>
                                            <button onClick={nextBillingMonth} className="p-1.5 hover:bg-white/10 rounded transition-colors"><Icons.ChevronRight size={18}/></button>
                                        </div>
                                    </div>

                                    {/* Resumo Topo */}
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className={`${theme.card} p-4 rounded-xl border ${theme.border} bg-red-500/10 border-red-500/20 stagger-in d-2`}>
                                            <div className="text-xs font-bold text-red-400 uppercase tracking-widest mb-1">A Receber (Pendente)</div>
                                            <div className="text-3xl font-bold text-white">R$ {billingData.summary.pending},00</div>
                                        </div>
                                        <div className={`${theme.card} p-4 rounded-xl border ${theme.border} bg-green-500/10 border-green-500/20 stagger-in d-3`}>
                                            <div className="text-xs font-bold text-green-400 uppercase tracking-widest mb-1">Recebido (Pago)</div>
                                            <div className="text-3xl font-bold text-white">R$ {billingData.summary.paid},00</div>
                                        </div>
                                    </div>

                                    {/* Lista Agrupada por Dia */}
                                    <div className="space-y-6 stagger-in d-4">
                                        {billingData.groups.length > 0 ? billingData.groups.map((group, idx) => {
                                            const [y, m, d] = group.date.split('-');
                                            const monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
                                            const displayDate = `${d} de ${monthNames[parseInt(m)-1]}`;

                                            return (
                                                <div key={group.date} className="anim-fade" style={{animationDelay: `${idx * 100}ms`}}>
                                                    <h3 className="flex items-center gap-3 text-sm font-bold opacity-60 uppercase tracking-widest mb-3 pl-1">
                                                        <span>{displayDate}</span>
                                                        <div className="h-[1px] bg-white/10 flex-1"></div>
                                                        <span className="text-white/40">Total: R$ {group.totalValue},00</span>
                                                    </h3>
                                                    
                                                    <div className="space-y-3">
                                                        {group.trips.map(trip => (
                                                            <div key={trip.id} className={`${theme.card} p-4 rounded-xl border ${theme.border} flex flex-col md:flex-row justify-between items-center gap-4 relative overflow-hidden premium-card`}>
                                                                {/* Indicador Lateral de Status */}
                                                                <div className={`absolute left-0 top-0 bottom-0 w-1 ${trip.isPaid ? 'bg-green-500' : 'bg-red-500'}`}></div>
                                                                
                                                                <div className="flex items-center gap-4 w-full md:w-auto">
                                                                    <div className={`w-12 h-12 rounded-full flex items-center justify-center font-bold text-lg bg-white/5 border border-white/10 shrink-0`}>
                                                                        {/* √çcone condicional para Madrugada */}
                                                                        {trip.isExtra ? <Icons.Car size={24}/> : (trip.isMadrugada ? <Icons.Moon size={24}/> : trip.time.split(':')[0] + 'h')}
                                                                    </div>
                                                                    <div className="min-w-0 flex-1">
                                                                        {trip.isExtra ? (
                                                                            <>
                                                                                <div className="font-bold text-lg flex items-center gap-2 flex-wrap">
                                                                                    {trip.driverName}
                                                                                    <span className="text-[9px] bg-purple-500/20 text-purple-400 px-1.5 py-0.5 rounded border border-purple-500/30 uppercase shrink-0">Extra</span>
                                                                                </div>
                                                                                <div className="text-sm opacity-60 italic max-w-[200px] truncate">
                                                                                    {trip.notes || 'Sem observa√ß√£o'}
                                                                                </div>
                                                                            </>
                                                                        ) : trip.isMadrugada ? (
                                                                            <>
                                                                                 <div className="font-bold text-lg flex items-center gap-2">
                                                                                    {trip.driverName}
                                                                                    <span className="text-[9px] bg-indigo-500/20 text-indigo-400 px-1.5 py-0.5 rounded border border-indigo-500/30 uppercase shrink-0">Madrugada</span>
                                                                                </div>
                                                                                <div className="text-sm opacity-60 flex items-center gap-2">
                                                                                    <span>{trip.pCount} passageiros</span>
                                                                                    <span>‚Ä¢</span>
                                                                                    <span>Vaga {trip.vaga}</span>
                                                                                </div>
                                                                            </>
                                                                        ) : (
                                                                            <>
                                                                                <div className="font-bold text-lg flex items-center gap-2">
                                                                                    {trip.driverName}
                                                                                    {trip.isTemp && <span className="text-[9px] bg-yellow-500/20 text-yellow-400 px-1.5 py-0.5 rounded border border-yellow-500/30 uppercase shrink-0">Temp</span>}
                                                                                </div>
                                                                                <div className="text-sm opacity-60 flex items-center gap-2">
                                                                                    <span>{trip.pCount} passageiros</span>
                                                                                    <span>‚Ä¢</span>
                                                                                    <span className="font-mono">#{trip.id}</span>
                                                                                </div>
                                                                            </>
                                                                        )}
                                                                    </div>
                                                                </div>

                                                                <div className="flex flex-wrap items-center justify-between w-full md:w-auto gap-3 md:gap-6 bg-black/20 p-3 md:p-0 md:bg-transparent rounded-lg">
                                                                    <div className="flex flex-col items-start md:items-end px-1 md:px-0">
                                                                        <div className="text-xs opacity-50 uppercase font-bold">Valor</div>
                                                                        <div className="text-xl font-bold text-yellow-400 whitespace-nowrap">R$ {trip.value},00</div>
                                                                    </div>

                                                                    <div className="flex gap-2 items-center ml-auto md:ml-0">
                                                                        <button 
                                                                            onClick={() => togglePaymentStatus(trip)}
                                                                            className={`px-3 py-2 rounded-lg font-bold text-xs flex items-center gap-2 border transition-all active:scale-95 ${trip.isPaid ? 'bg-green-500/10 border-green-500/20 text-green-400 hover:bg-green-500/20' : 'bg-red-500/10 border-red-500/20 text-red-400 hover:bg-red-500/20'}`}
                                                                        >
                                                                            {trip.isPaid ? <Icons.CheckCircle size={14}/> : <Icons.Clock size={14}/>}
                                                                            {trip.isPaid ? 'PAGO' : 'PENDENTE'}
                                                                        </button>
                                                                        <button 
                                                                            onClick={() => sendBillingMessage(trip)}
                                                                            className="px-3 py-2 rounded-lg bg-green-600 text-white font-bold hover:bg-green-500 transition-colors shadow-lg active:scale-95 flex-shrink-0"
                                                                            title="Cobrar no WhatsApp"
                                                                        >
                                                                            <Icons.Phone size={16}/>
                                                                        </button>
                                                                        
                                                                        {/* ATUALIZADO: Bot√£o de Excluir dispon√≠vel para TODOS os tipos de viagem na cobran√ßa */}
                                                                        <button 
                                                                            onClick={() => del('trips', trip.id)} 
                                                                            className="px-3 py-2 rounded-lg bg-red-500/20 text-red-400 hover:bg-red-500/30 transition-colors flex-shrink-0"
                                                                            title="Excluir Cobran√ßa/Viagem"
                                                                        >
                                                                            <Icons.Trash size={16}/>
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            );
                                        }) : (<div className="text-center py-10 opacity-30 text-sm border-2 border-dashed border-white/10 rounded-xl">Nenhuma viagem registrada em {billingDate.toLocaleDateString('pt-BR', {month:'long'})}.</div>)}
                                    </div>
                                </div>
                            )}

                        </div>
                    </div>

                    {modal && (
                        <div className="fixed inset-0 z-50 flex items-end md:items-center justify-center bg-black/80 backdrop-blur-sm p-0 md:p-4">
                            <div className={`${theme.card} w-full h-[95vh] md:h-auto md:max-h-[90vh] md:max-w-xl rounded-t-3xl md:rounded-2xl border ${theme.border} shadow-2xl flex flex-col page-transition`}>
                                <div className="h-16 border-b border-white/10 flex items-center justify-between px-6 shrink-0">
                                    {/* T√çTULO ATUALIZADO */}
                                    <h2 className="text-xl font-bold">
                                        {modal==='trip'?'Criar Viagem':
                                         modal==='passenger'?'Passageiro':
                                         modal==='driver'?'Motorista':
                                         modal==='lostFound'?'Perdido & Achado':
                                         modal==='reschedule'?'Reagendar':
                                         modal==='extraCharge'?'Carro Extra / Adicional': // Novo T√≠tulo
                                         modal==='madrugadaVaga'?'Vaga Madrugada':
                                         modal==='madrugadaBlock'?'Bloquear Vaga':''}
                                    </h2>
                                    <button onClick={()=>setModal(null)} className="opacity-50"><Icons.X size={24}/></button>
                                </div>
                                <div className="flex-1 scroll-y p-6 space-y-5 pb-10">
                                    {/* Campo de Data (Oculto no Reschedule) */}
                                    <div className={modal === 'reschedule' ? 'hidden' : ''}>
                                        <Input themeKey={themeKey} label="Data" type="date" value={formData.date || getTodayDate()} onChange={e=>setFormData({...formData, date:e.target.value})} />
                                    </div>
                                    
                                    {/* --- NOVO MODAL DE COBRAN√áA EXTRA --- */}
                                    {modal === 'extraCharge' && (
                                        <div className="space-y-6">
                                            <div className="p-4 bg-purple-500/10 border border-purple-500/20 rounded-xl text-sm text-purple-200">
                                                Aqui voc√™ cria lembretes para quando carros extras levarem passageiros voc√™ ter controle.
                                            </div>
                                            
                                            <Input 
                                                themeKey={themeKey} 
                                                label="WhatsApp (Opcional)" 
                                                placeholder="Ex: 13999999999" 
                                                value={formData.phone || ''} 
                                                onChange={e=>setFormData({...formData, phone:e.target.value})} 
                                            />
                                            
                                            <div className="grid grid-cols-2 gap-4">
                                                <Input 
                                                    themeKey={themeKey} 
                                                    label="Valor (R$)" 
                                                    type="number"
                                                    placeholder="0,00" 
                                                    value={formData.value || ''} 
                                                    onChange={e=>setFormData({...formData, value:e.target.value})} 
                                                />
                                                <Input 
                                                    themeKey={themeKey} 
                                                    label="Data" 
                                                    type="date"
                                                    value={formData.date} 
                                                    onChange={e=>setFormData({...formData, date:e.target.value})} 
                                                />
                                            </div>

                                            <div className="flex flex-col gap-1.5">
                                                <label className="text-xs font-bold opacity-60 ml-1">Observa√ß√£o</label>
                                                <textarea 
                                                    className="bg-black/10 border border-white/10 text-white rounded-xl px-4 py-3.5 w-full outline-none focus:border-current transition-colors h-24 resize-none" 
                                                    placeholder="Ex: Carro do Jo√£o, levou 3 pessoas do Forte..." 
                                                    value={formData.notes || ''} 
                                                    onChange={e=>setFormData({...formData, notes:e.target.value})} 
                                                />
                                            </div>

                                            <div className="pt-4">
                                                <Button themeKey={themeKey} onClick={saveExtraCharge} icon={Icons.Check} className="w-full">Salvar Cobran√ßa</Button>
                                            </div>
                                        </div>
                                    )}

                                    {modal === 'passenger' && (<><Input themeKey={themeKey} label="Nome" value={formData.name||''} onChange={e=>setFormData({...formData, name:e.target.value})} /><Input themeKey={themeKey} label="Telefone" type="tel" value={formData.phone||''} onChange={e=>setFormData({...formData, phone:e.target.value})} /><Input themeKey={themeKey} label="Endere√ßo" value={formData.address||''} onChange={e=>setFormData({...formData, address:e.target.value})} /><div className="flex flex-col gap-1.5"><label className="text-xs font-bold opacity-60 ml-1">Bairro</label><select className="bg-black/10 border border-white/10 text-white rounded-xl px-4 py-3.5 h-14" value={formData.neighborhood} onChange={e=>setFormData({...formData, neighborhood:e.target.value})}>{BAIRROS.map(b=><option key={b} value={b} className="bg-slate-900">{b}</option>)}</select></div><Input themeKey={themeKey} label="Refer√™ncia" value={formData.reference||''} onChange={e=>setFormData({...formData, reference:e.target.value})} /><div className="grid grid-cols-2 gap-4"><Input themeKey={themeKey} label="Hor√°rio (ex: 17:30)" type="time" value={formData.time||''} onChange={e=>setFormData({...formData, time:e.target.value})} /><Input themeKey={themeKey} label="Qtd Pax" type="number" value={formData.passengerCount||''} onChange={e=>setFormData({...formData, passengerCount:e.target.value})} /></div><Input themeKey={themeKey} label="Qtd Malas" type="number" value={formData.luggageCount||''} onChange={e=>setFormData({...formData, luggageCount:e.target.value})} /><div className="flex flex-col gap-1.5"><label className="text-xs font-bold opacity-60 ml-1">Etiquetas (Tags)</label><input className="bg-black/10 border border-white/10 text-white rounded-xl px-4 py-3.5 w-full outline-none focus:border-current transition-colors" placeholder="Ex: Crian√ßa, Pagamento Mensal..." value={formData.tags||''} onChange={e=>setFormData({...formData, tags:e.target.value})} /></div><div className="flex flex-col gap-1.5"><label className="text-xs font-bold opacity-60 ml-1">Pagamento</label><select className="bg-black/10 border border-white/10 text-white rounded-xl px-4 py-3.5 h-14" value={formData.payment} onChange={e=>setFormData({...formData, payment:e.target.value})}>{['Dinheiro','Pix','Cart√£o'].map(x=><option key={x} value={x} className="bg-slate-900">{x}</option>)}</select></div><div className="flex flex-col gap-1.5"><label className="text-xs font-bold opacity-60 ml-1">Status</label><select className="bg-black/10 border border-white/10 text-white rounded-xl px-4 py-3.5 h-14" value={formData.status} onChange={e=>setFormData({...formData, status:e.target.value})}>{['Ativo','Inativo'].map(x=><option key={x} value={x} className="bg-slate-900">{x}</option>)}</select></div><div className="pt-4"><Button themeKey={themeKey} onClick={()=>save('passengers')}>Salvar</Button></div></>)}
                                    {modal === 'driver' && (<><Input themeKey={themeKey} label="Nome" value={formData.name||''} onChange={e=>setFormData({...formData, name:e.target.value})} /><Input themeKey={themeKey} label="Telefone" type="tel" value={formData.phone||''} onChange={e=>setFormData({...formData, phone:e.target.value})} /><div className="grid grid-cols-2 gap-4"><Input themeKey={themeKey} label="Placa" value={formData.plate||''} onChange={e=>setFormData({...formData, plate:e.target.value})} /><Input themeKey={themeKey} label="Capacidade" type="number" value={formData.capacity||''} onChange={e=>setFormData({...formData, capacity:e.target.value})} /></div><div className="grid grid-cols-2 gap-4"><Input themeKey={themeKey} label="CNH" value={formData.cnh||''} onChange={e=>setFormData({...formData, cnh:e.target.value})} /><Input themeKey={themeKey} label="Validade CNH" type="date" value={formData.cnhValidity||''} onChange={e=>setFormData({...formData, cnhValidity:e.target.value})} /></div><div className="flex flex-col gap-1.5"><label className="text-xs font-bold opacity-60 ml-1">Status</label><select className="bg-black/10 border border-white/10 text-white rounded-xl px-4 py-3.5 h-14" value={formData.status} onChange={e=>setFormData({...formData, status:e.target.value})}>{['Ativo','Inativo'].map(x=><option key={x} value={x} className="bg-slate-900">{x}</option>)}</select></div><div className="pt-4"><Button themeKey={themeKey} onClick={()=>save('drivers')}>Salvar</Button></div></>)}
                                    
                                    {/* NOVO MODAL: REAGENDAR */}
                                    {modal === 'reschedule' && (
                                        <div className="space-y-6 anim-fade">
                                            <div className="p-4 bg-blue-500/10 border border-blue-500/20 rounded-xl text-sm text-blue-200 flex items-center gap-3">
                                                <Icons.Clock size={20} className="shrink-0"/>
                                                <div>
                                                    Defina o novo hor√°rio para <span className="font-bold text-white text-base block">{formData.name}</span>
                                                </div>
                                            </div>
                                            
                                            <div className="py-2">
                                                <Input 
                                                    theme={theme} 
                                                    label="Novo Hor√°rio" 
                                                    type="time" 
                                                    value={formData.time || ''} 
                                                    onChange={e => setFormData({...formData, time: e.target.value})} 
                                                    autoFocus
                                                />
                                            </div>

                                            <div className="pt-2 grid grid-cols-2 gap-3">
                                                <Button theme={theme} variant="secondary" onClick={()=>setModal(null)}>Cancelar</Button>
                                                <Button 
                                                    theme={theme} 
                                                    onClick={() => {
                                                        if(!formData.time) return alert("Por favor, defina um hor√°rio.");
                                                        dbOp('update', 'passengers', { id: formData.id, time: formData.time });
                                                        setModal(null);
                                                    }} 
                                                    icon={Icons.Check}
                                                >
                                                    Salvar
                                                </Button>
                                            </div>
                                        </div>
                                    )}

                                    {modal === 'madrugadaVaga' && (
                                        <div className="space-y-6">
                                            <div className="p-4 bg-yellow-500/10 border border-yellow-500/20 rounded-xl text-sm text-yellow-200">
                                                Digite o n√∫mero da vaga do motorista para adicionar √† tabela da Madrugada.
                                            </div>
                                            <Input 
                                                theme={theme} 
                                                label="N√∫mero da Vaga" 
                                                value={tempVagaMadrugada} 
                                                onChange={e => setTempVagaMadrugada(e.target.value)} 
                                                placeholder="Ex: 05"
                                                autoFocus
                                            />
                                            <div className="pt-4">
                                                <Button theme={theme} onClick={confirmAddMadrugadaVaga} icon={Icons.Check}>Confirmar Adi√ß√£o</Button>
                                            </div>
                                        </div>
                                    )}
                                    {modal === 'madrugadaBlock' && (
                                        <div className="space-y-6"><div className="p-4 bg-red-500/10 border border-red-500/20 rounded-xl text-sm text-red-200">Justifique o por que riscou a vaga <span className="font-bold font-mono">{vagaToBlock}</span> na Madrugada.</div><Input theme={theme} label="Motivo (Opcional)" value={tempJustification} onChange={e => setTempJustification(e.target.value)} placeholder="Ex: Quebrou, M√©dico, Folga..." autoFocus /><div className="pt-4 grid grid-cols-2 gap-3"><Button theme={theme} variant="secondary" onClick={()=>setModal(null)}>Cancelar</Button><Button theme={theme} onClick={confirmMadrugadaBlock} icon={Icons.Check} variant="danger">Bloquear</Button></div></div>
                                    )}

                                    {/* MODAL VIAGEM ATUALIZADO */}
                                    {modal === 'trip' && ( 
                                        <>
                                            {!suggestedTrip ? ( 
                                                <div className="space-y-6">
                                                    {/* CHECKBOX PARA VIAGEM MADRUGADA */}
                                                    <div 
                                                        className={`p-4 rounded-xl flex items-center gap-3 cursor-pointer transition-colors border ${formData.isMadrugada ? 'bg-indigo-500/20 border-indigo-500' : 'bg-white/5 border-white/10 hover:bg-white/10'}`}
                                                        onClick={() => setFormData(prev => ({...prev, isMadrugada: !prev.isMadrugada, driverId: ''}))}
                                                    >
                                                        <div className={`w-5 h-5 rounded border flex items-center justify-center transition-colors ${formData.isMadrugada ? 'bg-indigo-500 border-indigo-500' : 'border-white/30'}`}>
                                                            {formData.isMadrugada && <Icons.Check size={14} className="text-white"/>}
                                                        </div>
                                                        <div>
                                                            <div className={`font-bold text-sm ${formData.isMadrugada ? 'text-indigo-300' : 'text-white'}`}>Viagem da Madrugada</div>
                                                            <div className="text-xs opacity-50">Filtra motoristas da tabela de madrugada</div>
                                                        </div>
                                                    </div>

                                                    <div className="flex flex-col gap-1.5">
                                                        <label className="text-xs font-bold opacity-60 ml-1">Motorista</label>
                                                        <select 
                                                            className="bg-black/10 border border-white/10 text-white rounded-xl px-4 py-3.5 h-14" 
                                                            value={formData.driverId||''} 
                                                            onChange={e=>setFormData({...formData, driverId:e.target.value})}
                                                        >
                                                            <option value="" className="bg-slate-900">Selecione...</option>
                                                            {data.drivers
                                                                .filter(d => {
                                                                    // FILTRO DE MOTORISTAS DA MADRUGADA
                                                                    if (formData.isMadrugada) {
                                                                        // CORRE√á√ÉO: Compara√ß√£o insens√≠vel a mai√∫sculas/min√∫sculas
                                                                        const sp = spList.find(s => s.name.toLowerCase() === d.name.toLowerCase());
                                                                        return sp && madrugadaList.includes(sp.vaga);
                                                                    }
                                                                    return d.status==='Ativo';
                                                                })
                                                                .map(d => {
                                                                    let label = `${d.name} (${d.capacity} lug)`;
                                                                    if (formData.isMadrugada) {
                                                                        const sp = spList.find(s => s.name.toLowerCase() === d.name.toLowerCase());
                                                                        if (sp) label = `[Vaga ${sp.vaga}] ${label}`;
                                                                    }
                                                                    return <option key={d.id} value={d.id} className="bg-slate-900">{label}</option>;
                                                                })
                                                            }
                                                        </select>
                                                        {formData.isMadrugada && data.drivers.filter(d => { const sp = spList.find(s => s.name.toLowerCase() === d.name.toLowerCase()); return sp && madrugadaList.includes(sp.vaga); }).length === 0 && (
                                                            <p className="text-xs text-red-400 mt-1 pl-1">Nenhum motorista encontrado na escala da madrugada.</p>
                                                        )}
                                                    </div>
                                                    
                                                    {/* SELE√á√ÉO DE HOR√ÅRIO (Com sugest√µes para madrugada) */}
                                                    {formData.isMadrugada ? (
                                                        <div className="flex flex-col gap-1.5">
                                                            <label className="text-xs font-bold opacity-60 ml-1">Hor√°rio</label>
                                                            <select 
                                                                className="bg-black/10 border border-white/10 text-white rounded-xl px-4 py-3.5 h-14"
                                                                value={formData.time || ''}
                                                                onChange={e=>setFormData({...formData, time:e.target.value})}
                                                            >
                                                                <option value="" className="bg-slate-900">Selecione...</option>
                                                                <option value="04:00/04:45" className="bg-slate-900">04:00/45</option>
                                                                <option value="05:00/05:45" className="bg-slate-900">05:00/45</option>
                                                                <option value="06:00/06:45" className="bg-slate-900">06:00/45</option>
                                                            </select>
                                                        </div>
                                                    ) : (
                                                        <Input themeKey={themeKey} label="Hor√°rio (ex: 17:30)" type="time" value={formData.time||''} onChange={e=>setFormData({...formData, time:e.target.value})} />
                                                    )}

                                                    {!formData.isMadrugada && <div className="text-center font-bold opacity-80">{calculateTimeSlot(formatTime(formData.time||''))}</div>}
                                                    
                                                    <Button themeKey={themeKey} onClick={simulate} icon={Icons.Zap}>Gerar Rota</Button>
                                                </div> 
                                            ) : ( 
                                                <div className="flex flex-col h-full"><div className="bg-black/10 p-5 rounded-xl border border-white/10 flex-1 flex flex-col"><div className="flex flex-col gap-1 mb-4"><label className="text-xs font-bold opacity-60">Motorista</label><div className="bg-black/20 border border-white/10 text-white rounded-xl px-3 py-2 w-full font-bold opacity-70">{suggestedTrip.driver.name}</div></div><div className="flex justify-between items-center mb-4"><span className="font-bold text-lg">Resumo</span><span className={`text-sm px-3 py-1 rounded-full font-bold ${suggestedTrip.occupancy > suggestedTrip.driver.capacity ? 'bg-red-500/20 text-red-400' : 'bg-green-500/20 text-green-400'}`}>{suggestedTrip.occupancy} / {suggestedTrip.driver.capacity}</span></div><div className="flex gap-2 mb-4"><input className="bg-black/20 border border-white/10 rounded-xl px-4 flex-1 h-12" placeholder="ID Passageiro" value={searchId} onChange={e=>setSearchId(e.target.value)} /><button onClick={addById} className="bg-white/10 px-4 rounded-xl font-bold h-12">Add</button></div><button onClick={autoFill} className={`w-full mb-4 py-3 bg-white/5 border border-white/10 rounded-xl font-bold flex items-center justify-center gap-2 active:bg-white/10 anim-fade ${theme.accent}`}><Icons.Refresh size={20}/> ü§ñ Puxar Passageiros (Auto)</button><div className="space-y-3 overflow-y-auto flex-1 pr-1 scroll-y max-h-[35vh]">{suggestedTrip.passengers.map((p, i) => (<div key={p.id} className={`${theme.bg} p-3 rounded-xl border ${theme.border} flex justify-between items-center shadow-sm`}><div className="flex items-center gap-3"><div className={`w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold text-white ${theme.primary}`}>{i+1}</div><div><div className="text-base font-bold">{p.name}</div><div className="text-xs opacity-60">{p.neighborhood}</div></div></div><div className="flex items-center gap-3"><span className={`${theme.accent} font-bold text-base`}>{p.passengerCount}p</span><button onClick={()=>removePax(p.id)} className="text-red-400 p-2"><Icons.Trash size={20}/></button></div></div>))}</div></div><div className="grid grid-cols-2 gap-3 pt-4"><Button themeKey={themeKey} variant="secondary" onClick={()=>setSuggestedTrip(null)}>Voltar</Button><Button themeKey={themeKey} onClick={confirmTrip} variant="success">Confirmar</Button></div></div> 
                                            )}
                                        </> 
                                    )}
                                    {modal === 'lostFound' && ( <><Input themeKey={themeKey} label="O que foi encontrado?" value={formData.description||''} onChange={e=>setFormData({...formData, description:e.target.value})} placeholder="Ex: Guarda-chuva preto" /><Input themeKey={themeKey} label="Local / Ve√≠culo" value={formData.location||''} onChange={e=>setFormData({...formData, location:e.target.value})} placeholder="Ex: Van do Jo√£o" /><Input themeKey={themeKey} label="Detalhes Adicionais" value={formData.details||''} onChange={e=>setFormData({...formData, details:e.target.value})} placeholder="Ex: Banco de tr√°s, lado esquerdo" /><div className="flex flex-col gap-1.5"><label className="text-xs font-bold opacity-60 ml-1">Status</label><select className="bg-black/10 border border-white/10 text-white rounded-xl px-4 py-3.5 h-14" value={formData.status} onChange={e=>setFormData({...formData, status:e.target.value})}>{['Pendente','Entregue'].map(x=><option key={x} value={x} className="bg-slate-900">{x}</option>)}</select></div><div className="pt-4"><Button themeKey={themeKey} onClick={()=>save('lostFound')}>Salvar</Button></div></> )}
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {aiModal && ( <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/90 p-4"><div className={`w-full max-w-lg ${theme.card} p-6 rounded-2xl page-transition`}><h3 className="text-xl font-bold mb-2 flex items-center gap-2"><Icons.Stars/> Cadastro M√°gico</h3><p className="text-sm opacity-60 mb-4">Digite ou cole (ex: "Maria vai pro Boqueir√£o as 18h pagando Pix")</p><textarea className="w-full h-32 bg-black/20 p-4 rounded-xl border border-white/10 mb-4 text-base" value={aiInput} onChange={e=>setAiInput(e.target.value)} placeholder="Digite aqui..."></textarea><div className="flex justify-between items-center"><button onClick={toggleMic} className={`p-3 rounded-full ${isListening ? 'listening text-white' : 'bg-white/10 text-slate-400'}`}><Icons.Mic size={24}/></button><div className="flex gap-3"><Button themeKey={themeKey} variant="secondary" onClick={()=>setAiModal(false)}>Cancelar</Button><Button themeKey={themeKey} variant="primary" onClick={handleSmartCreate} disabled={aiLoading}>{aiLoading ? '...' : 'Criar'}</Button></div></div></div></div> )}
                    
                    {/* RENDERIZA√á√ÉO DO TOUR */}
                    {runTour && (
                        /* CORRE√á√ÉO: Adicionada classe 'clear' se n√£o for o primeiro passo */
                        <div className={`tour-overlay ${tourStep > 0 ? 'clear' : ''}`}>
                            <TourGuide 
                                steps={TOUR_STEPS} 
                                currentStep={tourStep} 
                                onNext={handleNextStep} 
                                onPrev={handlePrevStep} 
                                onClose={handleCloseTour}
                                theme={theme}
                            />
                        </div>
                    )}

                    {renderContextMenu()}
                </div>
            );
        }
        const root = ReactDOM.createRoot(document.getElementById('root')); root.render(<App />);
    </script>
</body>
</html>
